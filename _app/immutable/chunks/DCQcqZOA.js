import{b as ie,h as S,l as se,x as D,az as oe,n as le,o as ce,q,d as Y,s as L,e as C,C as ue,at as fe,af as de,f as P,j as x,c as G,k as ge,w as he,a5 as J,ar as j,aM as B,aN as ve,r as W,p as pe,aO as _e,aP as me,aQ as U,a as ye,aR as Se,aS as be,aq as Ee,i as Ie,a8 as we,aT as Ae,aU as Ne,aV as Pe,aW as Te,aX as Oe,aY as Ce,aK as Le,D as Ue,a6 as Me,aZ as $e}from"./Cg5NIOCX.js";import{w as ke}from"./Db6ANrXm.js";function Qe(n,e){return e}function xe(n,e,r){for(var t=[],i=e.length,s=0;s<i;s++)Se(e[s].e,t,!0);be(t,()=>{var o=t.length===0&&r!==null;if(o){var a=r,u=a.parentNode;Ee(u),u.append(a),n.items.clear(),p(n,e[0].prev,e[i-1].next)}for(var l=0;l<i;l++){var f=e[l];o||(n.items.delete(f.k),p(n,f.prev,f.next)),Ie(f.e,!o)}n.first===e[0]&&(n.first=e[0].prev)})}function Ze(n,e,r,t,i,s=null){var o=n,a=new Map,u=null;S&&se();var l=null,f=oe(()=>{var v=r();return B(v)?v:v==null?[]:j(v)}),d,h=!0;function _(){Fe(g,d,o,e,t),l!==null&&(d.length===0?(l.fragment?(o.before(l.fragment),l.fragment=null):W(l.effect),c.first=l.effect):pe(l.effect,()=>{l=null}))}var c=ie(()=>{d=D(f);var v=d.length;let E=!1;if(S){var m=le(o)===ce;m!==(v===0)&&(o=q(),Y(o),L(!1),E=!0)}for(var T=new Set,I=P,A=null,N=ge(),b=0;b<v;b+=1){S&&C.nodeType===ue&&C.data===fe&&(o=C,E=!0,L(!1));var O=d[b],w=t(O,b),y=h?null:a.get(w);y?(de(y.v,O),y.i=b,N&&I.skipped_effects.delete(y.e)):(y=He(h?o:null,A,O,w,b,i,e,r),h&&(y.o=!0,A===null?u=y:A.next=y,A=y),a.set(w,y)),T.add(w)}if(v===0&&s&&!l)if(h)l={fragment:null,effect:x(()=>s(o))};else{var H=document.createDocumentFragment(),R=G();H.append(R),l={fragment:H,effect:x(()=>s(R))}}if(S&&v>0&&Y(q()),!h)if(N){for(const[te,ae]of a)T.has(te)||I.skipped_effects.add(ae.e);I.oncommit(_),I.ondiscard(()=>{})}else _();E&&L(!0),D(f)}),g={effect:c,items:a,first:u};h=!1,S&&(o=C)}function Fe(n,e,r,t,i){var s=e.length,o=n.items,a=n.first,u,l=null,f=[],d=[],h,_,c,g;for(g=0;g<s;g+=1){if(h=e[g],_=i(h,g),c=o.get(_),n.first??=c,!c.o){c.o=!0;var v=l?l.next:a;p(n,l,c),p(n,c,v),M(c,v,r),l=c,f=[],d=[],a=l.next;continue}if((c.e.f&U)!==0&&W(c.e),c!==a){if(u!==void 0&&u.has(c)){if(f.length<d.length){var E=d[0],m;l=E.prev;var T=f[0],I=f[f.length-1];for(m=0;m<f.length;m+=1)M(f[m],E,r);for(m=0;m<d.length;m+=1)u.delete(d[m]);p(n,T.prev,I.next),p(n,l,T),p(n,I,E),a=E,l=I,g-=1,f=[],d=[]}else u.delete(c),M(c,a,r),p(n,c.prev,c.next),p(n,c,l===null?n.first:l.next),p(n,l,c),l=c;continue}for(f=[],d=[];a!==null&&a.k!==_;)(a.e.f&U)===0&&(u??=new Set).add(a),d.push(a),a=a.next;if(a===null)continue;c=a}f.push(c),l=c,a=c.next}let A=o.size>s;if(a!==null||u!==void 0){for(var N=u===void 0?[]:j(u);a!==null;)(a.e.f&U)===0&&N.push(a),a=a.next;var b=N.length;if(A=o.size-b>s,b>0){var O=null;xe(n,N,O)}}if(A)for(const w of o.values())w.o||(p(n,l,w),l=w);n.effect.last=l&&l.e}function He(n,e,r,t,i,s,o,a){var u=(o&_e)!==0,l=(o&me)===0,f=u?l?he(r,!1,!1):J(r):r,d=(o&ve)===0?i:J(i),h={i:d,v:f,k:t,a:null,e:null,o:!1,prev:e,next:null};try{if(n===null){var _=document.createDocumentFragment();_.append(n=G())}return h.e=x(()=>s(n,f,d,a)),e!==null&&(e.next=h),h}finally{}}function M(n,e,r){for(var t=n.next?n.next.e.nodes_start:r,i=e?e.e.nodes_start:r,s=n.e.nodes_start;s!==null&&s!==t;){var o=ye(s);i.before(s),s=o}}function p(n,e,r){e===null?(n.first=r,n.effect.first=r&&r.e):(e.e.next&&(e.e.next.prev=null),e.next=r,e.e.next=r&&r.e),r!==null&&(r.e.prev&&(r.e.prev.next=null),r.prev=e,r.e.prev=e&&e.e)}const V=[...` 	
\r\fÂ \v\uFEFF`];function Re(n,e,r){var t=n==null?"":""+n;if(r){for(var i in r)if(r[i])t=t?t+" "+i:i;else if(t.length)for(var s=i.length,o=0;(o=t.indexOf(i,o))>=0;){var a=o+s;(o===0||V.includes(t[o-1]))&&(a===t.length||V.includes(t[a]))?t=(o===0?"":t.substring(0,o))+t.substring(a+1):o=a}}return t===""?null:t}function en(n,e,r,t,i,s){var o=n.__className;if(S||o!==r||o===void 0){var a=Re(r,t,s);(!S||a!==n.getAttribute("class"))&&(a==null?n.removeAttribute("class"):n.className=a),n.__className=r}else if(s&&i!==s)for(var u in s){var l=!!s[u];(i==null||l!==!!i[u])&&n.classList.toggle(u,l)}return s}const De=Symbol("is custom element"),qe=Symbol("is html");function nn(n){if(S){var e=!1,r=()=>{if(!e){if(e=!0,n.hasAttribute("value")){var t=n.value;K(n,"value",null),n.value=t}if(n.hasAttribute("checked")){var i=n.checked;K(n,"checked",null),n.checked=i}}};n.__on_r=r,we(r),Ae()}}function K(n,e,r,t){var i=Ye(n);S&&(i[e]=n.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&n.nodeName==="LINK")||i[e]!==(i[e]=r)&&(e==="loading"&&(n[Ne]=r),r==null?n.removeAttribute(e):typeof r!="string"&&Je(n).includes(e)?n[e]=r:n.setAttribute(e,r))}function Ye(n){return n.__attributes??={[De]:n.nodeName.includes("-"),[qe]:n.namespaceURI===Pe}}var z=new Map;function Je(n){var e=n.getAttribute("is")||n.nodeName,r=z.get(e);if(r)return r;z.set(e,r=[]);for(var t,i=n,s=Element.prototype;s!==i;){t=Oe(i);for(var o in t)t[o].set&&r.push(o);i=Te(i)}return r}function rn(n,e,r=e){var t=new WeakSet;Ce(n,"input",async i=>{var s=i?n.defaultValue:n.value;if(s=$(n)?k(s):s,r(s),P!==null&&t.add(P),await Le(),s!==(s=e())){var o=n.selectionStart,a=n.selectionEnd,u=n.value.length;if(n.value=s??"",a!==null){var l=n.value.length;o===a&&a===u&&l>u?(n.selectionStart=l,n.selectionEnd=l):(n.selectionStart=o,n.selectionEnd=Math.min(a,l))}}}),(S&&n.defaultValue!==n.value||Ue(e)==null&&n.value)&&(r($(n)?k(n.value):n.value),P!==null&&t.add(P)),Me(()=>{var i=e();if(n===document.activeElement){var s=$e??P;if(t.has(s))return}$(n)&&i===k(n.value)||n.type==="date"&&!i&&!n.value||i!==n.value&&(n.value=i??"")})}function $(n){var e=n.type;return e==="number"||e==="range"}function k(n){return n===""?null:+n}function tn(n){return function(...e){var r=e[0];return r.stopPropagation(),n?.apply(this,e)}}function an(n,e){var r=n.$$events?.[e.type],t=B(r)?r.slice():r==null?[]:[r];for(var i of t)i.call(this,e)}const sn=globalThis.__sveltekit_ffxqxd.env;async function Ve(n){let e;try{const r=await fetch(n);if(!r.ok)throw new Error(`HTTP ${r.status}`);e=await r.text()}catch(r){throw new Error(`Failed to fetch plugin: ${r.message}`)}return new Promise((r,t)=>{const i=Math.random().toString(36).substring(7),s=document.createElement("iframe");s.style.display="none",s.setAttribute("sandbox","allow-scripts");let o;const a=()=>{o&&clearTimeout(o),window.removeEventListener("message",u),document.body.contains(s)&&document.body.removeChild(s)},u=_=>{const c=_.data;if(!c||c.type!=="furnarchy-plugin-register"||c.requestId!==i)return;const g=c.plugin;if(!g.id||!g.name||!g.version){a(),t(new Error("Plugin registered but missing id, name, or version"));return}r({id:g.id,name:g.name,description:g.description,version:g.version,author:g.author,sourceUrl:n,toggle:g.toggle}),a()};window.addEventListener("message",u);const l=`
            window.Furnarchy = {
                version: '0.0.0-sandbox',
                loadingPluginUrl: ${JSON.stringify(n)},
                register: function(meta, arg) {
                    if (typeof arg === 'function') {
                        // Send metadata immediately
                        window.parent.postMessage({
                            type: 'furnarchy-plugin-register',
                            requestId: '${i}',
                            plugin: meta
                        }, '*');

                        const api = {
                            send: function() {},
                            inject: function() {},
                            notify: function() {},
                            disable: function() {},
                            onIncoming: function() {},
                            onOutgoing: function() {},
                            onLoggedIn: function() {},
                            onPause: function() {},
                            onLoad: function() {}
                        };
                        try { arg(api); } catch(e) {}
                    }
                },
                onRegister: function() {},
                send: function() {}
            };
        `,d=`
            try {
                const content = decodeURIComponent(escape(atob('${btoa(unescape(encodeURIComponent(e)))}')));
                const script = document.createElement('script');
                script.textContent = content;
                document.body.appendChild(script);
            } catch(e) {
                console.error('Sandbox execution error:', e);
            }
        `,h=`
            <!DOCTYPE html>
            <html>
            <head>
                <script>${l}<\/script>
            </head>
            <body>
                <script>${d}<\/script>
            </body>
            </html>
        `;s.srcdoc=h,document.body.appendChild(s),o=setTimeout(()=>{a(),t(new Error("Plugin load timed out (5s) - did not call Furnarchy.register()?"))},5e3)})}const F="furnarchy_plugins",X="furnarchy_deleted_plugins",Q="furnarchy_auth_url",Z="furnarchy_version",ee=ke([]);function ne(){if(typeof localStorage>"u")return[];const n=localStorage.getItem(X);if(!n)return[];try{return JSON.parse(n)}catch{return[]}}function on(n){if(typeof localStorage>"u")return;const e=ne();e.includes(n)||(e.push(n),localStorage.setItem(X,JSON.stringify(e)))}function Ke(){if(typeof localStorage>"u")return[];const n=localStorage.getItem(F);if(!n)return[];try{const e=JSON.parse(n);return Array.isArray(e)?e.map(r=>typeof r=="string"?{url:r}:r):[]}catch(e){return console.error("Failed to load plugins",e),[]}}function ze(n){typeof localStorage>"u"||(localStorage.setItem(F,JSON.stringify(n)),ee.set(n))}function ln(n,e){ee.update(r=>{const t=r.findIndex(a=>a.url===n);if(t===-1)return r;const i=r[t],s={...i,...e};if(JSON.stringify(i)===JSON.stringify(s))return r;const o=[...r];return o[t]=s,typeof localStorage<"u"&&localStorage.setItem(F,JSON.stringify(o)),o})}function cn(){return typeof localStorage>"u"?null:localStorage.getItem(Q)}function un(n){typeof localStorage>"u"||localStorage.setItem(Q,n)}function Ge(){return typeof localStorage>"u"?null:localStorage.getItem(Z)}function je(n){typeof localStorage>"u"||localStorage.setItem(Z,n)}async function fn(n){if(typeof localStorage>"u")return;const e=Ge();let r=Ke();const t=["/plugins/auto-spinner.js","/plugins/wire-shrek.js"],i=ne();let s=!1;for(const o of t)if(!r.some(a=>a.url===o))try{const a=await Ve(o);if(i.includes(a.id)){console.log(`Skipping deleted default plugin: ${a.name} (${a.id})`);continue}r.push({id:a.id,url:o,name:a.name,description:a.description,version:a.version,author:a.author,enabled:typeof a.toggle=="boolean"?!a.toggle:!0}),s=!0}catch(a){console.error(`Failed to load default plugin ${o}:`,a)}s&&ze(r),e!==n&&je(n)}const re={escape:n=>n.replace(/[&<>"']|[\u0080-\uFFFF]/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return"&#"+e.charCodeAt(0)+";"}})};class Be{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};_enabledState=!0;get enabled(){return this._enabledState}_handlers={incoming:[],outgoing:[],loggedIn:[],pause:[],load:[],configure:[]};send(e,r){this.enabled&&this.core.send(e,r,this.metadata.id)}inject(e,r){this.enabled&&this.core.inject(e,r,this.metadata.id)}disable(){this.enabled&&(this._setEnabled(!1),this.core.notifyUpdate(this))}notify(e,r){this.inject(`(${re.escape("[ðŸŸ¢]")} ${e}
`,r)}onIncoming(e,r=0){this._handlers.incoming.push({cb:e,priority:r}),this.core.invalidateHandlers()}onOutgoing(e,r=0){this._handlers.outgoing.push({cb:e,priority:r}),this.core.invalidateHandlers()}onLoggedIn(e){this._handlers.loggedIn.push(e)}onPause(e){this._handlers.pause.push(e)}onLoad(e){this._handlers.load.push(e)}onConfigure(e){this._handlers.configure.push(e)}_setEnabled(e){this._enabledState!==e&&(this._enabledState=e,this.core.invalidateHandlers(),this._handlers.pause.forEach(r=>{try{r(!e)}catch(t){console.error(t)}}))}_notifyLoggedIn(){this.enabled&&this._handlers.loggedIn.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] LoggedIn Error:`,r)}})}_notifyLoad(){this._handlers.load.forEach(e=>{try{e(this.enabled)}catch(r){console.error(`[${this.metadata.name}] Load Error:`,r)}})}_notifyConfigure(){this._handlers.configure.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] Configure Error:`,r)}})}}class dn{version="0.4.0";plugins=[];utils=re;loadingPluginUrl=null;listeners=[];_cachedIncoming=null;_cachedOutgoing=null;invalidateHandlers(){this._cachedIncoming=null,this._cachedOutgoing=null}send(e,r,t){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,r,t){console.warn("[Furnarchy] inject() called before connection established",e)}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(r=>{try{r(e)}catch(t){console.error(t)}})}register(e,r){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(i=>i.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const t=new Be(this);t.metadata={...t.metadata,...e},e.toggle&&t._setEnabled(!1),this.plugins.push(t);try{r(t),console.log(`[Furnarchy] Registered plugin: ${t.metadata.name} (${t.metadata.id})`)}catch(i){console.error("[Furnarchy] Error initializing plugin:",i)}this.notifyUpdate(t),t._notifyLoad()}_getSortedHandlers(e){if(e==="incoming"&&this._cachedIncoming)return this._cachedIncoming;if(e==="outgoing"&&this._cachedOutgoing)return this._cachedOutgoing;const r=[];for(const t of this.plugins){if(!t.enabled)continue;const i=e==="incoming"?t._handlers.incoming:t._handlers.outgoing;for(const s of i)r.push({...s,plugin:t})}return r.sort((t,i)=>i.priority-t.priority),e==="incoming"?this._cachedIncoming=r:this._cachedOutgoing=r,r}async _processMessage(e,r,t,i){let s=r;const o=this._getSortedHandlers(e);for(const{cb:a,plugin:u}of o)try{const l=await a(s,i,t);if(l==null)return null;s=l}catch(l){const f=e.charAt(0).toUpperCase()+e.slice(1);console.error(`[${u.metadata.name}] ${f} Error:`,l)}return s}async processIncoming(e,r=null,t=null){return this._processMessage("incoming",e,r,t)}async processOutgoing(e,r=null,t=null){return this._processMessage("outgoing",e,r,t)}notifyLoggedIn(){console.log("[Furnarchy] User logged in, notifying plugins..."),this.plugins.forEach(e=>e._notifyLoggedIn())}}export{dn as F,cn as a,rn as b,sn as c,K as d,Ze as e,tn as f,Ke as g,ze as h,Qe as i,un as j,an as k,fn as l,on as m,ee as p,nn as r,en as s,ln as u,Ve as v};
