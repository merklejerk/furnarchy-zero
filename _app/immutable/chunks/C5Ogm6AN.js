import{A as I,G as E,Z as b,C as d,_ as F,a0 as S,a1 as h,N as g,M as f,D as $,a2 as O,U as C}from"./B2BHS6mp.js";function P(a,e){let n=null,t=d;var r;if(d){n=$;for(var i=F(document.head);i!==null&&(i.nodeType!==S||i.data!==a);)i=h(i);if(i===null)g(!1);else{var s=h(i);i.remove(),f(s)}}d||(r=document.head.appendChild(I()));try{E(()=>e(r),b)}finally{t&&(g(!0),f(n))}}const p=[...` 	
\r\fÂ \v\uFEFF`];function x(a,e,n){var t=a==null?"":""+a;if(n){for(var r in n)if(n[r])t=t?t+" "+r:r;else if(t.length)for(var i=r.length,s=0;(s=t.indexOf(r,s))>=0;){var o=s+i;(s===0||p.includes(t[s-1]))&&(o===t.length||p.includes(t[o]))?t=(s===0?"":t.substring(0,s))+t.substring(o+1):s=o}}return t===""?null:t}function m(a,e=!1){var n=e?" !important;":";",t="";for(var r in a){var i=a[r];i!=null&&i!==""&&(t+=" "+r+": "+i+n)}return t}function H(a,e){if(e){var n="",t,r;return Array.isArray(e)?(t=e[0],r=e[1]):t=e,t&&(n+=m(t)),r&&(n+=m(r,!0)),n=n.trim(),n===""?null:n}return String(a)}const c={isOpen:!1,title:"",body:"",onClose:void 0},u=O(c);function L(a){u.update(e=>({...c,...a,isOpen:!0}))}function M(){u.update(a=>{if(a.isOpen&&a.onClose)try{a.onClose()}catch(e){console.error("Error in modal onClose handler:",e)}return{...c}})}const y={escape:a=>a.replace(/[&<>"']|[\u0080-\uFFFF]/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return"&#"+e.charCodeAt(0)+";"}})};class w{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};_enabledState=!0;get enabled(){return this._enabledState}_handlers={incoming:[],outgoing:[],loggedIn:[],ready:[],pause:[],load:[],configure:[]};_readyFired=!1;send(e,n){this.enabled&&this.core.send(e,this.metadata.id,n)}inject(e,n){this.enabled&&this.core.inject(e,this.metadata.id,n)}disable(){this.enabled&&(this._setEnabled(!1),this.core.notifyUpdate(this))}notify(e,n){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}this.inject(`(${y.escape("[ðŸŸ¢]")} ${e}
`,n)}onIncoming(e,n=0){this._handlers.incoming.push({cb:e,priority:n}),this.core.invalidateHandlers()}onOutgoing(e,n=0){this._handlers.outgoing.push({cb:e,priority:n}),this.core.invalidateHandlers()}onLoggedIn(e){this._handlers.loggedIn.push(e)}onReady(e){if(this._handlers.ready.push(e),this._readyFired)try{e()}catch(n){console.error(`[${this.metadata.name}] Ready Error (Late):`,n)}}onPause(e){this._handlers.pause.push(e)}onLoad(e){this._handlers.load.push(e)}onConfigure(e){this._handlers.configure.push(e)}openModal(e){L(e)}closeModal(){M()}isModalOpen(){return C(u).isOpen}setGameInput(e){this.core.setGameInput(e)}saveData(e,n){if(typeof localStorage>"u")return;const t=`furnarchy_plugin_${this.metadata.id}_${e}`;try{localStorage.setItem(t,JSON.stringify(n))}catch(r){console.error(`[${this.metadata.name}] Failed to save data:`,r)}}loadData(e){if(typeof localStorage>"u")return null;const n=`furnarchy_plugin_${this.metadata.id}_${e}`;try{const t=localStorage.getItem(n);return t?JSON.parse(t):null}catch(t){return console.error(`[${this.metadata.name}] Failed to load data:`,t),null}}expose(e){this.core.registerService(e,this.metadata.id)}use(e){return this.core.getService(e)}_setEnabled(e){this._enabledState!==e&&(this._enabledState=e,this.core.invalidateHandlers(),this._handlers.pause.forEach(n=>{try{n(!e)}catch(t){console.error(t)}}))}_notifyLoggedIn(){this.enabled&&this._handlers.loggedIn.forEach(e=>{try{e()}catch(n){console.error(`[${this.metadata.name}] LoggedIn Error:`,n)}})}_notifyReady(){this._readyFired||(this._readyFired=!0,this._handlers.ready.forEach(e=>{try{e()}catch(n){console.error(`[${this.metadata.name}] Ready Error:`,n)}}))}_notifyLoad(){this._handlers.load.forEach(e=>{try{e(this.enabled)}catch(n){console.error(`[${this.metadata.name}] Load Error:`,n)}})}_notifyConfigure(){this._handlers.configure.forEach(e=>{try{e()}catch(n){console.error(`[${this.metadata.name}] Configure Error:`,n)}})}}class R{version="0.6.0";plugins=[];services=new Map;utils=y;loadingPluginUrl=null;isLoggedIn=!1;isReady=!1;listeners=[];gameInputEnabled=!0;_cachedIncoming=null;_cachedOutgoing=null;constructor(){this.setupInputInterception()}setupInputInterception(){if(typeof document>"u")return;const e=n=>{this.gameInputEnabled||n.stopImmediatePropagation()};document.addEventListener("keydown",e),document.addEventListener("keyup",e),document.addEventListener("keypress",e)}setGameInput(e){this.gameInputEnabled=e}invalidateHandlers(){this._cachedIncoming=null,this._cachedOutgoing=null}start(){this.isReady||(this.isReady=!0,console.log("[Furnarchy] Starting plugins..."),this.plugins.forEach(e=>e._notifyReady()))}send(e,n,t){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,n,t){console.warn("[Furnarchy] inject() called before connection established",e)}registerService(e,n){if(!e.name||!e.version){console.error("[Furnarchy] Service registration failed: Missing 'name' or 'version'",e);return}this.services.has(e.name)&&console.warn(`[Furnarchy] Service '${e.name}' is already registered. Overwriting.`),this.services.set(e.name,{service:e,providerId:n}),console.log(`[Furnarchy] Service registered: ${e.name} v${e.version} by ${n}`)}getService(e){const n=this.services.get(e);return n?n.service:null}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(n=>{try{n(e)}catch(t){console.error(t)}})}register(e,n){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(r=>r.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const t=new w(this);t.metadata={...t.metadata,...e},e.toggle&&t._setEnabled(!1),this.plugins.push(t);try{n(t),console.log(`[Furnarchy] Registered plugin: ${t.metadata.name} (${t.metadata.id})`)}catch(r){console.error("[Furnarchy] Error initializing plugin:",r)}this.notifyUpdate(t),t._notifyLoad(),this.isReady&&t._notifyReady()}_getSortedHandlers(e){if(e==="incoming"&&this._cachedIncoming)return this._cachedIncoming;if(e==="outgoing"&&this._cachedOutgoing)return this._cachedOutgoing;const n=[];for(const t of this.plugins){if(!t.enabled)continue;const r=e==="incoming"?t._handlers.incoming:t._handlers.outgoing;for(const i of r)n.push({...i,plugin:t})}return n.sort((t,r)=>r.priority-t.priority),e==="incoming"?this._cachedIncoming=n:this._cachedOutgoing=n,n}async _processMessage(e,n,t,r){let i=n;const s=this._getSortedHandlers(e);for(const{cb:o,plugin:_}of s)try{const l=await o(i,t,r);if(l==null)return null;i=l}catch(l){const v=e.charAt(0).toUpperCase()+e.slice(1);console.error(`[${_.metadata.name}] ${v} Error:`,l)}return i}async processIncoming(e,n=null,t=null){return this._processMessage("incoming",e,n,t)}async processOutgoing(e,n=null,t=null){return this._processMessage("outgoing",e,n,t)}notifyLoggedIn(){this.isLoggedIn=!0,console.log("[Furnarchy] User logged in, notifying plugins..."),this.plugins.forEach(e=>e._notifyLoggedIn())}getExposedAPI(){return{register:this.register.bind(this),version:this.version,utils:this.utils}}}const A=new R;export{R as F,x as a,M as c,A as f,P as h,u as m,H as t};
