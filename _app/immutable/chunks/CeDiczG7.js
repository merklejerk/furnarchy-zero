import{b as ne,h as b,l as re,x as D,ay as te,n as ae,o as se,q as H,d as q,s as C,e as P,C as oe,ar as ie,ad as le,f as A,j as R,c as K,k as ce,w as ue,a3 as V,ap as j,aM as z,aN as fe,r as B,p as de,aO as ge,aP as he,aQ as L,a as ve,aR as me,aS as pe,ao as _e,i as ye,a6 as be,aT as Ee,aU as Ie,aV as Se,aW as we,aX as Ne,aY as Te,aJ as Ae,D as Ue,a4 as Me,aZ as Pe}from"./Do66v2T9.js";import{w as Ce}from"./DxZxUW1L.js";function We(e,n){return n}function Le(e,n,r){for(var t=[],s=n.length,a=0;a<s;a++)me(n[a].e,t,!0);pe(t,()=>{var o=t.length===0&&r!==null;if(o){var i=r,u=i.parentNode;_e(u),u.append(i),e.items.clear(),m(e,n[0].prev,n[s-1].next)}for(var l=0;l<s;l++){var f=n[l];o||(e.items.delete(f.k),m(e,f.prev,f.next)),ye(f.e,!o)}e.first===n[0]&&(e.first=n[0].prev)})}function Xe(e,n,r,t,s,a=null){var o=e,i=new Map,u=null;b&&re();var l=null,f=te(()=>{var v=r();return z(v)?v:v==null?[]:j(v)}),d,g=!0;function p(){Oe(h,d,o,n,t),l!==null&&(d.length===0?(l.fragment?(o.before(l.fragment),l.fragment=null):B(l.effect),c.first=l.effect):de(l.effect,()=>{l=null}))}var c=ne(()=>{d=D(f);var v=d.length;let I=!1;if(b){var _=ae(o)===se;_!==(v===0)&&(o=H(),q(o),C(!1),I=!0)}for(var U=new Set,S=A,N=null,T=ce(),E=0;E<v;E+=1){b&&P.nodeType===oe&&P.data===ie&&(o=P,I=!0,C(!1));var M=d[E],w=t(M,E),y=g?null:i.get(w);y?(le(y.v,M),y.i=E,T&&S.skipped_effects.delete(y.e)):(y=ke(g?o:null,N,M,w,E,s,n,r),g&&(y.o=!0,N===null?u=y:N.next=y,N=y),i.set(w,y)),U.add(w)}if(v===0&&a&&!l)if(g)l={fragment:null,effect:R(()=>a(o))};else{var F=document.createDocumentFragment(),$=K();F.append($),l={fragment:F,effect:R(()=>a($))}}if(b&&v>0&&q(H()),!g)if(T){for(const[Z,ee]of i)U.has(Z)||S.skipped_effects.add(ee.e);S.oncommit(p),S.ondiscard(()=>{})}else p();I&&C(!0),D(f)}),h={effect:c,items:i,first:u};g=!1,b&&(o=P)}function Oe(e,n,r,t,s){var a=n.length,o=e.items,i=e.first,u,l=null,f=[],d=[],g,p,c,h;for(h=0;h<a;h+=1){if(g=n[h],p=s(g,h),c=o.get(p),e.first??=c,!c.o){c.o=!0;var v=l?l.next:i;m(e,l,c),m(e,c,v),O(c,v,r),l=c,f=[],d=[],i=l.next;continue}if((c.e.f&L)!==0&&B(c.e),c!==i){if(u!==void 0&&u.has(c)){if(f.length<d.length){var I=d[0],_;l=I.prev;var U=f[0],S=f[f.length-1];for(_=0;_<f.length;_+=1)O(f[_],I,r);for(_=0;_<d.length;_+=1)u.delete(d[_]);m(e,U.prev,S.next),m(e,l,U),m(e,S,I),i=I,l=S,h-=1,f=[],d=[]}else u.delete(c),O(c,i,r),m(e,c.prev,c.next),m(e,c,l===null?e.first:l.next),m(e,l,c),l=c;continue}for(f=[],d=[];i!==null&&i.k!==p;)(i.e.f&L)===0&&(u??=new Set).add(i),d.push(i),i=i.next;if(i===null)continue;c=i}f.push(c),l=c,i=c.next}let N=o.size>a;if(i!==null||u!==void 0){for(var T=u===void 0?[]:j(u);i!==null;)(i.e.f&L)===0&&T.push(i),i=i.next;var E=T.length;if(N=o.size-E>a,E>0){var M=null;Le(e,T,M)}}if(N)for(const w of o.values())w.o||(m(e,l,w),l=w);e.effect.last=l&&l.e}function ke(e,n,r,t,s,a,o,i){var u=(o&ge)!==0,l=(o&he)===0,f=u?l?ue(r,!1,!1):V(r):r,d=(o&fe)===0?s:V(s),g={i:d,v:f,k:t,a:null,e:null,o:!1,prev:n,next:null};try{if(e===null){var p=document.createDocumentFragment();p.append(e=K())}return g.e=R(()=>a(e,f,d,i)),n!==null&&(n.next=g),g}finally{}}function O(e,n,r){for(var t=e.next?e.next.e.nodes_start:r,s=n?n.e.nodes_start:r,a=e.e.nodes_start;a!==null&&a!==t;){var o=ve(a);s.before(a),a=o}}function m(e,n,r){n===null?(e.first=r,e.effect.first=r&&r.e):(n.e.next&&(n.e.next.prev=null),n.next=r,n.e.next=r&&r.e),r!==null&&(r.e.prev&&(r.e.prev.next=null),r.prev=n,r.e.prev=n&&n.e)}const Y=[...` 	
\r\fÂ \v\uFEFF`];function xe(e,n,r){var t=e==null?"":""+e;if(r){for(var s in r)if(r[s])t=t?t+" "+s:s;else if(t.length)for(var a=s.length,o=0;(o=t.indexOf(s,o))>=0;){var i=o+a;(o===0||Y.includes(t[o-1]))&&(i===t.length||Y.includes(t[i]))?t=(o===0?"":t.substring(0,o))+t.substring(i+1):o=i}}return t===""?null:t}function Qe(e,n,r,t,s,a){var o=e.__className;if(b||o!==r||o===void 0){var i=xe(r,t,a);(!b||i!==e.getAttribute("class"))&&(i==null?e.removeAttribute("class"):e.className=i),e.__className=r}else if(a&&s!==a)for(var u in a){var l=!!a[u];(s==null||l!==!!s[u])&&e.classList.toggle(u,l)}return a}const Re=Symbol("is custom element"),Fe=Symbol("is html");function Ze(e){if(b){var n=!1,r=()=>{if(!n){if(n=!0,e.hasAttribute("value")){var t=e.value;G(e,"value",null),e.value=t}if(e.hasAttribute("checked")){var s=e.checked;G(e,"checked",null),e.checked=s}}};e.__on_r=r,be(r),Ee()}}function G(e,n,r,t){var s=$e(e);b&&(s[n]=e.getAttribute(n),n==="src"||n==="srcset"||n==="href"&&e.nodeName==="LINK")||s[n]!==(s[n]=r)&&(n==="loading"&&(e[Ie]=r),r==null?e.removeAttribute(n):typeof r!="string"&&De(e).includes(n)?e[n]=r:e.setAttribute(n,r))}function $e(e){return e.__attributes??={[Re]:e.nodeName.includes("-"),[Fe]:e.namespaceURI===Se}}var J=new Map;function De(e){var n=e.getAttribute("is")||e.nodeName,r=J.get(n);if(r)return r;J.set(n,r=[]);for(var t,s=e,a=Element.prototype;a!==s;){t=Ne(s);for(var o in t)t[o].set&&r.push(o);s=we(s)}return r}function en(e,n,r=n){var t=new WeakSet;Te(e,"input",async s=>{var a=s?e.defaultValue:e.value;if(a=k(e)?x(a):a,r(a),A!==null&&t.add(A),await Ae(),a!==(a=n())){var o=e.selectionStart,i=e.selectionEnd,u=e.value.length;if(e.value=a??"",i!==null){var l=e.value.length;o===i&&i===u&&l>u?(e.selectionStart=l,e.selectionEnd=l):(e.selectionStart=o,e.selectionEnd=Math.min(i,l))}}}),(b&&e.defaultValue!==e.value||Ue(n)==null&&e.value)&&(r(k(e)?x(e.value):e.value),A!==null&&t.add(A)),Me(()=>{var s=n();if(e===document.activeElement){var a=Pe??A;if(t.has(a))return}k(e)&&s===x(e.value)||e.type==="date"&&!s&&!e.value||s!==e.value&&(e.value=s??"")})}function k(e){var n=e.type;return n==="number"||n==="range"}function x(e){return e===""?null:+e}function nn(e){return function(...n){var r=n[0];return r.stopPropagation(),e?.apply(this,n)}}function rn(e,n){var r=e.$$events?.[n.type],t=z(r)?r.slice():r==null?[]:[r];for(var s of t)s.call(this,n)}const tn=globalThis.__sveltekit_1qq17j.env;async function He(e){let n;try{const r=await fetch(e);if(!r.ok)throw new Error(`HTTP ${r.status}`);n=await r.text()}catch(r){throw new Error(`Failed to fetch plugin: ${r.message}`)}return new Promise((r,t)=>{const s=Math.random().toString(36).substring(7),a=document.createElement("iframe");a.style.display="none",a.setAttribute("sandbox","allow-scripts");let o;const i=()=>{o&&clearTimeout(o),window.removeEventListener("message",u),document.body.contains(a)&&document.body.removeChild(a)},u=p=>{const c=p.data;if(!c||c.type!=="furnarchy-plugin-register"||c.requestId!==s)return;const h=c.plugin;if(!h.name){i(),t(new Error("Plugin registered but missing name"));return}r({name:h.name,version:h.version,author:h.author,sourceUrl:e}),i()};window.addEventListener("message",u);const l=`
            window.Furnarchy = {
                version: '0.0.0-sandbox',
                loadingPluginUrl: ${JSON.stringify(e)},
                register: function(meta, arg) {
                    if (typeof arg === 'function') {
                        // Send metadata immediately
                        window.parent.postMessage({
                            type: 'furnarchy-plugin-register',
                            requestId: '${s}',
                            plugin: meta
                        }, '*');

                        const api = {
                            send: function() {},
                            inject: function() {},
                            onIncoming: function() {},
                            onOutgoing: function() {},
                            onLoggedIn: function() {},
                            onPause: function() {}
                        };
                        try { arg(api); } catch(e) {}
                    }
                },
                onRegister: function() {},
                send: function() {}
            };
        `,d=`
            try {
                const content = decodeURIComponent(escape(atob('${btoa(unescape(encodeURIComponent(n)))}')));
                const script = document.createElement('script');
                script.textContent = content;
                document.body.appendChild(script);
            } catch(e) {
                console.error('Sandbox execution error:', e);
            }
        `,g=`
            <!DOCTYPE html>
            <html>
            <head>
                <script>${l}<\/script>
            </head>
            <body>
                <script>${d}<\/script>
            </body>
            </html>
        `;a.srcdoc=g,document.body.appendChild(a),o=setTimeout(()=>{i(),t(new Error("Plugin load timed out (5s) - did not call Furnarchy.register()?"))},5e3)})}const W="furnarchy_plugins",X="furnarchy_auth_url",Q="furnarchy_version",qe=Ce([]);function Ve(){if(typeof localStorage>"u")return[];const e=localStorage.getItem(W);if(!e)return[];try{const n=JSON.parse(e);return Array.isArray(n)?n.map(r=>typeof r=="string"?{url:r}:r):[]}catch(n){return console.error("Failed to load plugins",n),[]}}function Ye(e){typeof localStorage>"u"||(localStorage.setItem(W,JSON.stringify(e)),qe.set(e))}function an(){return typeof localStorage>"u"?null:localStorage.getItem(X)}function sn(e){typeof localStorage>"u"||localStorage.setItem(X,e)}function Ge(){return typeof localStorage>"u"?null:localStorage.getItem(Q)}function Je(e){typeof localStorage>"u"||localStorage.setItem(Q,e)}function Ke(e,n){if(!n)return!0;const r=i=>i.split(".").map(u=>parseInt(u,10)),[t,s]=r(e),[a,o]=r(n);return isNaN(t)||isNaN(a)?!1:a<t||a===t&&o<s}async function on(e){if(typeof localStorage>"u")return;const n=Ge();let r=Ve();if(Ke(e,n)){const t=["/plugins/auto-spinner.js"];let s=!1;for(const a of t)if(!r.some(o=>o.url===a))try{const o=await He(a);r.push({url:a,name:o.name,version:o.version,author:o.author,enabled:!0}),s=!0}catch(o){console.error(`Failed to load default plugin ${a}:`,o)}s&&Ye(r),Je(e)}}class je{constructor(n){this.core=n,n.loadingPluginUrl&&(this.metadata.sourceUrl=n.loadingPluginUrl)}id=crypto.randomUUID();metadata={name:"Unknown Plugin"};enabled=!0;handlers={incoming:[],outgoing:[],loggedIn:[],pause:[]};send(n){this.enabled&&this.core.send(n,this.metadata.name||"PLUGIN")}inject(n){this.enabled&&this.core.inject(n,this.metadata.name||"PLUGIN")}onIncoming(n){this.handlers.incoming.push(n)}onOutgoing(n){this.handlers.outgoing.push(n)}onLoggedIn(n){this.handlers.loggedIn.push(n)}onPause(n){this.handlers.pause.push(n)}_setEnabled(n){this.enabled!==n&&(this.enabled=n,this.handlers.pause.forEach(r=>{try{r(!n)}catch(t){console.error(t)}}))}async _processIncoming(n,r){if(!this.enabled)return n;let t=n;for(const s of this.handlers.incoming)try{const a=await s(t,r);if(a==null)return null;t=a}catch(a){console.error(`[${this.metadata.name}] Incoming Error:`,a)}return t}async _processOutgoing(n,r){if(!this.enabled)return n;let t=n;for(const s of this.handlers.outgoing)try{const a=await s(t,r);if(a==null)return null;t=a}catch(a){console.error(`[${this.metadata.name}] Outgoing Error:`,a)}return t}_notifyLoggedIn(){this.enabled&&this.handlers.loggedIn.forEach(n=>{try{n()}catch(r){console.error(`[${this.metadata.name}] LoggedIn Error:`,r)}})}}class ln{version="0.1.0";plugins=[];loadingPluginUrl=null;listeners=[];send(n,r){console.warn("[Furnarchy] send() called before connection established",n)}inject(n,r){console.warn("[Furnarchy] inject() called before connection established",n)}onRegister(n){this.listeners.push(n)}notifyUpdate(n){this.listeners.forEach(r=>{try{r(n)}catch(t){console.error(t)}})}register(n,r){const t=new je(this);t.metadata={...t.metadata,...n},this.plugins.push(t);try{r(t),console.log(`[Furnarchy] Registered plugin: ${t.metadata.name}`)}catch(s){console.error("[Furnarchy] Error initializing plugin:",s)}this.notifyUpdate(t)}async processIncoming(n,r=null){let t=n;for(const s of this.plugins){const a=await s._processIncoming(t,r);if(a==null)return null;t=a}return t}async processOutgoing(n,r=null){let t=n;for(const s of this.plugins){const a=await s._processOutgoing(t,r);if(a==null)return null;t=a}return t}notifyLoggedIn(){console.log("[Furnarchy] User logged in, notifying plugins..."),this.plugins.forEach(n=>n._notifyLoggedIn())}}export{ln as F,an as a,en as b,tn as c,G as d,Xe as e,nn as f,Ve as g,Ye as h,We as i,sn as j,rn as k,on as m,qe as p,Ze as r,Qe as s,He as v};
