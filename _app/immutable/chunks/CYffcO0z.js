import{O,V as P,ab as U,m as C,ac as H,ad as R,ae as W,a0 as S,$ as k,R as A,af as x,a5 as T}from"./ClPHtEvL.js";function rt(t,e){let r=null,s=C;var n;if(C){r=A;for(var i=H(document.head);i!==null&&(i.nodeType!==R||i.data!==t);)i=W(i);if(i===null)S(!1);else{var u=W(i);i.remove(),k(u)}}C||(n=document.head.appendChild(O()));try{P(()=>e(n),U)}finally{s&&(S(!0),k(r))}}const F=[...` 	
\r\fÂ \v\uFEFF`];function st(t,e,r){var s=t==null?"":""+t;if(r){for(var n in r)if(r[n])s=s?s+" "+n:n;else if(s.length)for(var i=n.length,u=0;(u=s.indexOf(n,u))>=0;){var c=u+i;(u===0||F.includes(s[u-1]))&&(c===s.length||F.includes(s[c]))?s=(u===0?"":s.substring(0,u))+s.substring(c+1):u=c}}return s===""?null:s}function M(t,e=!1){var r=e?" !important;":";",s="";for(var n in t){var i=t[n];i!=null&&i!==""&&(s+=" "+n+": "+i+r)}return s}function v(t){return t[0]!=="-"||t[1]!=="-"?t.toLowerCase():t}function nt(t,e){if(e){var r="",s,n;if(Array.isArray(e)?(s=e[0],n=e[1]):s=e,t){t=String(t).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var i=!1,u=0,c=!1,h=[];s&&h.push(...Object.keys(s).map(v)),n&&h.push(...Object.keys(n).map(v));var l=0,d=-1;const I=t.length;for(var f=0;f<I;f++){var g=t[f];if(c?g==="/"&&t[f-1]==="*"&&(c=!1):i?i===g&&(i=!1):g==="/"&&t[f+1]==="*"?c=!0:g==='"'||g==="'"?i=g:g==="("?u++:g===")"&&u--,!c&&i===!1&&u===0){if(g===":"&&d===-1)d=f;else if(g===";"||f===I-1){if(d!==-1){var b=v(t.substring(l,d).trim());if(!h.includes(b)){g!==";"&&f++;var D=t.substring(l,f).trim();r+=" "+D+";"}}l=f+1,d=-1}}}}return s&&(r+=M(s)),n&&(r+=M(n,!0)),r=r.trim(),r===""?null:r}return t==null?null:String(t)}const E={isOpen:!1,title:"",body:"",onClose:void 0,pluginId:void 0},_=x(E);function N(t){_.update(e=>({...E,...t,isOpen:!0}))}function j(){_.update(t=>{if(t.isOpen&&t.onClose)try{t.onClose()}catch(e){console.error("Error in modal onClose handler:",e)}return{...E}})}function y(t,e=0){let r="";do{const s=t%95;t=Math.floor(t/95),r=String.fromCharCode(s+32)+r}while(t>0||r.length<e);return r}function p(t){let e=0;for(let r=0;r<t.length;r++)e=e*95+(t.charCodeAt(r)-32);return e}function a(t,e=0){let r="";do{const s=t%220;t=Math.floor(t/220);const n=s+35;r=r+String.fromCharCode(n)}while(t>0||r.length<e);return r}function o(t){let e=0,r=1;for(let s=0;s<t.length;s++){const n=t.charCodeAt(s);e+=(n-35)*r,r*=220}return e}function m(t){const e={species:1,gender:0,colors:[0,0,0,0,0,0,0,0,0,0,0,0]};if(!t)return e;if(t.startsWith("w")){const r=Math.min(t.length,16);for(let s=0;s<12&&s+1<r;s++)e.colors[s]=o(t[s+1]);r>13&&(e.gender=o(t[13])),r>14&&(e.species=o(t.substring(14,16)))}else if(t.startsWith("t")){const r=Math.min(t.length,14);for(let s=0;s<10&&s+1<r;s++)e.colors[s]=o(t[s+1]);r>11&&(e.gender=o(t[11])),r>12&&(e.species=o(t[12])+1)}else{const r=Math.min(t.length,12);for(let s=0;s<10&&s<r;s++)e.colors[s]=p(t[s]);r>10&&(e.gender=p(t[10])),r>11&&(e.species=p(t[11])+1)}return e}function G(t){if(t.species>220||t.colors[10]>0||t.colors[11]>0){let r="w";for(let s=0;s<12;s++)r+=a(t.colors[s]||0,1);return r+=a(t.gender,1),r+=a(t.species,2),r}else{let r="t";for(let s=0;s<10;s++)r+=a(t.colors[s]||0,1);return r+=a(t.gender,1),r+=a(Math.max(0,t.species-1),1),r}}function $(t,e){return t||(e?G(e):"")}const X=/^(?:<img [^>]+>)?<font color='whisper'>\[ <name shortname='([^']+)' src='whisper-from'>([^<]+)<\/name> whispers, "(.*)" to you\. \]<\/font>$/,q=/^<font color='myspeech'>You say, "(.*)"<\/font>$/,Y=/^<name shortname='([^']+)'>([^<]+)<\/name>: (.*)$/,V=/^<font color='emote'><name shortname='([^']+)'>([^<]+)<\/name> (.*)<\/font>$/,B=/^<font color='roll'>.*?<name shortname='([^']+)'>([^<]+)<\/name> rolls (.*)<\/font>$/,K=/^<desc shortname='([^']+)' \/>&gt; (.*)$/;function L(t){if(t.startsWith("]B")){const e=t.substring(2).split(" ");if(e.length>=2){const r=parseInt(e[0],10),s=e[1];return{type:"set-user-info",uid:r,name:s}}}else if(t.startsWith("(")){const e=t.substring(1),r=e.match(X);if(r)return{type:"whisper",fromShort:r[1],from:r[2],message:r[3]};const s=e.match(q);if(s)return{type:"speech",message:s[1],isSelf:!0};const n=e.match(Y);if(n)return{type:"speech",fromShort:n[1],from:n[2],message:n[3],isSelf:!1};const i=e.match(V);if(i)return{type:"emote",fromShort:i[1],from:i[2],message:i[3]};const u=e.match(B);if(u)return{type:"roll",fromShort:u[1],from:u[2],message:u[3]};const c=e.match(K);return c?{type:"description",shortname:c[1],description:c[2]}:{type:"chat",text:e}}else if(t.startsWith("]f")){const e=t.substring(2,18);return{type:"set-character-info",name:t.substring(18).replace(/\|/g," "),colorCode:e,colorCodeParsed:m(e)}}else{if(t.startsWith("]&"))return{type:"load-portrait",uid:parseInt(t.substring(2),10)};if(t.startsWith("]W")){const e=o(t.substring(2,4)),r=o(t.substring(4,6)),s=o(t.substring(6,8)),n=o(t.substring(8,10)),i=o(t.substring(10,12)),u=o(t.substring(12,14)),c=o(t.substring(14,16)),h=o(t.substring(16,18)),l=o(t.substring(18,20));return{type:"world-metadata",wallDef:e,roofDef:r,floorDef:s,objDef:n,wallAlt:i,roofAlt:u,floorAlt:c,objAlt:h,regionThreshold:l}}else if(t.startsWith("]q")){const e=t.substring(2).split(" "),r=e[0]||"",s=e[1]||"",n=t.endsWith(" modern");return{type:"load-dream",map:r,patch:s,modern:n}}else if(t.startsWith("]M%")){let e=4;const r=[];for(;e+8<=t.length;){const s=o(t.substring(e,e+1)),n=o(t.substring(e+2,e+3)),i=o(t.substring(e+3,e+4)),u=o(t.substring(e+4,e+8)),c=n+220*(i>>1);r.push({version:s,id:c,checksum:u}),e+=8}return{type:"avatar-manifest",records:r}}else if(t.startsWith("]-")||t.startsWith("]P")){const e=t.substring(2,4),r=t.substring(4);return{type:"chat-buffer",subType:e,content:r}}else{if(t.startsWith("]G"))return{type:"name-visibility",visible:t[2]==="0"};if(t.startsWith("]j"))return{type:"play-music",trackId:o(t.substring(2,4))};if(t.startsWith("]s")){const e=o(t.substring(2,4)),r=o(t.substring(4,6)),s=t.substring(6,6+r);return{type:"set-tag",tagType:e,tag:s}}else{if(t.startsWith("]#"))return{type:"dialog-box",content:t.substring(2)};if(t.startsWith("]?"))return{type:"pounce-update",data:t.substring(2)};if(t.startsWith("]H")){const e=o(t.substring(2,6)),r=o(t.substring(6,8)),s=o(t.substring(8,10));return{type:"set-offsets",uid:e,yl:r,al:s}}else if(t.startsWith("]_")){const e=o(t.substring(2,6)),r=o(t.substring(6,7));return{type:"set-scale",uid:e,scale:r}}else if(t.startsWith("]O")){const e=o(t.substring(2,6)),r=o(t.substring(6,8));return{type:"set-gloam",uid:e,gloam:r}}else{if(t.startsWith("]I"))return{type:"batch-particle",data:t.substring(2)};if(t.startsWith("]%")){const e=t[2]==="1",r=t.substring(3);return{type:"online-status",online:e,name:r}}else if(t.startsWith("]v")){const e=t.charCodeAt(2),r=p(t.substring(3,5)),s=p(t.substring(5,7));return{type:"legacy-visual-effect",x:r,y:s,effectId:e}}else if(t.startsWith("@")){const e=p(t.substring(1,3)),r=p(t.substring(3,5));return{type:"camera-sync",x:e,y:r}}else if(t.startsWith("<")){const e=o(t.substring(1,5)),r=o(t.substring(5,7)),s=o(t.substring(7,9)),n=o(t.substring(9,10)),i=o(t.substring(10,11)),u=o(t.substring(11,12)),c=t.substring(12,12+u),h=12+u,l=t[h]==="w"?16:14,d=t.substring(h,h+l),f=m(d),g=o(t.substring(h+l+1,h+l+5)),b=o(t.substring(h+l+5,h+l+6));return{type:"add-avatar",uid:e,x:r,y:s,direction:n,pose:i,name:c,colorCode:d,colorCodeParsed:f,afkTime:g,scale:b}}else if(t.startsWith("/")||t.startsWith("A")){const e=t.startsWith("/")?"walk":"teleport",r=o(t.substring(1,5)),s=o(t.substring(5,7)),n=o(t.substring(7,9)),i=o(t.substring(9,10)),u=o(t.substring(10,11));return{type:"move-avatar",uid:r,x:s,y:n,direction:i,pose:u,moveType:e}}else if(t.startsWith("B")){const e=o(t.substring(1,5)),r=o(t.substring(5,6)),s=o(t.substring(6,7)),n=t.substring(7),i=m(n);return{type:"update-avatar-appearance",uid:e,direction:r,pose:s,colorCode:n,colorCodeParsed:i}}else{if(t.startsWith("C"))return{type:"remove-object",uid:o(t.substring(1,5))};if(t.startsWith(")"))return{type:"delete-object",uid:o(t.substring(1,5))};if(t.startsWith("D"))return{type:"dragonroar",message:t.substring(1)};if(t.startsWith("!"))return{type:"play-sound",soundId:o(t.substring(1,2))};if(["1","2",">","4","5","E","F"].includes(t[0]))return{type:"update-map",layer:{1:"floor",2:"wall",">":"item",4:"region",5:"effect",E:"lighting",F:"ambience"}[t[0]],data:t.substring(1)};if(t.startsWith("&"))return{type:"login-ready"};if(t.startsWith(";"))return{type:"load-map-legacy",mapName:t.substring(1)};if(t.startsWith("0"))return{type:"ds-variable",data:t.substring(1)};if(t.startsWith("3"))return{type:"ds-string",data:t.substring(1)};if(t.startsWith("6"))return{type:"ds-trigger-server",data:t.substring(1)};if(t.startsWith("7"))return{type:"ds-trigger-client",data:t.substring(1)};if(t.startsWith("8"))return{type:"ds-init",data:t.substring(1)}}}}}}return{type:"unknown",raw:t}}function z(t){if(t.startsWith('"'))return{type:"speech",message:t.substring(1)};if(t.startsWith(":"))return{type:"emote",message:t.substring(1)};if(t.startsWith("wh ")){const e=t.substring(3).split(" ");let r=e[0];const s=e.slice(1).join(" ");let n=!1;return r.startsWith("%")&&!r.startsWith("%%")&&(n=!0,r=r.substring(1)),{type:"whisper",target:r,message:s,exact:n}}else{if(t.startsWith("m "))return{type:"move",direction:parseInt(t.substring(2),10)};if(t==="<")return{type:"rotate",direction:"left"};if(t===">")return{type:"rotate",direction:"right"};if(t==="get")return{type:"get"};if(t==="use")return{type:"use"};if(t==="sit")return{type:"sit"};if(t==="stand")return{type:"stand"};if(t==="liedown")return{type:"liedown"};if(t.startsWith("loginNG "))return{type:"login",auth:t.substring(8)};if(t.startsWith("l")){if(t.length>=5){const e=o(t.substring(1,3)),r=o(t.substring(3,5));return{type:"look",x:e,y:r}}}else{if(t.startsWith("glook "))return{type:"glook",name:t.substring(6)};if(t==="vascodagama")return{type:"ready"};if(t==="quit")return{type:"quit"};if(t==="iamhere")return{type:"keep-alive"};if(t.startsWith("desc "))return{type:"set-desc",description:t.substring(5)};if(t.startsWith("color ")){const e=t.substring(6);return{type:"set-color",data:e,dataParsed:m(e)}}else{if(t.startsWith("costume "))return{type:"costume",args:t.substring(8)};if(t.startsWith("chcol ")){const e=t.substring(6);return{type:"chcol",colorCode:e,colorCodeParsed:m(e)}}else if(t.startsWith("afk")){if(t==="afk")return{type:"afk"};if(t.startsWith("afk "))return{type:"afk",message:t.substring(4)}}else{if(t==="unafk")return{type:"unafk"};if(t.startsWith("dsbtn "))return{type:"ds-btn",id:parseInt(t.substring(6),10)};if(t==="portrchng")return{type:"portrait-change"};if(t.startsWith("onln "))return{type:"check-online",name:t.substring(5)}}}}}return{type:"unknown",raw:t}}function J(t){switch(t.type){case"set-user-info":return`]B${t.uid} ${t.name}`;case"chat":return`(${t.text}`;case"whisper":return`(<font color='whisper'>[ <name shortname='${t.fromShort}' src='whisper-from'>${t.from}</name> whispers, "${t.message}" to you. ]</font>`;case"speech":return t.isSelf?`(<font color='myspeech'>You say, "${t.message}"</font>`:`(<name shortname='${t.fromShort}'>${t.from}</name>: ${t.message}`;case"emote":return`(<font color='emote'><name shortname='${t.fromShort}'>${t.from}</name> ${t.message}</font>`;case"roll":return`(<font color='roll'><img src='fsh://system.fsh:101' alt='@roll' /><channel name='@roll' /> <name shortname='${t.fromShort}'>${t.from}</name> rolls ${t.message}</font>`;case"description":return`(<desc shortname='${t.shortname}' />&gt; ${t.description}`;case"set-character-info":return`]f${$(t.colorCode,t.colorCodeParsed)}${t.name.replace(/ /g,"|")}`;case"load-portrait":return`]&${t.uid}`;case"camera-sync":return`@${y(t.x,2)}${y(t.y,2)}`;case"add-avatar":{const e=$(t.colorCode,t.colorCodeParsed);return`<${a(t.uid,4)}${a(t.x,2)}${a(t.y,2)}${a(t.direction,1)}${a(t.pose,1)}${a(t.name.length,1)}${t.name}${e}${a(0,1)}${a(t.afkTime,4)}${a(t.scale,1)}`}case"move-avatar":return`${t.moveType==="walk"?"/":"A"}${a(t.uid,4)}${a(t.x,2)}${a(t.y,2)}${a(t.direction,1)}${a(t.pose,1)}`;case"update-avatar-appearance":{const e=$(t.colorCode,t.colorCodeParsed);return`B${a(t.uid,4)}${a(t.direction,1)}${a(t.pose,1)}${e}`}case"remove-object":return`C${a(t.uid,4)}`;case"delete-object":return`)${a(t.uid,4)}`;case"dragonroar":return`D${t.message}`;case"play-sound":return`!${a(t.soundId,1)}`;case"world-metadata":return`]W${a(t.wallDef,2)}${a(t.roofDef,2)}${a(t.floorDef,2)}${a(t.objDef,2)}${a(t.wallAlt,2)}${a(t.roofAlt,2)}${a(t.floorAlt,2)}${a(t.objAlt,2)}${a(t.regionThreshold,2)}`;case"load-dream":return`]q${t.map} ${t.patch}${t.modern?" modern":""}`;case"avatar-manifest":{let e="]M% ";for(const r of t.records){const s=Math.floor(r.id/220)<<1|0,n=r.id%220;e+=a(r.version,1),e+=a(0,1),e+=a(n,1),e+=a(s,1),e+=a(r.checksum,4)}return e}case"chat-buffer":return`]-${t.subType}${t.content}`;case"name-visibility":return`]G${t.visible?"0":"1"}`;case"play-music":return`]j${a(t.trackId,2)}`;case"set-tag":return`]s${a(t.tagType,2)}${a(t.tag.length,2)}${t.tag}`;case"dialog-box":return`]#${t.content}`;case"pounce-update":return`]?${t.data}`;case"set-offsets":return`]H${a(t.uid,4)}${a(t.yl,2)}${a(t.al,2)}`;case"set-scale":return`]_${a(t.uid,4)}${a(t.scale,1)}`;case"set-gloam":return`]O${a(t.uid,4)}${a(t.gloam,2)}`;case"batch-particle":return`]I${t.data}`;case"legacy-visual-effect":return`]v${String.fromCharCode(t.effectId)}${y(t.x,2)}${y(t.y,2)}`;case"update-map":return`${{floor:"1",wall:"2",item:">",region:"4",effect:"5",lighting:"E",ambience:"F"}[t.layer]}${t.data}`;case"login-ready":return"&";case"load-map-legacy":return`;${t.mapName}`;case"ds-variable":return`0${t.data}`;case"ds-string":return`3${t.data}`;case"ds-trigger-server":return`6${t.data}`;case"ds-trigger-client":return`7${t.data}`;case"ds-init":return`8${t.data}`;case"online-status":return`]%${t.online?"1":"0"}${t.name}`;case"unknown":return t.raw}}function Z(t){switch(t.type){case"move":return`m ${t.direction}`;case"rotate":return t.direction==="left"?"<":">";case"look":return`l${a(t.x,2)}${a(t.y,2)}`;case"glook":return`glook ${t.name}`;case"speech":return`"${t.message}`;case"emote":return`:${t.message}`;case"whisper":return`wh ${t.exact?"%":""}${t.target} ${t.message}`;case"get":return"get";case"use":return"use";case"sit":return"sit";case"stand":return"stand";case"liedown":return"liedown";case"login":return`loginNG ${t.auth}`;case"ready":return"vascodagama";case"quit":return"quit";case"keep-alive":return"iamhere";case"set-desc":return`desc ${t.description}`;case"set-color":return`color ${$(t.data,t.dataParsed)}`;case"costume":return`costume ${t.args}`;case"chcol":return`chcol ${$(t.colorCode,t.colorCodeParsed)}`;case"afk":return t.message?`afk ${t.message}`:"afk";case"unafk":return"unafk";case"ds-btn":return`dsbtn ${t.id}`;case"portrait-change":return"portrchng";case"check-online":return`onln ${t.name}`;case"unknown":return t.raw}}const w={parseServerCommand:L,parseClientCommand:z,createServerCommand:J,createClientCommand:Z,unescape:t=>t.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#(\d+);/g,(e,r)=>String.fromCharCode(parseInt(r,10))),escape:t=>t.replace(/[&<>"']|[\u0080-\uFFFF]/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return"&#"+e.charCodeAt(0)+";"}}),base95Encode:y,base95Decode:p,base220Encode:a,base220Decode:o,getShortname:t=>{let e=t;return e=e.replace(/&(?:[Aa]grave|acute|circ|tilde|uml|ring)|AElig|aelig;/g,"a"),e=e.replace(/&[Cc]edil;/g,"c"),e=e.replace(/&[Ee]grave|acute|circ|uml;/g,"e"),e=e.replace(/&[Ii]grave|acute|circ|uml;/g,"i"),e=e.replace(/&ETH;/g,"d"),e=e.replace(/&[Nn]tilde;/g,"n"),e=e.replace(/&(?:[Oo]grave|acute|tilde|uml)|oslash|Ocirc|oric;/g,"o"),e=e.replace(/&[Uu]grave|acute|circ|uml;/g,"u"),e=e.replace(/&(?:[Yy]acute)|yuml;/g,"y"),e=e.replace(/&euro;/g,"e"),e=e.replace(/[^A-Za-z0-9]/g,""),e.toLowerCase()}};class Q{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};_enabledState=!0;get enabled(){return this._enabledState}get isLoggedIn(){return this.core.isLoggedIn}get isConnected(){return this.core.isConnected}get playerPosition(){return this.core.playerX===null||this.core.playerY===null?null:{x:this.core.playerX,y:this.core.playerY}}get name(){return this.core.characterName}get uid(){return this.core.characterUid}_handlers={incoming:[],outgoing:[],loggedIn:[],connected:[],disconnected:[],ready:[],pause:[],load:[],unload:[],configure:[]};_readyFired=!1;send(e,r){this.enabled&&this.core.send(e,this.metadata.id,r)}inject(e,r){this.enabled&&this.core.inject(e,this.metadata.id,r)}reconnect(){this.enabled&&this.core.reconnect()}disable(){this.enabled&&(this._setEnabled(!1),this.core.notifyUpdate(this))}enable(){this.enabled||(this._setEnabled(!0),this.core.notifyUpdate(this))}notify(e,r){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}const s=w.escape(e),n=`[<b><i>f: ${w.escape(this.metadata.name)}</i></b>]`;this.core.notify(s,n,this.metadata.id,r)}rawNotify(e,r){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}this.core.notify(e,"",this.metadata.id,r)}onIncoming(e,r=0){this._handlers.incoming.push({cb:e,priority:r}),this.core.invalidateHandlers()}onOutgoing(e,r=0){this._handlers.outgoing.push({cb:e,priority:r}),this.core.invalidateHandlers()}onLoggedIn(e){this._handlers.loggedIn.push(e)}onConnected(e){this._handlers.connected.push(e)}onDisconnected(e){this._handlers.disconnected.push(e)}onReady(e){if(this._handlers.ready.push(e),this._readyFired)try{e()}catch(r){console.error(`[${this.metadata.name}] Ready Error (Late):`,r)}}onPause(e){this._handlers.pause.push(e)}onLoad(e){this._handlers.load.push(e)}onUnload(e){this._handlers.unload.push(e)}onConfigure(e){this._handlers.configure.push(e)}openModal(e){N({...e,pluginId:this.metadata.id})}closeModal(){j()}getModalPluginId(){const e=T(_);return e.isOpen?e.pluginId??null:null}setGameInput(e){this.core.setGameInput(e)}saveData(e,r){if(typeof localStorage>"u")return;const s=`furnarchy_plugin_${this.metadata.id}_${e}`;try{localStorage.setItem(s,JSON.stringify(r))}catch(n){console.error(`[${this.metadata.name}] Failed to save data:`,n)}}loadData(e){if(typeof localStorage>"u")return null;const r=`furnarchy_plugin_${this.metadata.id}_${e}`;try{const s=localStorage.getItem(r);return s?JSON.parse(s):null}catch(s){return console.error(`[${this.metadata.name}] Failed to load data:`,s),null}}expose(e){this.core.registerService(e,this.metadata.id)}use(e){return this.core.getService(e)}_setEnabled(e){this._enabledState!==e&&(this._enabledState=e,this.core.invalidateHandlers(),this._handlers.pause.forEach(r=>{try{r(!e)}catch(s){console.error(s)}}))}_notifyLoggedIn(e,r){this.enabled&&this._handlers.loggedIn.forEach(s=>{try{s(e,r)}catch(n){console.error(`[${this.metadata.name}] LoggedIn Error:`,n)}})}_notifyConnected(){this.enabled&&this._handlers.connected.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] Connected Error:`,r)}})}_notifyDisconnected(){this.enabled&&this._handlers.disconnected.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] Disconnected Error:`,r)}})}_notifyReady(){this._readyFired||(this._readyFired=!0,this._handlers.ready.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] Ready Error:`,r)}}))}_notifyLoad(){this._handlers.load.forEach(e=>{try{e(this.enabled)}catch(r){console.error(`[${this.metadata.name}] Load Error:`,r)}})}_notifyUnload(){this._handlers.unload.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] Unload Error:`,r)}})}_notifyConfigure(){this._handlers.configure.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] Configure Error:`,r)}})}}class tt{version="0.17.0";plugins=[];services=new Map;utils=w;loadingPluginUrl=null;isLoggedIn=!1;isConnected=!1;characterName=null;characterUid=null;playerX=null;playerY=null;isReady=!1;_motdComplete=!1;listeners=[];gameInputEnabled=!0;_cachedIncoming=null;_cachedOutgoing=null;_gameDocument=null;constructor(){typeof document<"u"&&this.attachInputInterception(document)}attachInputInterception(e){this._gameDocument=e;const r=s=>{if(!this.gameInputEnabled){const n=s.target;if(n&&n.closest&&n.closest(".modal-window"))return;s.stopImmediatePropagation(),s.preventDefault()}};e.addEventListener("keydown",r,!0),e.addEventListener("keyup",r,!0),e.addEventListener("keypress",r,!0)}get clientHooks(){return this._gameDocument?.defaultView?.__CLIENT_HOOKS}setGameInput(e){this.gameInputEnabled=e,e&&this.focusGame()}focusGame(){if(this._gameDocument){const e=this._gameDocument.defaultView;e&&e.focus();const r=this._gameDocument.querySelector('#chatInput, #entry, input[type="text"], textarea');r&&r.focus()}}invalidateHandlers(){this._cachedIncoming=null,this._cachedOutgoing=null}start(){this.isReady||(this.isReady=!0,console.log("[Furnarchy] Starting plugins..."),this.plugins.forEach(e=>e._notifyReady()))}send(e,r,s){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,r,s){console.warn("[Furnarchy] inject() called before connection established",e)}reconnect(){this.clientHooks?.reconnect?(console.log("[Furnarchy] Triggering reconnect..."),this.clientHooks.reconnect()):console.warn("[Furnarchy] Reconnect not available.")}registerService(e,r){if(!e.name||!e.version){console.error("[Furnarchy] Service registration failed: Missing 'name' or 'version'",e);return}this.services.has(e.name)&&console.warn(`[Furnarchy] Service '${e.name}' is already registered. Overwriting.`),this.services.set(e.name,{service:e,providerId:r}),console.log(`[Furnarchy] Service registered: ${e.name} v${e.version} by ${r}`)}getService(e){const r=this.services.get(e);return r?r.service:null}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(r=>{try{r(e)}catch(s){console.error(s)}})}unloadPlugin(e){const r=this.plugins.findIndex(n=>n.metadata.id===e);if(r===-1)return;const s=this.plugins[r];console.log(`[Furnarchy] Unloading plugin: ${s.metadata.name} (${e})`),s._notifyUnload(),this.plugins.splice(r,1),this.invalidateHandlers()}register(e,r){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(n=>n.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const s=new Q(this);s.metadata={...s.metadata,...e},e.toggle&&s._setEnabled(!1),this.plugins.push(s);try{r(s),console.log(`[Furnarchy] Registered plugin: ${s.metadata.name} (${s.metadata.id})`)}catch(n){console.error("[Furnarchy] Error initializing plugin:",n)}this.notifyUpdate(s),s._notifyLoad(),this.isReady&&s._notifyReady()}_getSortedHandlers(e){if(e==="incoming"&&this._cachedIncoming)return this._cachedIncoming;if(e==="outgoing"&&this._cachedOutgoing)return this._cachedOutgoing;const r=[];for(const s of this.plugins){const n=e==="incoming"?s._handlers.incoming:s._handlers.outgoing;for(const i of n)r.push({...i,plugin:s})}return r.sort((s,n)=>n.priority-s.priority),e==="incoming"?this._cachedIncoming=r:this._cachedOutgoing=r,r}async _processMessage(e,r,s,n){let i=r;const u=this._getSortedHandlers(e);for(const{cb:c,plugin:h}of u)try{const l=await c(i,s,n);if(l==null)return null;i=l}catch(l){const d=e.charAt(0).toUpperCase()+e.slice(1);console.error(`[${h.metadata.name}] ${d} Error:`,l)}return i}async processIncoming(e,r=null,s=null){if(!this._motdComplete)return e.includes("Dragonroar")&&(this._motdComplete=!0),e;const n=L(e);if(n.type!=="world-metadata"){if(n.type==="set-user-info")this.notifyLoggedIn(n.name,n.uid.toString());else if(this.characterUid){const i=parseInt(this.characterUid,10);n.type==="add-avatar"&&n.uid===i?(this.playerX=n.x,this.playerY=n.y):n.type==="move-avatar"&&n.uid===i&&(this.playerX=n.x,this.playerY=n.y)}}return this._processMessage("incoming",e,r,s)}async processOutgoing(e,r=null,s=null){return e==="finfo"?(this.showInfo(),null):this._processMessage("outgoing",e,r,s)}showInfo(){const e=[`${this.utils.escape("âš¡")} Furnarchy Zero v${this.version}`];this.isLoggedIn?e.push(`${this.utils.escape("ðŸ‘¤")} User: ${this.characterName} (${this.characterUid})`):e.push(`${this.utils.escape("ðŸ‘¤")} User: Not logged in`),e.push(`${this.utils.escape("ðŸ”Œ")} Plugins: ${this.plugins.length} (${this.plugins.filter(r=>r.enabled).length} enabled)`),this.plugins.forEach(r=>{const s=r.enabled?this.utils.escape("âœ…"):this.utils.escape("ðŸ’¤");e.push(`  - ${s} ${this.utils.escape(r.metadata.name)} v${r.metadata.version}`)}),typeof window<"u"&&e.push(`${this.utils.escape("ðŸ–¥ï¸")} Viewport: ${window.innerWidth}x${window.innerHeight}`),e.forEach(r=>this.notify(r))}notify(e,r="[<b><i>f</i></b>]",s,n){this.clientHooks?.appendChat?this.clientHooks.appendChat(`${r?`${r} `:""}${e}`):this.inject(`(${this.utils.escape(r)} ${e}`,s,n)}notifyLoggedIn(e,r){this.isLoggedIn=!0,this.characterName=e,this.characterUid=r,console.log(`[Furnarchy] User logged in as ${e} (${r}), notifying plugins...`),this.plugins.forEach(s=>s._notifyLoggedIn(e,r))}notifyConnected(){this.isConnected=!0,console.log("[Furnarchy] Connected to server, notifying plugins..."),this._motdComplete=!1,this.plugins.forEach(e=>e._notifyConnected())}notifyDisconnected(){this.isLoggedIn=!1,this.isConnected=!1,this.playerX=null,this.playerY=null,console.log("[Furnarchy] Disconnected from server, notifying plugins..."),this.plugins.forEach(e=>e._notifyDisconnected())}getExposedAPI(){return{register:this.register.bind(this),version:this.version,utils:this.utils}}}const at=new tt;export{tt as F,st as a,j as c,at as f,rt as h,_ as m,nt as t};
