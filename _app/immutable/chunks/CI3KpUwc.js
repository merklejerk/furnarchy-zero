import{O as S,B as v,aD as $,h as l,e as I,C,g as u,I as g,s as m,c as E,aE as b,ap as w}from"./0_43KKKC.js";import{u as c,p as F}from"./DU95RE0J.js";function U(s,e){let t=null,a=l;var n;if(l){t=E;for(var i=I(document.head);i!==null&&(i.nodeType!==C||i.data!==s);)i=u(i);if(i===null)g(!1);else{var r=u(i);i.remove(),m(r)}}l||(n=document.head.appendChild(S()));try{v(()=>e(n),$)}finally{a&&(g(!0),m(t))}}const d={isOpen:!1,title:"",body:"",onClose:void 0,pluginId:void 0},h=b(d);function D(s){h.update(e=>({...d,...s,isOpen:!0}))}function L(){h.update(s=>{if(s.isOpen&&s.onClose)try{s.onClose()}catch(e){console.error("Error in modal onClose handler:",e)}return{...d}})}class f{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};_enabledState=!0;get enabled(){return this._enabledState}get isLoggedIn(){return this.core.isLoggedIn}get isConnected(){return this.core.isConnected}get gameState(){return this.core.gameState}getGameDocument(){return this.core.gameDocument}_handlers={incoming:[],outgoing:[],loggedIn:[],connected:[],disconnected:[],ready:[],pause:[],load:[],unload:[],configure:[],notify:[]};_readyFired=!1;send(e,t){this.enabled&&this.core.send(e,this.metadata.id,t)}inject(e,t){this.enabled&&this.core.inject(e,this.metadata.id,t)}reconnect(){this.enabled&&this.core.reconnect()}disable(){this.enabled&&(this._setEnabled(!1),this.core.notifyUpdate(this))}enable(){this.enabled||(this._setEnabled(!0),this.core.notifyUpdate(this))}notify(e,t){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}const a=c.escape(e),n=`[<b><i>f: ${c.escape(this.metadata.name)}</i></b>]`;this.core.notify(a,n,this.metadata.id,t)}rawNotify(e,t){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}this.core.notify(e,"",this.metadata.id,t)}onIncoming(e,t=0){this._handlers.incoming.push({cb:e,priority:t}),this.core.invalidateHandlers()}onOutgoing(e,t=0){this._handlers.outgoing.push({cb:e,priority:t}),this.core.invalidateHandlers()}onLoggedIn(e){this._handlers.loggedIn.push(e)}onConnected(e){this._handlers.connected.push(e)}onDisconnected(e){this._handlers.disconnected.push(e)}onReady(e){if(this._handlers.ready.push(e),this._readyFired)try{e()}catch(t){console.error(`[${this.metadata.name}] Ready Error (Late):`,t)}}onPause(e){this._handlers.pause.push(e)}onLoad(e){this._handlers.load.push(e)}onUnload(e){this._handlers.unload.push(e)}onConfigure(e){this._handlers.configure.push(e)}onNotify(e){this._handlers.notify.push(e)}openModal(e){D({...e,pluginId:this.metadata.id})}closeModal(){L()}getModalPluginId(){const e=w(h);return e.isOpen?e.pluginId??null:null}setGameInput(e){this.core.setGameInput(e)}saveData(e,t){if(typeof localStorage>"u")return;const a=`furnarchy_plugin_${this.metadata.id}_${e}`;try{localStorage.setItem(a,JSON.stringify(t))}catch(n){console.error(`[${this.metadata.name}] Failed to save data:`,n)}}loadData(e){if(typeof localStorage>"u")return null;const t=`furnarchy_plugin_${this.metadata.id}_${e}`;try{const a=localStorage.getItem(t);return a?JSON.parse(a):null}catch(a){return console.error(`[${this.metadata.name}] Failed to load data:`,a),null}}expose(e){this.core.registerService(e,this.metadata.id)}use(e){return this.core.getService(e)}_setEnabled(e){this._enabledState!==e&&(this._enabledState=e,this.core.invalidateHandlers(),this._handlers.pause.forEach(t=>{try{t(!e)}catch(a){console.error(a)}}))}_notifyLoggedIn(e,t){this.enabled&&this._handlers.loggedIn.forEach(a=>{try{a(e,t)}catch(n){console.error(`[${this.metadata.name}] LoggedIn Error:`,n)}})}_notifyConnected(){this.enabled&&this._handlers.connected.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] Connected Error:`,t)}})}_notifyDisconnected(){this.enabled&&this._handlers.disconnected.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] Disconnected Error:`,t)}})}_notifyReady(){this._readyFired||(this._readyFired=!0,this._handlers.ready.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] Ready Error:`,t)}}))}_notifyLoad(){this._handlers.load.forEach(e=>{try{e(this.enabled)}catch(t){console.error(`[${this.metadata.name}] Load Error:`,t)}})}_notifyUnload(){this._handlers.unload.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] Unload Error:`,t)}})}_notifyConfigure(){this._handlers.configure.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] Configure Error:`,t)}})}_notifyNotify(e,t){this.enabled&&this._handlers.notify.forEach(a=>{try{a(e,t)}catch(n){console.error(`[${this.metadata.name}] Notify Error:`,n)}})}}class P{version="0.19.0";plugins=[];services=new Map;utils=c;loadingPluginUrl=null;isLoggedIn=!1;isConnected=!1;gameState={camera:null,player:null,mapName:null,avatars:new Map};isReady=!1;_motdComplete=!1;listeners=[];gameInputEnabled=!0;_cachedIncoming=null;_cachedOutgoing=null;_gameDocument=null;_systemPlugin;get gameDocument(){return this._gameDocument}constructor(){typeof document<"u"&&this.attachInputInterception(document),this._systemPlugin=new f(this),this._systemPlugin.metadata={id:"furnarchy-core-system",name:"System",version:this.version,description:"Internal system plugin for state tracking.",author:"Furnarchy Zero"},this._systemPlugin.onIncoming(this._updateGameState.bind(this),-1e4)}attachInputInterception(e){this._gameDocument=e;const t=a=>{if(!this.gameInputEnabled){const n=a.target;if(n&&n.closest&&n.closest(".modal-window"))return;a.stopImmediatePropagation(),a.preventDefault()}};e.addEventListener("keydown",t,!0),e.addEventListener("keyup",t,!0),e.addEventListener("keypress",t,!0)}get clientHooks(){return this._gameDocument?.defaultView?.__CLIENT_HOOKS}setGameInput(e){this.gameInputEnabled=e,e&&this.focusGame()}focusGame(){if(this._gameDocument){const e=this._gameDocument.defaultView;e&&e.focus();const t=this._gameDocument.querySelector('#chatInput, #entry, input[type="text"], textarea');t&&t.focus()}}invalidateHandlers(){this._cachedIncoming=null,this._cachedOutgoing=null}start(){this.isReady||(this.isReady=!0,console.log("[Furnarchy] Starting plugins..."),this.plugins.forEach(e=>e._notifyReady()))}send(e,t,a){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,t,a){console.warn("[Furnarchy] inject() called before connection established",e)}reconnect(){this.clientHooks?.reconnect?(console.log("[Furnarchy] Triggering reconnect..."),this.clientHooks.reconnect()):console.warn("[Furnarchy] Reconnect not available.")}registerService(e,t){if(!e.name||!e.version){console.error("[Furnarchy] Service registration failed: Missing 'name' or 'version'",e);return}this.services.has(e.name)&&console.warn(`[Furnarchy] Service '${e.name}' is already registered. Overwriting.`),this.services.set(e.name,{service:e,providerId:t}),console.log(`[Furnarchy] Service registered: ${e.name} v${e.version} by ${t}`)}getService(e){const t=this.services.get(e);return t?t.service:null}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(t=>{try{t(e)}catch(a){console.error(a)}})}unloadPlugin(e){const t=this.plugins.findIndex(n=>n.metadata.id===e);if(t===-1)return;const a=this.plugins[t];console.log(`[Furnarchy] Unloading plugin: ${a.metadata.name} (${e})`),a._notifyUnload(),this.plugins.splice(t,1),this.invalidateHandlers()}register(e,t){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(n=>n.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const a=new f(this);a.metadata={...a.metadata,...e},e.toggle&&a._setEnabled(!1),this.plugins.push(a);try{t(a),console.log(`[Furnarchy] Registered plugin: ${a.metadata.name} (${a.metadata.id})`)}catch(n){console.error("[Furnarchy] Error initializing plugin:",n)}this.notifyUpdate(a),a._notifyLoad(),this.isReady&&a._notifyReady()}_getSortedHandlers(e){if(e==="incoming"&&this._cachedIncoming)return this._cachedIncoming;if(e==="outgoing"&&this._cachedOutgoing)return this._cachedOutgoing;const t=[],a=[...this.plugins,this._systemPlugin];for(const n of a){const i=e==="incoming"?n._handlers.incoming:n._handlers.outgoing;for(const r of i)t.push({...r,plugin:n})}return t.sort((n,i)=>i.priority-n.priority),e==="incoming"?this._cachedIncoming=t:this._cachedOutgoing=t,t}async _processMessage(e,t,a,n){let i=t;const r=this._getSortedHandlers(e);for(const{cb:p,plugin:y}of r)try{const o=await p(i,a,n);if(o==null)return null;i=o}catch(o){const _=e.charAt(0).toUpperCase()+e.slice(1);console.error(`[${y.metadata.name}] ${_} Error:`,o)}return i}_updateGameState(e){const t=F(e);if(t.type==="set-user-info")this.notifyLoggedIn(t.name,t.uid.toString());else if(t.type==="camera-sync")this.gameState.camera={x:t.x,y:t.y};else if(t.type==="load-map-legacy")this.gameState.mapName=t.mapName,this.gameState.avatars.clear();else if(t.type==="load-dream")this.gameState.mapName=t.map,this.gameState.avatars.clear();else if(t.type==="add-avatar")this.gameState.avatars.set(t.uid,{name:t.name,x:t.x,y:t.y,colorCode:t.colorCode||""}),this.gameState.player&&this.gameState.player.uid===t.uid.toString()&&(this.gameState.player.x=t.x,this.gameState.player.y=t.y,t.colorCode&&(this.gameState.player.colorCode=t.colorCode));else if(t.type==="move-avatar"){const a=this.gameState.avatars.get(t.uid);a&&(a.x=t.x,a.y=t.y),this.gameState.player&&this.gameState.player.uid===t.uid.toString()&&(this.gameState.player.x=t.x,this.gameState.player.y=t.y)}else if(t.type==="remove-object"||t.type==="delete-object")this.gameState.avatars.delete(t.uid);else if(t.type==="update-avatar-appearance"){const a=this.gameState.avatars.get(t.uid);a&&t.colorCode&&(a.colorCode=t.colorCode),this.gameState.player&&this.gameState.player.uid===t.uid.toString()&&t.colorCode&&(this.gameState.player.colorCode=t.colorCode)}else t.type==="set-character-info"&&this.gameState.player&&this.gameState.player.name===t.name&&(this.gameState.player.colorCode=t.colorCode);return e}async processIncoming(e,t=null,a=null){return this._motdComplete?this._processMessage("incoming",e,t,a):(e.includes("Dragonroar")&&(this._motdComplete=!0),e)}async processOutgoing(e,t=null,a=null){return e==="finfo"?(this.showInfo(),null):this._processMessage("outgoing",e,t,a)}showInfo(){const e=[`${this.utils.escape("âš¡")} Furnarchy Zero v${this.version}`];this.isLoggedIn&&this.gameState.player?(e.push(`${this.utils.escape("ðŸ‘¤")} User: ${this.gameState.player.name} (${this.gameState.player.uid})`),this.gameState.mapName&&e.push(`${this.utils.escape("ðŸ—ºï¸")} Map: ${this.gameState.mapName}`),this.gameState.player.x!==null&&e.push(`${this.utils.escape("ðŸ“")} Pos: ${this.gameState.player.x}, ${this.gameState.player.y}`),e.push(`${this.utils.escape("ðŸ‘¥")} Avatar count: ${this.gameState.avatars.size}`)):e.push(`${this.utils.escape("ðŸ‘¤")} User: Not logged in`),e.push(`${this.utils.escape("ðŸ”Œ")} Plugins: ${this.plugins.length} (${this.plugins.filter(t=>t.enabled).length} enabled)`),this.plugins.forEach(t=>{const a=t.enabled?this.utils.escape("âœ…"):this.utils.escape("ðŸ’¤");e.push(`  - ${a} ${this.utils.escape(t.metadata.name)} v${t.metadata.version}`)}),typeof window<"u"&&e.push(`${this.utils.escape("ðŸ–¥ï¸")} Viewport: ${window.innerWidth}x${window.innerHeight}`),e.forEach(t=>this.notify(t))}notify(e,t="[<b><i>f</i></b>]",a,n){this.clientHooks?.appendChat?this.clientHooks.appendChat(`${t?`${t} `:""}${e}`):this.inject(`(${this.utils.escape(t)} ${e}`,a,n),this.plugins.forEach(i=>i._notifyNotify(e,t))}notifyLoggedIn(e,t){this.isLoggedIn=!0,this.gameState.player={name:e,uid:t,x:0,y:0,colorCode:""},console.log(`[Furnarchy] User logged in as ${e} (${t}), notifying plugins...`),this.plugins.forEach(a=>a._notifyLoggedIn(e,t))}notifyConnected(){this.isConnected=!0,console.log("[Furnarchy] Connected to server, notifying plugins..."),this._motdComplete=!1,this.plugins.forEach(e=>e._notifyConnected())}notifyDisconnected(){this.isLoggedIn=!1,this.isConnected=!1,this.gameState.player=null,this.gameState.camera=null,this.gameState.mapName=null,this.gameState.avatars.clear(),console.log("[Furnarchy] Disconnected from server, notifying plugins..."),this.plugins.forEach(e=>e._notifyDisconnected())}getExposedAPI(){return{register:this.register.bind(this),version:this.version,utils:this.utils}}}const x=new P;export{P as F,L as c,x as f,U as h,h as m};
