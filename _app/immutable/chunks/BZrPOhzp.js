import{O as D,V as O,ab as M,m,ac as H,ad as U,ae as _,a0 as C,$ as I,R,af as A,a5 as T}from"./ClPHtEvL.js";function Q(t,e){let s=null,r=m;var a;if(m){s=R;for(var i=H(document.head);i!==null&&(i.nodeType!==U||i.data!==t);)i=_(i);if(i===null)C(!1);else{var u=_(i);i.remove(),I(u)}}m||(a=document.head.appendChild(D()));try{O(()=>e(a),M)}finally{r&&(C(!0),I(s))}}const W=[...` 	
\r\fÂ \v\uFEFF`];function tt(t,e,s){var r=t==null?"":""+t;if(s){for(var a in s)if(s[a])r=r?r+" "+a:a;else if(r.length)for(var i=a.length,u=0;(u=r.indexOf(a,u))>=0;){var c=u+i;(u===0||W.includes(r[u-1]))&&(c===r.length||W.includes(r[c]))?r=(u===0?"":r.substring(0,u))+r.substring(c+1):u=c}}return r===""?null:r}function S(t,e=!1){var s=e?" !important;":";",r="";for(var a in t){var i=t[a];i!=null&&i!==""&&(r+=" "+a+": "+i+s)}return r}function $(t){return t[0]!=="-"||t[1]!=="-"?t.toLowerCase():t}function et(t,e){if(e){var s="",r,a;if(Array.isArray(e)?(r=e[0],a=e[1]):r=e,t){t=String(t).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var i=!1,u=0,c=!1,h=[];r&&h.push(...Object.keys(r).map($)),a&&h.push(...Object.keys(a).map($));var l=0,d=-1;const E=t.length;for(var f=0;f<E;f++){var g=t[f];if(c?g==="/"&&t[f-1]==="*"&&(c=!1):i?i===g&&(i=!1):g==="/"&&t[f+1]==="*"?c=!0:g==='"'||g==="'"?i=g:g==="("?u++:g===")"&&u--,!c&&i===!1&&u===0){if(g===":"&&d===-1)d=f;else if(g===";"||f===E-1){if(d!==-1){var F=$(t.substring(l,d).trim());if(!h.includes(F)){g!==";"&&f++;var L=t.substring(l,f).trim();s+=" "+L+";"}}l=f+1,d=-1}}}}return r&&(s+=S(r)),a&&(s+=S(a,!0)),s=s.trim(),s===""?null:s}return t==null?null:String(t)}const v={isOpen:!1,title:"",body:"",onClose:void 0,pluginId:void 0},w=A(v);function x(t){w.update(e=>({...v,...t,isOpen:!0}))}function P(){w.update(t=>{if(t.isOpen&&t.onClose)try{t.onClose()}catch(e){console.error("Error in modal onClose handler:",e)}return{...v}})}function p(t,e=0){let s="";do{const r=t%95;t=Math.floor(t/95),s=String.fromCharCode(r+32)+s}while(t>0||s.length<e);return s}function y(t){let e=0;for(let s=0;s<t.length;s++)e=e*95+(t.charCodeAt(s)-32);return e}function n(t,e=0){let s="";do{const r=t%220;t=Math.floor(t/220);const a=r+35;s=s+String.fromCharCode(a)}while(t>0||s.length<e);return s}function o(t){let e=0,s=1;for(let r=0;r<t.length;r++){const a=t.charCodeAt(r);e+=(a-35)*s,s*=220}return e}const j=/^(?:<img [^>]+>)?<font color='whisper'>\[ <name shortname='([^']+)' src='whisper-from'>([^<]+)<\/name> whispers, "(.*)" to you\. \]<\/font>$/,N=/^<font color='myspeech'>You say, "(.*)"<\/font>$/,G=/^<name shortname='([^']+)'>([^<]+)<\/name>: (.*)$/,X=/^<font color='emote'><name shortname='([^']+)'>([^<]+)<\/name> (.*)<\/font>$/,q=/^<font color='roll'>.*?<name shortname='([^']+)'>([^<]+)<\/name> rolls (.*)<\/font>$/,Y=/^<desc shortname='([^']+)' \/>&gt; (.*)$/;function k(t){if(t.startsWith("]B")){const e=t.substring(2).split(" ");if(e.length>=2){const s=parseInt(e[0],10),r=e[1];return{type:"set-user-info",uid:s,name:r}}}else if(t.startsWith("(")){const e=t.substring(1),s=e.match(j);if(s)return{type:"whisper",fromShort:s[1],from:s[2],message:s[3]};const r=e.match(N);if(r)return{type:"speech",message:r[1],isSelf:!0};const a=e.match(G);if(a)return{type:"speech",fromShort:a[1],from:a[2],message:a[3],isSelf:!1};const i=e.match(X);if(i)return{type:"emote",fromShort:i[1],from:i[2],message:i[3]};const u=e.match(q);if(u)return{type:"roll",fromShort:u[1],from:u[2],message:u[3]};const c=e.match(Y);return c?{type:"description",shortname:c[1],description:c[2]}:{type:"chat",text:e}}else if(t.startsWith("]f")){const e=t.substring(2,18);return{type:"set-avatar-info",name:t.substring(18),visualCode:e}}else{if(t.startsWith("]&"))return{type:"load-portrait",uid:parseInt(t.substring(2),10)};if(t.startsWith("]W")){const e=o(t.substring(2,4)),s=o(t.substring(4,6)),r=o(t.substring(6,8)),a=o(t.substring(8,10)),i=o(t.substring(10,12)),u=o(t.substring(12,14)),c=o(t.substring(14,16)),h=o(t.substring(16,18)),l=o(t.substring(18,20));return{type:"world-metadata",wallDef:e,roofDef:s,floorDef:r,objDef:a,wallAlt:i,roofAlt:u,floorAlt:c,objAlt:h,regionThreshold:l}}else if(t.startsWith("]q")){const e=t.substring(2).split(" "),s=e[0]||"",r=e[1]||"",a=t.endsWith(" modern");return{type:"load-dream",map:s,patch:r,modern:a}}else if(t.startsWith("]M%")){let e=4;const s=[];for(;e+8<=t.length;){const r=o(t.substring(e,e+1)),a=o(t.substring(e+2,e+3)),i=o(t.substring(e+3,e+4)),u=o(t.substring(e+4,e+8)),c=a+220*(i>>1);s.push({version:r,id:c,checksum:u}),e+=8}return{type:"avatar-manifest",records:s}}else if(t.startsWith("]-")||t.startsWith("]P")){const e=t.substring(2,4),s=t.substring(4);return{type:"chat-buffer",subType:e,content:s}}else{if(t.startsWith("]G"))return{type:"name-visibility",visible:t[2]==="0"};if(t.startsWith("]j"))return{type:"play-music",trackId:o(t.substring(2,4))};if(t.startsWith("]s")){const e=o(t.substring(2,4)),s=o(t.substring(4,6)),r=t.substring(6,6+s);return{type:"set-tag",tagType:e,tag:r}}else{if(t.startsWith("]#"))return{type:"dialog-box",content:t.substring(2)};if(t.startsWith("]?"))return{type:"pounce-update",data:t.substring(2)};if(t.startsWith("]H")){const e=o(t.substring(2,6)),s=o(t.substring(6,8)),r=o(t.substring(8,10));return{type:"set-offsets",uid:e,yl:s,al:r}}else if(t.startsWith("]_")){const e=o(t.substring(2,6)),s=o(t.substring(6,7));return{type:"set-scale",uid:e,scale:s}}else if(t.startsWith("]O")){const e=o(t.substring(2,6)),s=o(t.substring(6,8));return{type:"set-gloam",uid:e,gloam:s}}else{if(t.startsWith("]I"))return{type:"batch-particle",data:t.substring(2)};if(t.startsWith("]%")){const e=t[2]==="1",s=t.substring(3);return{type:"online-status",online:e,name:s}}else if(t.startsWith("]v")){const e=y(t.substring(2,4)),s=y(t.substring(4,6)),r=t.charCodeAt(6);return{type:"legacy-visual-effect",x:e,y:s,effectId:r}}else if(t.startsWith("@")){const e=y(t.substring(1,3)),s=y(t.substring(3,5));return{type:"camera-sync",x:e,y:s}}else if(t.startsWith("<")){const e=o(t.substring(1,5)),s=o(t.substring(5,7)),r=o(t.substring(7,9)),a=o(t.substring(9,10)),i=o(t.substring(10,11)),u=o(t.substring(11,12)),c=t.substring(12,12+u),h=12+u,l=t[h]==="w"?16:14,d=t.substring(h,h+l),f=o(t.substring(h+l+1,h+l+5)),g=o(t.substring(h+l+5,h+l+6));return{type:"add-avatar",uid:e,x:s,y:r,direction:a,pose:i,name:c,colorCode:d,afkTime:f,scale:g}}else if(t.startsWith("/")||t.startsWith("A")){const e=t.startsWith("/")?"walk":"teleport",s=o(t.substring(1,5)),r=o(t.substring(5,7)),a=o(t.substring(7,9)),i=o(t.substring(9,10)),u=o(t.substring(10,11));return{type:"move-avatar",uid:s,x:r,y:a,direction:i,pose:u,moveType:e}}else if(t.startsWith("B")){const e=o(t.substring(1,5)),s=o(t.substring(5,6)),r=o(t.substring(6,7)),a=t.substring(7);return{type:"update-avatar-appearance",uid:e,direction:s,pose:r,colorCode:a}}else{if(t.startsWith("C"))return{type:"remove-object",uid:o(t.substring(1,5))};if(t.startsWith(")"))return{type:"delete-object",uid:o(t.substring(1,5))};if(t.startsWith("D"))return{type:"dragonroar",message:t.substring(1)};if(t.startsWith("!"))return{type:"play-sound",soundId:o(t.substring(1,2))};if(["1","2",">","4","5","E","F"].includes(t[0]))return{type:"update-map",layer:{1:"floor",2:"wall",">":"item",4:"region",5:"effect",E:"lighting",F:"ambience"}[t[0]],data:t.substring(1)};if(t.startsWith("&"))return{type:"login-ready"};if(t.startsWith(";"))return{type:"load-map-legacy",mapName:t.substring(1)};if(t.startsWith("0"))return{type:"ds-variable",data:t.substring(1)};if(t.startsWith("3"))return{type:"ds-string",data:t.substring(1)};if(t.startsWith("6"))return{type:"ds-trigger-server",data:t.substring(1)};if(t.startsWith("7"))return{type:"ds-trigger-client",data:t.substring(1)};if(t.startsWith("8"))return{type:"ds-init",data:t.substring(1)}}}}}}return{type:"unknown",raw:t}}function V(t){if(t.startsWith('"'))return{type:"speech",message:t.substring(1)};if(t.startsWith(":"))return{type:"emote",message:t.substring(1)};if(t.startsWith("wh ")){const e=t.substring(3).split(" ");let s=e[0];const r=e.slice(1).join(" ");let a=!1;return s.startsWith("%")&&!s.startsWith("%%")&&(a=!0,s=s.substring(1)),{type:"whisper",target:s,message:r,exact:a}}else{if(t.startsWith("m "))return{type:"move",direction:parseInt(t.substring(2),10)};if(t==="<")return{type:"rotate",direction:"left"};if(t===">")return{type:"rotate",direction:"right"};if(t==="get")return{type:"get"};if(t==="use")return{type:"use"};if(t==="sit")return{type:"sit"};if(t==="stand")return{type:"stand"};if(t==="liedown")return{type:"liedown"};if(t.startsWith("loginNG "))return{type:"login",auth:t.substring(8)};if(t.startsWith("l")){if(t.length>=5){const e=o(t.substring(1,3)),s=o(t.substring(3,5));return{type:"look",x:e,y:s}}}else{if(t.startsWith("glook "))return{type:"glook",name:t.substring(6)};if(t==="vascodagama")return{type:"ready"};if(t==="quit")return{type:"quit"};if(t==="iamhere")return{type:"keep-alive"};if(t.startsWith("desc "))return{type:"set-desc",description:t.substring(5)};if(t.startsWith("color "))return{type:"set-color",data:t.substring(6)};if(t.startsWith("costume "))return{type:"costume",args:t.substring(8)};if(t.startsWith("afk")){if(t==="afk")return{type:"afk"};if(t.startsWith("afk "))return{type:"afk",message:t.substring(4)}}else{if(t==="unafk")return{type:"unafk"};if(t.startsWith("dsbtn "))return{type:"ds-btn",id:parseInt(t.substring(6),10)};if(t==="portrchng")return{type:"portrait-change"};if(t.startsWith("onln "))return{type:"check-online",name:t.substring(5)}}}}return{type:"unknown",raw:t}}function B(t){switch(t.type){case"set-user-info":return`]B${t.uid} ${t.name}`;case"chat":return`(${t.text}`;case"whisper":return`(<font color='whisper'>[ <name shortname='${t.fromShort}' src='whisper-from'>${t.from}</name> whispers, "${t.message}" to you. ]</font>`;case"speech":return t.isSelf?`(<font color='myspeech'>You say, "${t.message}"</font>`:`(<name shortname='${t.fromShort}'>${t.from}</name>: ${t.message}`;case"emote":return`(<font color='emote'><name shortname='${t.fromShort}'>${t.from}</name> ${t.message}</font>`;case"roll":return`(<font color='roll'><img src='fsh://system.fsh:101' alt='@roll' /><channel name='@roll' /> <name shortname='${t.fromShort}'>${t.from}</name> rolls ${t.message}</font>`;case"description":return`(<desc shortname='${t.shortname}' />&gt; ${t.description}`;case"set-avatar-info":return`]f${t.visualCode}${t.name.replace(/ /g,"|")}`;case"load-portrait":return`]&${t.uid}`;case"camera-sync":return`@${p(t.x,2)}${p(t.y,2)}`;case"add-avatar":return`<${n(t.uid,4)}${n(t.x,2)}${n(t.y,2)}${n(t.direction,1)}${n(t.pose,1)}${n(t.name.length,1)}${t.name}${t.colorCode}${n(0,1)}${n(t.afkTime,4)}${n(t.scale,1)}`;case"move-avatar":return`${t.moveType==="walk"?"/":"A"}${n(t.uid,4)}${n(t.x,2)}${n(t.y,2)}${n(t.direction,1)}${n(t.pose,1)}`;case"update-avatar-appearance":return`B${n(t.uid,4)}${n(t.direction,1)}${n(t.pose,1)}${t.colorCode}`;case"remove-object":return`C${n(t.uid,4)}`;case"delete-object":return`)${n(t.uid,4)}`;case"dragonroar":return`D${t.message}`;case"play-sound":return`!${n(t.soundId,1)}`;case"world-metadata":return`]W${n(t.wallDef,2)}${n(t.roofDef,2)}${n(t.floorDef,2)}${n(t.objDef,2)}${n(t.wallAlt,2)}${n(t.roofAlt,2)}${n(t.floorAlt,2)}${n(t.objAlt,2)}${n(t.regionThreshold,2)}`;case"load-dream":return`]q${t.map} ${t.patch}${t.modern?" modern":""}`;case"avatar-manifest":{let e="]M% ";for(const s of t.records){const r=Math.floor(s.id/220)<<1|0,a=s.id%220;e+=n(s.version,1),e+=n(0,1),e+=n(a,1),e+=n(r,1),e+=n(s.checksum,4)}return e}case"chat-buffer":return`]-${t.subType}${t.content}`;case"name-visibility":return`]G${t.visible?"0":"1"}`;case"play-music":return`]j${n(t.trackId,2)}`;case"set-tag":return`]s${n(t.tagType,2)}${n(t.tag.length,2)}${t.tag}`;case"dialog-box":return`]#${t.content}`;case"pounce-update":return`]?${t.data}`;case"set-offsets":return`]H${n(t.uid,4)}${n(t.yl,2)}${n(t.al,2)}`;case"set-scale":return`]_${n(t.uid,4)}${n(t.scale,1)}`;case"set-gloam":return`]O${n(t.uid,4)}${n(t.gloam,2)}`;case"batch-particle":return`]I${t.data}`;case"legacy-visual-effect":return`]v${p(t.x,2)}${p(t.y,2)}${String.fromCharCode(t.effectId)}`;case"update-map":return`${{floor:"1",wall:"2",item:">",region:"4",effect:"5",lighting:"E",ambience:"F"}[t.layer]}${t.data}`;case"login-ready":return"&";case"load-map-legacy":return`;${t.mapName}`;case"ds-variable":return`0${t.data}`;case"ds-string":return`3${t.data}`;case"ds-trigger-server":return`6${t.data}`;case"ds-trigger-client":return`7${t.data}`;case"ds-init":return`8${t.data}`;case"online-status":return`]%${t.online?"1":"0"}${t.name}`;case"unknown":return t.raw}}function K(t){switch(t.type){case"move":return`m ${t.direction}`;case"rotate":return t.direction==="left"?"<":">";case"look":return`l${n(t.x,2)}${n(t.y,2)}`;case"glook":return`glook ${t.name}`;case"speech":return`"${t.message}`;case"emote":return`:${t.message}`;case"whisper":return`wh ${t.exact?"%":""}${t.target} ${t.message}`;case"get":return"get";case"use":return"use";case"sit":return"sit";case"stand":return"stand";case"liedown":return"liedown";case"login":return`loginNG ${t.auth}`;case"ready":return"vascodagama";case"quit":return"quit";case"keep-alive":return"iamhere";case"set-desc":return`desc ${t.description}`;case"set-color":return`color ${t.data}`;case"costume":return`costume ${t.args}`;case"afk":return t.message?`afk ${t.message}`:"afk";case"unafk":return"unafk";case"ds-btn":return`dsbtn ${t.id}`;case"portrait-change":return"portrchng";case"check-online":return`onln ${t.name}`;case"unknown":return t.raw}}const b={parseServerCommand:k,parseClientCommand:V,createServerCommand:B,createClientCommand:K,unescape:t=>t.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#(\d+);/g,(e,s)=>String.fromCharCode(parseInt(s,10))),escape:t=>t.replace(/[&<>"']|[\u0080-\uFFFF]/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return"&#"+e.charCodeAt(0)+";"}}),base95Encode:p,base95Decode:y,base220Encode:n,base220Decode:o,getShortname:t=>{let e=t;return e=e.replace(/&(?:[Aa]grave|acute|circ|tilde|uml|ring)|AElig|aelig;/g,"a"),e=e.replace(/&[Cc]edil;/g,"c"),e=e.replace(/&[Ee]grave|acute|circ|uml;/g,"e"),e=e.replace(/&[Ii]grave|acute|circ|uml;/g,"i"),e=e.replace(/&ETH;/g,"d"),e=e.replace(/&[Nn]tilde;/g,"n"),e=e.replace(/&(?:[Oo]grave|acute|tilde|uml)|oslash|Ocirc|oric;/g,"o"),e=e.replace(/&[Uu]grave|acute|circ|uml;/g,"u"),e=e.replace(/&(?:[Yy]acute)|yuml;/g,"y"),e=e.replace(/&euro;/g,"e"),e=e.replace(/[^A-Za-z0-9]/g,""),e.toLowerCase()}};class z{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};_enabledState=!0;get enabled(){return this._enabledState}get isLoggedIn(){return this.core.isLoggedIn}get isConnected(){return this.core.isConnected}get playerPosition(){return this.core.playerX===null||this.core.playerY===null?null:{x:this.core.playerX,y:this.core.playerY}}_handlers={incoming:[],outgoing:[],loggedIn:[],connected:[],disconnected:[],ready:[],pause:[],load:[],unload:[],configure:[]};_readyFired=!1;send(e,s){this.enabled&&this.core.send(e,this.metadata.id,s)}inject(e,s){this.enabled&&this.core.inject(e,this.metadata.id,s)}reconnect(){this.enabled&&this.core.reconnect()}disable(){this.enabled&&(this._setEnabled(!1),this.core.notifyUpdate(this))}enable(){this.enabled||(this._setEnabled(!0),this.core.notifyUpdate(this))}notify(e,s){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}const r=b.escape(e),a=`[<b><i>f: ${b.escape(this.metadata.name)}</i></b>]`;this.core.notify(r,a,this.metadata.id,s)}rawNotify(e,s){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}this.core.notify(e,"",this.metadata.id,s)}onIncoming(e,s=0){this._handlers.incoming.push({cb:e,priority:s}),this.core.invalidateHandlers()}onOutgoing(e,s=0){this._handlers.outgoing.push({cb:e,priority:s}),this.core.invalidateHandlers()}onLoggedIn(e){this._handlers.loggedIn.push(e)}onConnected(e){this._handlers.connected.push(e)}onDisconnected(e){this._handlers.disconnected.push(e)}onReady(e){if(this._handlers.ready.push(e),this._readyFired)try{e()}catch(s){console.error(`[${this.metadata.name}] Ready Error (Late):`,s)}}onPause(e){this._handlers.pause.push(e)}onLoad(e){this._handlers.load.push(e)}onUnload(e){this._handlers.unload.push(e)}onConfigure(e){this._handlers.configure.push(e)}openModal(e){x({...e,pluginId:this.metadata.id})}closeModal(){P()}getModalPluginId(){const e=T(w);return e.isOpen?e.pluginId??null:null}setGameInput(e){this.core.setGameInput(e)}saveData(e,s){if(typeof localStorage>"u")return;const r=`furnarchy_plugin_${this.metadata.id}_${e}`;try{localStorage.setItem(r,JSON.stringify(s))}catch(a){console.error(`[${this.metadata.name}] Failed to save data:`,a)}}loadData(e){if(typeof localStorage>"u")return null;const s=`furnarchy_plugin_${this.metadata.id}_${e}`;try{const r=localStorage.getItem(s);return r?JSON.parse(r):null}catch(r){return console.error(`[${this.metadata.name}] Failed to load data:`,r),null}}expose(e){this.core.registerService(e,this.metadata.id)}use(e){return this.core.getService(e)}_setEnabled(e){this._enabledState!==e&&(this._enabledState=e,this.core.invalidateHandlers(),this._handlers.pause.forEach(s=>{try{s(!e)}catch(r){console.error(r)}}))}_notifyLoggedIn(e,s){this.enabled&&this._handlers.loggedIn.forEach(r=>{try{r(e,s)}catch(a){console.error(`[${this.metadata.name}] LoggedIn Error:`,a)}})}_notifyConnected(){this.enabled&&this._handlers.connected.forEach(e=>{try{e()}catch(s){console.error(`[${this.metadata.name}] Connected Error:`,s)}})}_notifyDisconnected(){this.enabled&&this._handlers.disconnected.forEach(e=>{try{e()}catch(s){console.error(`[${this.metadata.name}] Disconnected Error:`,s)}})}_notifyReady(){this._readyFired||(this._readyFired=!0,this._handlers.ready.forEach(e=>{try{e()}catch(s){console.error(`[${this.metadata.name}] Ready Error:`,s)}}))}_notifyLoad(){this._handlers.load.forEach(e=>{try{e(this.enabled)}catch(s){console.error(`[${this.metadata.name}] Load Error:`,s)}})}_notifyUnload(){this._handlers.unload.forEach(e=>{try{e()}catch(s){console.error(`[${this.metadata.name}] Unload Error:`,s)}})}_notifyConfigure(){this._handlers.configure.forEach(e=>{try{e()}catch(s){console.error(`[${this.metadata.name}] Configure Error:`,s)}})}}class J{version="0.16.4";plugins=[];services=new Map;utils=b;loadingPluginUrl=null;isLoggedIn=!1;isConnected=!1;characterName=null;characterUid=null;playerX=null;playerY=null;isReady=!1;_motdComplete=!1;listeners=[];gameInputEnabled=!0;_cachedIncoming=null;_cachedOutgoing=null;_gameDocument=null;constructor(){typeof document<"u"&&this.attachInputInterception(document)}attachInputInterception(e){this._gameDocument=e;const s=r=>{if(!this.gameInputEnabled){const a=r.target;if(a&&a.closest&&a.closest(".modal-window"))return;r.stopImmediatePropagation(),r.preventDefault()}};e.addEventListener("keydown",s,!0),e.addEventListener("keyup",s,!0),e.addEventListener("keypress",s,!0)}get clientHooks(){return this._gameDocument?.defaultView?.__CLIENT_HOOKS}setGameInput(e){this.gameInputEnabled=e,e&&this.focusGame()}focusGame(){if(this._gameDocument){const e=this._gameDocument.defaultView;e&&e.focus();const s=this._gameDocument.querySelector('#chatInput, #entry, input[type="text"], textarea');s&&s.focus()}}invalidateHandlers(){this._cachedIncoming=null,this._cachedOutgoing=null}start(){this.isReady||(this.isReady=!0,console.log("[Furnarchy] Starting plugins..."),this.plugins.forEach(e=>e._notifyReady()))}send(e,s,r){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,s,r){console.warn("[Furnarchy] inject() called before connection established",e)}reconnect(){this.clientHooks?.reconnect?(console.log("[Furnarchy] Triggering reconnect..."),this.clientHooks.reconnect()):console.warn("[Furnarchy] Reconnect not available.")}registerService(e,s){if(!e.name||!e.version){console.error("[Furnarchy] Service registration failed: Missing 'name' or 'version'",e);return}this.services.has(e.name)&&console.warn(`[Furnarchy] Service '${e.name}' is already registered. Overwriting.`),this.services.set(e.name,{service:e,providerId:s}),console.log(`[Furnarchy] Service registered: ${e.name} v${e.version} by ${s}`)}getService(e){const s=this.services.get(e);return s?s.service:null}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(s=>{try{s(e)}catch(r){console.error(r)}})}unloadPlugin(e){const s=this.plugins.findIndex(a=>a.metadata.id===e);if(s===-1)return;const r=this.plugins[s];console.log(`[Furnarchy] Unloading plugin: ${r.metadata.name} (${e})`),r._notifyUnload(),this.plugins.splice(s,1),this.invalidateHandlers()}register(e,s){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(a=>a.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const r=new z(this);r.metadata={...r.metadata,...e},e.toggle&&r._setEnabled(!1),this.plugins.push(r);try{s(r),console.log(`[Furnarchy] Registered plugin: ${r.metadata.name} (${r.metadata.id})`)}catch(a){console.error("[Furnarchy] Error initializing plugin:",a)}this.notifyUpdate(r),r._notifyLoad(),this.isReady&&r._notifyReady()}_getSortedHandlers(e){if(e==="incoming"&&this._cachedIncoming)return this._cachedIncoming;if(e==="outgoing"&&this._cachedOutgoing)return this._cachedOutgoing;const s=[];for(const r of this.plugins){const a=e==="incoming"?r._handlers.incoming:r._handlers.outgoing;for(const i of a)s.push({...i,plugin:r})}return s.sort((r,a)=>a.priority-r.priority),e==="incoming"?this._cachedIncoming=s:this._cachedOutgoing=s,s}async _processMessage(e,s,r,a){let i=s;const u=this._getSortedHandlers(e);for(const{cb:c,plugin:h}of u)try{const l=await c(i,r,a);if(l==null)return null;i=l}catch(l){const d=e.charAt(0).toUpperCase()+e.slice(1);console.error(`[${h.metadata.name}] ${d} Error:`,l)}return i}async processIncoming(e,s=null,r=null){if(!this._motdComplete)return e.includes("Dragonroar")&&(this._motdComplete=!0),e;const a=k(e);if(a.type!=="world-metadata"){if(a.type==="set-user-info")this.notifyLoggedIn(a.name,a.uid.toString());else if(this.characterUid){const i=parseInt(this.characterUid,10);a.type==="add-avatar"&&a.uid===i?(this.playerX=a.x,this.playerY=a.y):a.type==="move-avatar"&&a.uid===i&&(this.playerX=a.x,this.playerY=a.y)}}return this._processMessage("incoming",e,s,r)}async processOutgoing(e,s=null,r=null){return e==="finfo"?(this.showInfo(),null):this._processMessage("outgoing",e,s,r)}showInfo(){const e=[`${this.utils.escape("âš¡")} Furnarchy Zero v${this.version}`];this.isLoggedIn?e.push(`${this.utils.escape("ðŸ‘¤")} User: ${this.characterName} (${this.characterUid})`):e.push(`${this.utils.escape("ðŸ‘¤")} User: Not logged in`),e.push(`${this.utils.escape("ðŸ”Œ")} Plugins: ${this.plugins.length} (${this.plugins.filter(s=>s.enabled).length} enabled)`),this.plugins.forEach(s=>{const r=s.enabled?this.utils.escape("âœ…"):this.utils.escape("ðŸ’¤");e.push(`  - ${r} ${this.utils.escape(s.metadata.name)} v${s.metadata.version}`)}),typeof window<"u"&&e.push(`${this.utils.escape("ðŸ–¥ï¸")} Viewport: ${window.innerWidth}x${window.innerHeight}`),e.forEach(s=>this.notify(s))}notify(e,s="[<b><i>f</i></b>]",r,a){this.clientHooks?.appendChat?this.clientHooks.appendChat(`${s?`${s} `:""}${e}`):this.inject(`(${this.utils.escape(s)} ${e}`,r,a)}notifyLoggedIn(e,s){this.isLoggedIn=!0,this.characterName=e,this.characterUid=s,console.log(`[Furnarchy] User logged in as ${e} (${s}), notifying plugins...`),this.plugins.forEach(r=>r._notifyLoggedIn(e,s))}notifyConnected(){this.isConnected=!0,console.log("[Furnarchy] Connected to server, notifying plugins..."),this._motdComplete=!1,this.plugins.forEach(e=>e._notifyConnected())}notifyDisconnected(){this.isLoggedIn=!1,this.isConnected=!1,this.playerX=null,this.playerY=null,console.log("[Furnarchy] Disconnected from server, notifying plugins..."),this.plugins.forEach(e=>e._notifyDisconnected())}getExposedAPI(){return{register:this.register.bind(this),version:this.version,utils:this.utils}}}const st=new J;export{J as F,tt as a,P as c,st as f,Q as h,w as m,et as t};
