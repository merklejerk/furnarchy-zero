import{V as se,m as _,W as le,a as Y,b as fe,Y as ce,Z as ue,_ as H,$ as V,a0 as M,R as L,ad as de,aO as ve,aw as ge,J as k,Q as x,O as z,U as he,a3 as me,ao as F,aM as W,aP as G,aQ as _e,K as Z,N as pe,aR as Se,aS as ye,aT as P,ae as Ee,aU as be,aV as Ie,aL as Ne,M as we,q as Te,aW as ke,aX as Ae,aY as Oe,aZ as Le,a_ as Me,a$ as B,ai as Pe,u as Q,r as X,b0 as Ce,af as Ue}from"./WP6s4_OC.js";import{a as Re}from"./abs61YEE.js";function Qe(e,r){return r}function xe(e,r,t){for(var l=[],o=r.length,a=0;a<o;a++)be(r[a].e,l,!0);Ie(l,()=>{var i=l.length===0&&t!==null;if(i){var n=t,c=n.parentNode;Ne(c),c.append(n),e.items.clear(),m(e,r[0].prev,r[o-1].next)}for(var s=0;s<o;s++){var u=r[s];i||(e.items.delete(u.k),m(e,u.prev,u.next)),we(u.e,!i)}e.first===r[0]&&(e.first=r[0].prev)})}function Xe(e,r,t,l,o,a=null){var i=e,n=new Map,c=null;_&&le();var s=null,u=fe(()=>{var h=t();return G(h)?h:h==null?[]:W(h)}),d,g=!0;function p(){De(v,d,i,r,l),s!==null&&(d.length===0?(s.fragment?(i.before(s.fragment),s.fragment=null):Z(s.effect),f.first=s.effect):pe(s.effect,()=>{s=null}))}var f=se(()=>{d=Y(u);var h=d.length;let b=!1;if(_){var S=ce(i)===ue;S!==(h===0)&&(i=H(),V(i),M(!1),b=!0)}for(var A=new Set,I=k,w=null,T=he(),E=0;E<h;E+=1){_&&L.nodeType===de&&L.data===ve&&(i=L,b=!0,M(!1));var O=d[E],N=l(O,E),y=g?null:n.get(N);y?(ge(y.v,O),y.i=E,T&&I.skipped_effects.delete(y.e)):(y=$e(g?i:null,w,O,N,E,o,r,t),g&&(y.o=!0,w===null?c=y:w.next=y,w=y),n.set(N,y)),A.add(N)}if(h===0&&a&&!s)if(g)s={fragment:null,effect:x(()=>a(i))};else{var $=document.createDocumentFragment(),J=z();$.append(J),s={fragment:$,effect:x(()=>a(J))}}if(_&&h>0&&V(H()),!g)if(T){for(const[oe,ie]of n)A.has(oe)||I.skipped_effects.add(ie.e);I.oncommit(p),I.ondiscard(()=>{})}else p();b&&M(!0),Y(u)}),v={effect:f,items:n,first:c};g=!1,_&&(i=L)}function De(e,r,t,l,o){var a=r.length,i=e.items,n=e.first,c,s=null,u=[],d=[],g,p,f,v;for(v=0;v<a;v+=1){if(g=r[v],p=o(g,v),f=i.get(p),e.first??=f,!f.o){f.o=!0;var h=s?s.next:n;m(e,s,f),m(e,f,h),C(f,h,t),s=f,u=[],d=[],n=s.next;continue}if((f.e.f&P)!==0&&Z(f.e),f!==n){if(c!==void 0&&c.has(f)){if(u.length<d.length){var b=d[0],S;s=b.prev;var A=u[0],I=u[u.length-1];for(S=0;S<u.length;S+=1)C(u[S],b,t);for(S=0;S<d.length;S+=1)c.delete(d[S]);m(e,A.prev,I.next),m(e,s,A),m(e,I,b),n=b,s=I,v-=1,u=[],d=[]}else c.delete(f),C(f,n,t),m(e,f.prev,f.next),m(e,f,s===null?e.first:s.next),m(e,s,f),s=f;continue}for(u=[],d=[];n!==null&&n.k!==p;)(n.e.f&P)===0&&(c??=new Set).add(n),d.push(n),n=n.next;if(n===null)continue;f=n}u.push(f),s=f,n=f.next}let w=i.size>a;if(n!==null||c!==void 0){for(var T=c===void 0?[]:W(c);n!==null;)(n.e.f&P)===0&&T.push(n),n=n.next;var E=T.length;if(w=i.size-E>a,E>0){var O=null;xe(e,T,O)}}if(w)for(const N of i.values())N.o||(m(e,s,N),s=N);e.effect.last=s&&s.e}function $e(e,r,t,l,o,a,i,n){var c=(i&Se)!==0,s=(i&ye)===0,u=c?s?me(t,!1,!1):F(t):t,d=(i&_e)===0?o:F(o),g={i:d,v:u,k:l,a:null,e:null,o:!1,prev:r,next:null};try{if(e===null){var p=document.createDocumentFragment();p.append(e=z())}return g.e=x(()=>a(e,u,d,n)),r!==null&&(r.next=g),g}finally{}}function C(e,r,t){for(var l=e.next?e.next.e.nodes_start:t,o=r?r.e.nodes_start:t,a=e.e.nodes_start;a!==null&&a!==l;){var i=Ee(a);o.before(a),a=i}}function m(e,r,t){r===null?(e.first=t,e.effect.first=t&&t.e):(r.e.next&&(r.e.next.prev=null),r.next=t,r.e.next=t&&t.e),t!==null&&(t.e.prev&&(t.e.prev.next=null),t.prev=r,t.e.prev=r&&r.e)}function je(e,r,t,l,o,a){var i=e.__className;if(_||i!==t||i===void 0){var n=Re(t,l,a);(!_||n!==e.getAttribute("class"))&&(n==null?e.removeAttribute("class"):e.className=n),e.__className=t}else if(a&&o!==a)for(var c in a){var s=!!a[c];(o==null||s!==!!o[c])&&e.classList.toggle(c,s)}return a}const Je=Symbol("is custom element"),Ye=Symbol("is html");function er(e){if(_){var r=!1,t=()=>{if(!r){if(r=!0,e.hasAttribute("value")){var l=e.value;q(e,"value",null),e.value=l}if(e.hasAttribute("checked")){var o=e.checked;q(e,"checked",null),e.checked=o}}};e.__on_r=t,Te(t),ke()}}function q(e,r,t,l){var o=He(e);_&&(o[r]=e.getAttribute(r),r==="src"||r==="srcset"||r==="href"&&e.nodeName==="LINK")||o[r]!==(o[r]=t)&&(r==="loading"&&(e[Ae]=t),t==null?e.removeAttribute(r):typeof t!="string"&&Ve(e).includes(r)?e[r]=t:e.setAttribute(r,t))}function He(e){return e.__attributes??={[Je]:e.nodeName.includes("-"),[Ye]:e.namespaceURI===Oe}}var K=new Map;function Ve(e){var r=e.getAttribute("is")||e.nodeName,t=K.get(r);if(t)return t;K.set(r,t=[]);for(var l,o=e,a=Element.prototype;a!==o;){l=Me(o);for(var i in l)l[i].set&&t.push(i);o=Le(o)}return t}function rr(e,r,t=r){var l=new WeakSet;B(e,"input",async o=>{var a=o?e.defaultValue:e.value;if(a=U(e)?R(a):a,t(a),k!==null&&l.add(k),await Pe(),a!==(a=r())){var i=e.selectionStart,n=e.selectionEnd,c=e.value.length;if(e.value=a??"",n!==null){var s=e.value.length;i===n&&n===c&&s>c?(e.selectionStart=s,e.selectionEnd=s):(e.selectionStart=i,e.selectionEnd=Math.min(n,s))}}}),(_&&e.defaultValue!==e.value||Q(r)==null&&e.value)&&(t(U(e)?R(e.value):e.value),k!==null&&l.add(k)),X(()=>{var o=r();if(e===document.activeElement){var a=Ce??k;if(l.has(a))return}U(e)&&o===R(e.value)||e.type==="date"&&!o&&!e.value||o!==e.value&&(e.value=o??"")})}function tr(e,r,t=r){B(e,"change",l=>{var o=l?e.defaultChecked:e.checked;t(o)}),(_&&e.defaultChecked!==e.checked||Q(r)==null)&&t(e.checked),X(()=>{var l=r();e.checked=!!l})}function U(e){var r=e.type;return r==="number"||r==="range"}function R(e){return e===""?null:+e}function nr(e){return function(...r){var t=r[0];return t.stopPropagation(),e?.apply(this,r)}}function ar(e,r){var t=e.$$events?.[r.type],l=G(t)?t.slice():t==null?[]:[t];for(var o of l)o.call(this,r)}const or=globalThis.__sveltekit_12vi4eo.env;async function Fe(e){let r;try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}`);r=await t.text()}catch(t){throw new Error(`Failed to fetch plugin: ${t.message}`)}return new Promise((t,l)=>{const o=Math.random().toString(36).substring(7),a=document.createElement("iframe");a.style.display="none",a.setAttribute("sandbox","allow-scripts");let i;const n=()=>{i&&clearTimeout(i),window.removeEventListener("message",c),document.body.contains(a)&&document.body.removeChild(a)},c=p=>{const f=p.data;if(!f||f.type!=="furnarchy-plugin-register"||f.requestId!==o)return;const v=f.plugin;if(!v.id||!v.name||!v.version){n(),l(new Error("Plugin registered but missing id, name, or version"));return}t({id:v.id,name:v.name,description:v.description,version:v.version,author:v.author,sourceUrl:e,toggle:v.toggle}),n()};window.addEventListener("message",c);const s=`
            window.Furnarchy = {
                version: '0.0.0-sandbox',
                loadingPluginUrl: ${JSON.stringify(e)},
                register: function(meta, arg) {
                    if (typeof arg === 'function') {
                        // Send metadata immediately
                        window.parent.postMessage({
                            type: 'furnarchy-plugin-register',
                            requestId: '${o}',
                            plugin: meta
                        }, '*');

                        const api = {
                            send: function() {},
                            inject: function() {},
                            notify: function() {},
                            disable: function() {},
                            onIncoming: function() {},
                            onOutgoing: function() {},
                            onLoggedIn: function() {},
                            onPause: function() {},
                            onLoad: function() {}
                        };
                        try { arg(api); } catch(e) {}
                    }
                },
                onRegister: function() {},
                send: function() {}
            };
        `,d=`
            try {
                const content = decodeURIComponent(escape(atob('${btoa(unescape(encodeURIComponent(r)))}')));
                const script = document.createElement('script');
                script.textContent = content;
                document.body.appendChild(script);
            } catch(e) {
                console.error('Sandbox execution error:', e);
            }
        `,g=`
            <!DOCTYPE html>
            <html>
            <head>
                <script>${s}<\/script>
            </head>
            <body>
                <script>${d}<\/script>
            </body>
            </html>
        `;a.srcdoc=g,document.body.appendChild(a),i=setTimeout(()=>{n(),l(new Error("Plugin load timed out (5s) - did not call Furnarchy.register()?"))},5e3)})}const qe=["/plugins/life-support.js","/plugins/auto-spinner.js","/plugins/wire-shrek.js"],D="furnarchy_plugins",j="furnarchy_deleted_plugins",ee="furnarchy_auth_url",re="furnarchy_version",te="furnarchy_zoom_settings",ne=Ue([]);function ir(){if(typeof localStorage>"u")return{zoomLevel:1.5,fitWidth:!1};const e=localStorage.getItem(te);if(!e)return{zoomLevel:1.5,fitWidth:!1};try{return JSON.parse(e)}catch{return{zoomLevel:1.5,fitWidth:!1}}}function sr(e){typeof localStorage>"u"||localStorage.setItem(te,JSON.stringify(e))}function ae(){if(typeof localStorage>"u")return[];const e=localStorage.getItem(j);if(!e)return[];try{return JSON.parse(e)}catch{return[]}}function lr(e){if(typeof localStorage>"u")return;const r=ae();r.includes(e)||(r.push(e),localStorage.setItem(j,JSON.stringify(r)))}function Ke(){if(typeof localStorage>"u")return[];const e=localStorage.getItem(D);if(!e)return[];try{const r=JSON.parse(e);return Array.isArray(r)?r.map(t=>typeof t=="string"?{url:t}:t):[]}catch(r){return console.error("Failed to load plugins",r),[]}}function ze(e){typeof localStorage>"u"||(localStorage.setItem(D,JSON.stringify(e)),ne.set(e))}function fr(e,r){ne.update(t=>{const l=t.findIndex(n=>n.url===e);if(l===-1)return t;const o=t[l],a={...o,...r};if(JSON.stringify(o)===JSON.stringify(a))return t;const i=[...t];return i[l]=a,typeof localStorage<"u"&&localStorage.setItem(D,JSON.stringify(i)),i})}function cr(){return typeof localStorage>"u"?null:localStorage.getItem(ee)}function ur(e){typeof localStorage>"u"||localStorage.setItem(ee,e)}function We(){return typeof localStorage>"u"?null:localStorage.getItem(re)}function Ge(e){typeof localStorage>"u"||localStorage.setItem(re,e)}async function dr(e){if(typeof localStorage>"u")return;const r=We();let t=Ke();const l=ae();let o=!1;const a=[...qe];for(const i of a)if(!t.some(n=>n.url===i))try{const n=await Fe(i);if(l.includes(n.id)){console.log(`Skipping deleted default plugin: ${n.name} (${n.id})`);continue}t.push({id:n.id,url:i,name:n.name,description:n.description,version:n.version,author:n.author,enabled:typeof n.toggle=="boolean"?!n.toggle:!0}),o=!0}catch(n){console.error(`Failed to load default plugin ${i}:`,n)}o&&ze(t),r!==e&&Ge(e)}export{cr as a,rr as b,or as c,q as d,Xe as e,nr as f,Ke as g,ze as h,Qe as i,ur as j,ar as k,dr as l,lr as m,ir as n,sr as o,ne as p,tr as q,er as r,je as s,fr as u,Fe as v};
