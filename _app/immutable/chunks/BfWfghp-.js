import{b as ae,h as S,l as ie,x as D,az as se,n as oe,o as le,q as Y,d as J,s as U,e as L,C as ce,at as ue,af as fe,f as P,j as x,c as G,k as de,w as ge,a5 as V,ar as j,aM as B,aN as he,r as W,p as ve,aO as _e,aP as pe,aQ as M,a as me,aR as ye,aS as Se,aq as be,i as Ee,a8 as Ie,aT as we,aU as Ne,aV as Ae,aW as Pe,aX as Te,aY as Oe,aK as Le,D as Ue,a6 as Me,aZ as Ce}from"./Cg5NIOCX.js";import{w as ke}from"./Db6ANrXm.js";function Xe(n,e){return e}function $e(n,e,t){for(var r=[],i=e.length,s=0;s<i;s++)ye(e[s].e,r,!0);Se(r,()=>{var o=r.length===0&&t!==null;if(o){var a=t,u=a.parentNode;be(u),u.append(a),n.items.clear(),_(n,e[0].prev,e[i-1].next)}for(var l=0;l<i;l++){var f=e[l];o||(n.items.delete(f.k),_(n,f.prev,f.next)),Ee(f.e,!o)}n.first===e[0]&&(n.first=e[0].prev)})}function Qe(n,e,t,r,i,s=null){var o=n,a=new Map,u=null;S&&ie();var l=null,f=se(()=>{var v=t();return B(v)?v:v==null?[]:j(v)}),d,h=!0;function p(){xe(g,d,o,e,r),l!==null&&(d.length===0?(l.fragment?(o.before(l.fragment),l.fragment=null):W(l.effect),c.first=l.effect):ve(l.effect,()=>{l=null}))}var c=ae(()=>{d=D(f);var v=d.length;let E=!1;if(S){var m=oe(o)===le;m!==(v===0)&&(o=Y(),J(o),U(!1),E=!0)}for(var T=new Set,I=P,N=null,A=de(),b=0;b<v;b+=1){S&&L.nodeType===ce&&L.data===ue&&(o=L,E=!0,U(!1));var O=d[b],w=r(O,b),y=h?null:a.get(w);y?(fe(y.v,O),y.i=b,A&&I.skipped_effects.delete(y.e)):(y=Fe(h?o:null,N,O,w,b,i,e,t),h&&(y.o=!0,N===null?u=y:N.next=y,N=y),a.set(w,y)),T.add(w)}if(v===0&&s&&!l)if(h)l={fragment:null,effect:x(()=>s(o))};else{var H=document.createDocumentFragment(),R=G();H.append(R),l={fragment:H,effect:x(()=>s(R))}}if(S&&v>0&&J(Y()),!h)if(A){for(const[te,re]of a)T.has(te)||I.skipped_effects.add(re.e);I.oncommit(p),I.ondiscard(()=>{})}else p();E&&U(!0),D(f)}),g={effect:c,items:a,first:u};h=!1,S&&(o=L)}function xe(n,e,t,r,i){var s=e.length,o=n.items,a=n.first,u,l=null,f=[],d=[],h,p,c,g;for(g=0;g<s;g+=1){if(h=e[g],p=i(h,g),c=o.get(p),n.first??=c,!c.o){c.o=!0;var v=l?l.next:a;_(n,l,c),_(n,c,v),C(c,v,t),l=c,f=[],d=[],a=l.next;continue}if((c.e.f&M)!==0&&W(c.e),c!==a){if(u!==void 0&&u.has(c)){if(f.length<d.length){var E=d[0],m;l=E.prev;var T=f[0],I=f[f.length-1];for(m=0;m<f.length;m+=1)C(f[m],E,t);for(m=0;m<d.length;m+=1)u.delete(d[m]);_(n,T.prev,I.next),_(n,l,T),_(n,I,E),a=E,l=I,g-=1,f=[],d=[]}else u.delete(c),C(c,a,t),_(n,c.prev,c.next),_(n,c,l===null?n.first:l.next),_(n,l,c),l=c;continue}for(f=[],d=[];a!==null&&a.k!==p;)(a.e.f&M)===0&&(u??=new Set).add(a),d.push(a),a=a.next;if(a===null)continue;c=a}f.push(c),l=c,a=c.next}let N=o.size>s;if(a!==null||u!==void 0){for(var A=u===void 0?[]:j(u);a!==null;)(a.e.f&M)===0&&A.push(a),a=a.next;var b=A.length;if(N=o.size-b>s,b>0){var O=null;$e(n,A,O)}}if(N)for(const w of o.values())w.o||(_(n,l,w),l=w);n.effect.last=l&&l.e}function Fe(n,e,t,r,i,s,o,a){var u=(o&_e)!==0,l=(o&pe)===0,f=u?l?ge(t,!1,!1):V(t):t,d=(o&he)===0?i:V(i),h={i:d,v:f,k:r,a:null,e:null,o:!1,prev:e,next:null};try{if(n===null){var p=document.createDocumentFragment();p.append(n=G())}return h.e=x(()=>s(n,f,d,a)),e!==null&&(e.next=h),h}finally{}}function C(n,e,t){for(var r=n.next?n.next.e.nodes_start:t,i=e?e.e.nodes_start:t,s=n.e.nodes_start;s!==null&&s!==r;){var o=me(s);i.before(s),s=o}}function _(n,e,t){e===null?(n.first=t,n.effect.first=t&&t.e):(e.e.next&&(e.e.next.prev=null),e.next=t,e.e.next=t&&t.e),t!==null&&(t.e.prev&&(t.e.prev.next=null),t.prev=e,t.e.prev=e&&e.e)}const q=[...` 	
\r\fÂ \v\uFEFF`];function He(n,e,t){var r=n==null?"":""+n;if(t){for(var i in t)if(t[i])r=r?r+" "+i:i;else if(r.length)for(var s=i.length,o=0;(o=r.indexOf(i,o))>=0;){var a=o+s;(o===0||q.includes(r[o-1]))&&(a===r.length||q.includes(r[a]))?r=(o===0?"":r.substring(0,o))+r.substring(a+1):o=a}}return r===""?null:r}function Ze(n,e,t,r,i,s){var o=n.__className;if(S||o!==t||o===void 0){var a=He(t,r,s);(!S||a!==n.getAttribute("class"))&&(a==null?n.removeAttribute("class"):n.className=a),n.__className=t}else if(s&&i!==s)for(var u in s){var l=!!s[u];(i==null||l!==!!i[u])&&n.classList.toggle(u,l)}return s}const Re=Symbol("is custom element"),De=Symbol("is html");function en(n){if(S){var e=!1,t=()=>{if(!e){if(e=!0,n.hasAttribute("value")){var r=n.value;K(n,"value",null),n.value=r}if(n.hasAttribute("checked")){var i=n.checked;K(n,"checked",null),n.checked=i}}};n.__on_r=t,Ie(t),we()}}function K(n,e,t,r){var i=Ye(n);S&&(i[e]=n.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&n.nodeName==="LINK")||i[e]!==(i[e]=t)&&(e==="loading"&&(n[Ne]=t),t==null?n.removeAttribute(e):typeof t!="string"&&Je(n).includes(e)?n[e]=t:n.setAttribute(e,t))}function Ye(n){return n.__attributes??={[Re]:n.nodeName.includes("-"),[De]:n.namespaceURI===Ae}}var z=new Map;function Je(n){var e=n.getAttribute("is")||n.nodeName,t=z.get(e);if(t)return t;z.set(e,t=[]);for(var r,i=n,s=Element.prototype;s!==i;){r=Te(i);for(var o in r)r[o].set&&t.push(o);i=Pe(i)}return t}function nn(n,e,t=e){var r=new WeakSet;Oe(n,"input",async i=>{var s=i?n.defaultValue:n.value;if(s=k(n)?$(s):s,t(s),P!==null&&r.add(P),await Le(),s!==(s=e())){var o=n.selectionStart,a=n.selectionEnd,u=n.value.length;if(n.value=s??"",a!==null){var l=n.value.length;o===a&&a===u&&l>u?(n.selectionStart=l,n.selectionEnd=l):(n.selectionStart=o,n.selectionEnd=Math.min(a,l))}}}),(S&&n.defaultValue!==n.value||Ue(e)==null&&n.value)&&(t(k(n)?$(n.value):n.value),P!==null&&r.add(P)),Me(()=>{var i=e();if(n===document.activeElement){var s=Ce??P;if(r.has(s))return}k(n)&&i===$(n.value)||n.type==="date"&&!i&&!n.value||i!==n.value&&(n.value=i??"")})}function k(n){var e=n.type;return e==="number"||e==="range"}function $(n){return n===""?null:+n}function tn(n){return function(...e){var t=e[0];return t.stopPropagation(),n?.apply(this,e)}}function rn(n,e){var t=n.$$events?.[e.type],r=B(t)?t.slice():t==null?[]:[t];for(var i of r)i.call(this,e)}const an=globalThis.__sveltekit_owr9rp.env;async function Ve(n){let e;try{const t=await fetch(n);if(!t.ok)throw new Error(`HTTP ${t.status}`);e=await t.text()}catch(t){throw new Error(`Failed to fetch plugin: ${t.message}`)}return new Promise((t,r)=>{const i=Math.random().toString(36).substring(7),s=document.createElement("iframe");s.style.display="none",s.setAttribute("sandbox","allow-scripts");let o;const a=()=>{o&&clearTimeout(o),window.removeEventListener("message",u),document.body.contains(s)&&document.body.removeChild(s)},u=p=>{const c=p.data;if(!c||c.type!=="furnarchy-plugin-register"||c.requestId!==i)return;const g=c.plugin;if(!g.id||!g.name||!g.version){a(),r(new Error("Plugin registered but missing id, name, or version"));return}t({id:g.id,name:g.name,description:g.description,version:g.version,author:g.author,sourceUrl:n,toggle:g.toggle}),a()};window.addEventListener("message",u);const l=`
            window.Furnarchy = {
                version: '0.0.0-sandbox',
                loadingPluginUrl: ${JSON.stringify(n)},
                register: function(meta, arg) {
                    if (typeof arg === 'function') {
                        // Send metadata immediately
                        window.parent.postMessage({
                            type: 'furnarchy-plugin-register',
                            requestId: '${i}',
                            plugin: meta
                        }, '*');

                        const api = {
                            send: function() {},
                            inject: function() {},
                            notify: function() {},
                            disable: function() {},
                            onIncoming: function() {},
                            onOutgoing: function() {},
                            onLoggedIn: function() {},
                            onPause: function() {},
                            onLoad: function() {}
                        };
                        try { arg(api); } catch(e) {}
                    }
                },
                onRegister: function() {},
                send: function() {}
            };
        `,d=`
            try {
                const content = decodeURIComponent(escape(atob('${btoa(unescape(encodeURIComponent(e)))}')));
                const script = document.createElement('script');
                script.textContent = content;
                document.body.appendChild(script);
            } catch(e) {
                console.error('Sandbox execution error:', e);
            }
        `,h=`
            <!DOCTYPE html>
            <html>
            <head>
                <script>${l}<\/script>
            </head>
            <body>
                <script>${d}<\/script>
            </body>
            </html>
        `;s.srcdoc=h,document.body.appendChild(s),o=setTimeout(()=>{a(),r(new Error("Plugin load timed out (5s) - did not call Furnarchy.register()?"))},5e3)})}const F="furnarchy_plugins",X="furnarchy_deleted_plugins",Q="furnarchy_auth_url",Z="furnarchy_version",ee=ke([]);function ne(){if(typeof localStorage>"u")return[];const n=localStorage.getItem(X);if(!n)return[];try{return JSON.parse(n)}catch{return[]}}function sn(n){if(typeof localStorage>"u")return;const e=ne();e.includes(n)||(e.push(n),localStorage.setItem(X,JSON.stringify(e)))}function qe(){if(typeof localStorage>"u")return[];const n=localStorage.getItem(F);if(!n)return[];try{const e=JSON.parse(n);return Array.isArray(e)?e.map(t=>typeof t=="string"?{url:t}:t):[]}catch(e){return console.error("Failed to load plugins",e),[]}}function Ke(n){typeof localStorage>"u"||(localStorage.setItem(F,JSON.stringify(n)),ee.set(n))}function on(n,e){ee.update(t=>{const r=t.findIndex(a=>a.url===n);if(r===-1)return t;const i=t[r],s={...i,...e};if(JSON.stringify(i)===JSON.stringify(s))return t;const o=[...t];return o[r]=s,typeof localStorage<"u"&&localStorage.setItem(F,JSON.stringify(o)),o})}function ln(){return typeof localStorage>"u"?null:localStorage.getItem(Q)}function cn(n){typeof localStorage>"u"||localStorage.setItem(Q,n)}function ze(){return typeof localStorage>"u"?null:localStorage.getItem(Z)}function Ge(n){typeof localStorage>"u"||localStorage.setItem(Z,n)}async function un(n){if(typeof localStorage>"u")return;const e=ze();let t=qe();const r=["/plugins/auto-spinner.js","/plugins/wire-shrek.js"],i=ne();let s=!1;for(const o of r)if(!t.some(a=>a.url===o))try{const a=await Ve(o);if(i.includes(a.id)){console.log(`Skipping deleted default plugin: ${a.name} (${a.id})`);continue}t.push({id:a.id,url:o,name:a.name,description:a.description,version:a.version,author:a.author,enabled:typeof a.toggle=="boolean"?!a.toggle:!0}),s=!0}catch(a){console.error(`Failed to load default plugin ${o}:`,a)}s&&Ke(t),e!==n&&Ge(n)}class je{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};_enabledState=!0;get enabled(){return this._enabledState}_handlers={incoming:[],outgoing:[],loggedIn:[],pause:[],load:[]};send(e,t){this.enabled&&this.core.send(e,t,this.metadata.id)}inject(e,t){this.enabled&&this.core.inject(e,t,this.metadata.id)}disable(){this.enabled&&(this._setEnabled(!1),this.core.notifyUpdate(this))}notify(e,t){this.inject(`([ðŸŸ¢] ${e}
`,t)}onIncoming(e,t=0){this._handlers.incoming.push({cb:e,priority:t}),this.core.invalidateHandlers()}onOutgoing(e,t=0){this._handlers.outgoing.push({cb:e,priority:t}),this.core.invalidateHandlers()}onLoggedIn(e){this._handlers.loggedIn.push(e)}onPause(e){this._handlers.pause.push(e)}onLoad(e){this._handlers.load.push(e)}_setEnabled(e){this._enabledState!==e&&(this._enabledState=e,this.core.invalidateHandlers(),this._handlers.pause.forEach(t=>{try{t(!e)}catch(r){console.error(r)}}))}_notifyLoggedIn(){this.enabled&&this._handlers.loggedIn.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] LoggedIn Error:`,t)}})}_notifyLoad(){this._handlers.load.forEach(e=>{try{e(this.enabled)}catch(t){console.error(`[${this.metadata.name}] Load Error:`,t)}})}}class fn{version="0.3.0";plugins=[];loadingPluginUrl=null;listeners=[];_cachedIncoming=null;_cachedOutgoing=null;invalidateHandlers(){this._cachedIncoming=null,this._cachedOutgoing=null}send(e,t,r){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,t,r){console.warn("[Furnarchy] inject() called before connection established",e)}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(t=>{try{t(e)}catch(r){console.error(r)}})}register(e,t){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(i=>i.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const r=new je(this);r.metadata={...r.metadata,...e},e.toggle&&r._setEnabled(!1),this.plugins.push(r);try{t(r),console.log(`[Furnarchy] Registered plugin: ${r.metadata.name} (${r.metadata.id})`)}catch(i){console.error("[Furnarchy] Error initializing plugin:",i)}this.notifyUpdate(r),r._notifyLoad()}_getSortedHandlers(e){if(e==="incoming"&&this._cachedIncoming)return this._cachedIncoming;if(e==="outgoing"&&this._cachedOutgoing)return this._cachedOutgoing;const t=[];for(const r of this.plugins){if(!r.enabled)continue;const i=e==="incoming"?r._handlers.incoming:r._handlers.outgoing;for(const s of i)t.push({...s,plugin:r})}return t.sort((r,i)=>i.priority-r.priority),e==="incoming"?this._cachedIncoming=t:this._cachedOutgoing=t,t}async _processMessage(e,t,r,i){let s=t;const o=this._getSortedHandlers(e);for(const{cb:a,plugin:u}of o)try{const l=await a(s,i,r);if(l==null)return null;s=l}catch(l){const f=e.charAt(0).toUpperCase()+e.slice(1);console.error(`[${u.metadata.name}] ${f} Error:`,l)}return s}async processIncoming(e,t=null,r=null){return this._processMessage("incoming",e,t,r)}async processOutgoing(e,t=null,r=null){return this._processMessage("outgoing",e,t,r)}notifyLoggedIn(){console.log("[Furnarchy] User logged in, notifying plugins..."),this.plugins.forEach(e=>e._notifyLoggedIn())}}export{fn as F,ln as a,nn as b,an as c,K as d,Qe as e,tn as f,qe as g,Ke as h,Xe as i,cn as j,rn as k,un as l,sn as m,ee as p,en as r,Ze as s,on as u,Ve as v};
