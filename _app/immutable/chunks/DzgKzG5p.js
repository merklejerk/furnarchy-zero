import{A as I,G as v,Z as b,C as d,_ as C,a0 as $,a1 as g,N as f,M as p,D as S,a2 as F,U as O}from"./B2BHS6mp.js";function U(r,e){let n=null,t=d;var i;if(d){n=S;for(var a=C(document.head);a!==null&&(a.nodeType!==$||a.data!==r);)a=g(a);if(a===null)f(!1);else{var s=g(a);a.remove(),p(s)}}d||(i=document.head.appendChild(I()));try{v(()=>e(i),b)}finally{t&&(f(!0),p(n))}}const m=[...` 	
\r\fÂ \v\uFEFF`];function H(r,e,n){var t=r==null?"":""+r;if(n){for(var i in n)if(n[i])t=t?t+" "+i:i;else if(t.length)for(var a=i.length,s=0;(s=t.indexOf(i,s))>=0;){var o=s+a;(s===0||m.includes(t[s-1]))&&(o===t.length||m.includes(t[o]))?t=(s===0?"":t.substring(0,s))+t.substring(o+1):s=o}}return t===""?null:t}function y(r,e=!1){var n=e?" !important;":";",t="";for(var i in r){var a=r[i];a!=null&&a!==""&&(t+=" "+i+": "+a+n)}return t}function P(r,e){if(e){var n="",t,i;return Array.isArray(e)?(t=e[0],i=e[1]):t=e,t&&(n+=y(t)),i&&(n+=y(i,!0)),n=n.trim(),n===""?null:n}return String(r)}const h={isOpen:!1,title:"",body:"",onClose:void 0},u=F(h);function L(r){u.update(e=>({...h,...r,isOpen:!0}))}function w(){u.update(r=>{if(r.isOpen&&r.onClose)try{r.onClose()}catch(e){console.error("Error in modal onClose handler:",e)}return{...h}})}const l={escape:r=>r.replace(/[&<>"']|[\u0080-\uFFFF]/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return"&#"+e.charCodeAt(0)+";"}}),base95Encode:(r,e=0)=>{let n="";do{const t=r%95;r=Math.floor(r/95),n=String.fromCharCode(t+32)+n}while(r>0||n.length<e);return n},base95Decode:r=>{let e=0;for(let n=0;n<r.length;n++)e=e*95+(r.charCodeAt(n)-32);return e},base220Encode:(r,e=0)=>{let n="";do{const t=r%220;r=Math.floor(r/220);const i=t+35;n=n+String.fromCharCode(i)}while(r>0||n.length<e);return n},base220Decode:r=>{let e=0,n=1;for(let t=0;t<r.length;t++){const i=r.charCodeAt(t);e+=(i-35)*n,n*=220}return e}};class M{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};_enabledState=!0;get enabled(){return this._enabledState}_handlers={incoming:[],outgoing:[],loggedIn:[],connected:[],disconnected:[],ready:[],pause:[],load:[],configure:[]};_readyFired=!1;send(e,n){this.enabled&&this.core.send(e,this.metadata.id,n)}inject(e,n){this.enabled&&this.core.inject(e,this.metadata.id,n)}disable(){this.enabled&&(this._setEnabled(!1),this.core.notifyUpdate(this))}notify(e,n){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}window.__CLIENT_HOOKS?.appendChat?window.__CLIENT_HOOKS.appendChat(`${l.escape("[ðŸŸ¢]")} ${e}`):this.inject(`(${l.escape("[ðŸŸ¢]")} ${e}
`,n)}onIncoming(e,n=0){this._handlers.incoming.push({cb:e,priority:n}),this.core.invalidateHandlers()}onOutgoing(e,n=0){this._handlers.outgoing.push({cb:e,priority:n}),this.core.invalidateHandlers()}onLoggedIn(e){this._handlers.loggedIn.push(e)}onConnected(e){this._handlers.connected.push(e)}onDisconnected(e){this._handlers.disconnected.push(e)}onReady(e){if(this._handlers.ready.push(e),this._readyFired)try{e()}catch(n){console.error(`[${this.metadata.name}] Ready Error (Late):`,n)}}onPause(e){this._handlers.pause.push(e)}onLoad(e){this._handlers.load.push(e)}onConfigure(e){this._handlers.configure.push(e)}openModal(e){L(e)}closeModal(){w()}isModalOpen(){return O(u).isOpen}setGameInput(e){this.core.setGameInput(e)}saveData(e,n){if(typeof localStorage>"u")return;const t=`furnarchy_plugin_${this.metadata.id}_${e}`;try{localStorage.setItem(t,JSON.stringify(n))}catch(i){console.error(`[${this.metadata.name}] Failed to save data:`,i)}}loadData(e){if(typeof localStorage>"u")return null;const n=`furnarchy_plugin_${this.metadata.id}_${e}`;try{const t=localStorage.getItem(n);return t?JSON.parse(t):null}catch(t){return console.error(`[${this.metadata.name}] Failed to load data:`,t),null}}expose(e){this.core.registerService(e,this.metadata.id)}use(e){return this.core.getService(e)}_setEnabled(e){this._enabledState!==e&&(this._enabledState=e,this.core.invalidateHandlers(),this._handlers.pause.forEach(n=>{try{n(!e)}catch(t){console.error(t)}}))}_notifyLoggedIn(e){this.enabled&&this._handlers.loggedIn.forEach(n=>{try{n(e)}catch(t){console.error(`[${this.metadata.name}] LoggedIn Error:`,t)}})}_notifyConnected(){this.enabled&&this._handlers.connected.forEach(e=>{try{e()}catch(n){console.error(`[${this.metadata.name}] Connected Error:`,n)}})}_notifyDisconnected(){this.enabled&&this._handlers.disconnected.forEach(e=>{try{e()}catch(n){console.error(`[${this.metadata.name}] Disconnected Error:`,n)}})}_notifyReady(){this._readyFired||(this._readyFired=!0,this._handlers.ready.forEach(e=>{try{e()}catch(n){console.error(`[${this.metadata.name}] Ready Error:`,n)}}))}_notifyLoad(){this._handlers.load.forEach(e=>{try{e(this.enabled)}catch(n){console.error(`[${this.metadata.name}] Load Error:`,n)}})}_notifyConfigure(){this._handlers.configure.forEach(e=>{try{e()}catch(n){console.error(`[${this.metadata.name}] Configure Error:`,n)}})}}class D{version="0.9.0";plugins=[];services=new Map;utils=l;loadingPluginUrl=null;isLoggedIn=!1;characterName=null;isReady=!1;listeners=[];gameInputEnabled=!0;_cachedIncoming=null;_cachedOutgoing=null;constructor(){this.setupInputInterception()}setupInputInterception(){if(typeof document>"u")return;const e=n=>{this.gameInputEnabled||n.stopImmediatePropagation()};document.addEventListener("keydown",e),document.addEventListener("keyup",e),document.addEventListener("keypress",e)}setGameInput(e){this.gameInputEnabled=e}invalidateHandlers(){this._cachedIncoming=null,this._cachedOutgoing=null}start(){this.isReady||(this.isReady=!0,console.log("[Furnarchy] Starting plugins..."),this.plugins.forEach(e=>e._notifyReady()))}send(e,n,t){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,n,t){console.warn("[Furnarchy] inject() called before connection established",e)}registerService(e,n){if(!e.name||!e.version){console.error("[Furnarchy] Service registration failed: Missing 'name' or 'version'",e);return}this.services.has(e.name)&&console.warn(`[Furnarchy] Service '${e.name}' is already registered. Overwriting.`),this.services.set(e.name,{service:e,providerId:n}),console.log(`[Furnarchy] Service registered: ${e.name} v${e.version} by ${n}`)}getService(e){const n=this.services.get(e);return n?n.service:null}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(n=>{try{n(e)}catch(t){console.error(t)}})}register(e,n){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(i=>i.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const t=new M(this);t.metadata={...t.metadata,...e},e.toggle&&t._setEnabled(!1),this.plugins.push(t);try{n(t),console.log(`[Furnarchy] Registered plugin: ${t.metadata.name} (${t.metadata.id})`)}catch(i){console.error("[Furnarchy] Error initializing plugin:",i)}this.notifyUpdate(t),t._notifyLoad(),this.isReady&&t._notifyReady()}_getSortedHandlers(e){if(e==="incoming"&&this._cachedIncoming)return this._cachedIncoming;if(e==="outgoing"&&this._cachedOutgoing)return this._cachedOutgoing;const n=[];for(const t of this.plugins){if(!t.enabled)continue;const i=e==="incoming"?t._handlers.incoming:t._handlers.outgoing;for(const a of i)n.push({...a,plugin:t})}return n.sort((t,i)=>i.priority-t.priority),e==="incoming"?this._cachedIncoming=n:this._cachedOutgoing=n,n}async _processMessage(e,n,t,i){let a=n;const s=this._getSortedHandlers(e);for(const{cb:o,plugin:_}of s)try{const c=await o(a,t,i);if(c==null)return null;a=c}catch(c){const E=e.charAt(0).toUpperCase()+e.slice(1);console.error(`[${_.metadata.name}] ${E} Error:`,c)}return a}async processIncoming(e,n=null,t=null){if(e.startsWith("]B")){const i=e.indexOf(" ");if(i!==-1){const a=e.substring(i+1);this.notifyLoggedIn(a)}}return this._processMessage("incoming",e,n,t)}async processOutgoing(e,n=null,t=null){return this._processMessage("outgoing",e,n,t)}notifyLoggedIn(e){this.isLoggedIn=!0,this.characterName=e,console.log(`[Furnarchy] User logged in as ${e}, notifying plugins...`),this.plugins.forEach(n=>n._notifyLoggedIn(e))}notifyConnected(){console.log("[Furnarchy] Connected to server, notifying plugins..."),this.plugins.forEach(e=>e._notifyConnected())}notifyDisconnected(){this.isLoggedIn=!1,console.log("[Furnarchy] Disconnected from server, notifying plugins..."),this.plugins.forEach(e=>e._notifyDisconnected())}getExposedAPI(){return{register:this.register.bind(this),version:this.version,utils:this.utils}}}const A=new D;export{D as F,H as a,w as c,A as f,U as h,u as m,P as t};
