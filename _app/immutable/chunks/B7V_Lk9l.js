import{b as te,h as b,l as ae,x as D,az as ie,n as oe,o as se,q as H,d as Y,s as k,e as U,C as le,at as ce,af as ue,f as N,j as x,c as z,k as fe,w as de,a5 as V,ar as G,aM as j,aN as ge,r as B,p as he,aO as ve,aP as pe,aQ as O,a as me,aR as _e,aS as ye,aq as be,i as Ee,a8 as Se,aT as Ie,aU as we,aV as Te,aW as Ae,aX as Ne,aY as Le,aK as Pe,D as Ue,a6 as ke,aZ as Oe}from"./Cg5NIOCX.js";import{w as Ce}from"./Db6ANrXm.js";function Xe(n,e){return e}function Me(n,e,r){for(var a=[],i=e.length,s=0;s<i;s++)_e(e[s].e,a,!0);ye(a,()=>{var t=a.length===0&&r!==null;if(t){var o=r,u=o.parentNode;be(u),u.append(o),n.items.clear(),p(n,e[0].prev,e[i-1].next)}for(var l=0;l<i;l++){var f=e[l];t||(n.items.delete(f.k),p(n,f.prev,f.next)),Ee(f.e,!t)}n.first===e[0]&&(n.first=e[0].prev)})}function Qe(n,e,r,a,i,s=null){var t=n,o=new Map,u=null;b&&ae();var l=null,f=ie(()=>{var v=r();return j(v)?v:v==null?[]:G(v)}),d,h=!0;function m(){$e(g,d,t,e,a),l!==null&&(d.length===0?(l.fragment?(t.before(l.fragment),l.fragment=null):B(l.effect),c.first=l.effect):he(l.effect,()=>{l=null}))}var c=te(()=>{d=D(f);var v=d.length;let S=!1;if(b){var _=oe(t)===se;_!==(v===0)&&(t=H(),Y(t),k(!1),S=!0)}for(var L=new Set,I=N,T=null,A=fe(),E=0;E<v;E+=1){b&&U.nodeType===le&&U.data===ce&&(t=U,S=!0,k(!1));var P=d[E],w=a(P,E),y=h?null:o.get(w);y?(ue(y.v,P),y.i=E,A&&I.skipped_effects.delete(y.e)):(y=xe(h?t:null,T,P,w,E,i,e,r),h&&(y.o=!0,T===null?u=y:T.next=y,T=y),o.set(w,y)),L.add(w)}if(v===0&&s&&!l)if(h)l={fragment:null,effect:x(()=>s(t))};else{var F=document.createDocumentFragment(),R=z();F.append(R),l={fragment:F,effect:x(()=>s(R))}}if(b&&v>0&&Y(H()),!h)if(A){for(const[ne,re]of o)L.has(ne)||I.skipped_effects.add(re.e);I.oncommit(m),I.ondiscard(()=>{})}else m();S&&k(!0),D(f)}),g={effect:c,items:o,first:u};h=!1,b&&(t=U)}function $e(n,e,r,a,i){var s=e.length,t=n.items,o=n.first,u,l=null,f=[],d=[],h,m,c,g;for(g=0;g<s;g+=1){if(h=e[g],m=i(h,g),c=t.get(m),n.first??=c,!c.o){c.o=!0;var v=l?l.next:o;p(n,l,c),p(n,c,v),C(c,v,r),l=c,f=[],d=[],o=l.next;continue}if((c.e.f&O)!==0&&B(c.e),c!==o){if(u!==void 0&&u.has(c)){if(f.length<d.length){var S=d[0],_;l=S.prev;var L=f[0],I=f[f.length-1];for(_=0;_<f.length;_+=1)C(f[_],S,r);for(_=0;_<d.length;_+=1)u.delete(d[_]);p(n,L.prev,I.next),p(n,l,L),p(n,I,S),o=S,l=I,g-=1,f=[],d=[]}else u.delete(c),C(c,o,r),p(n,c.prev,c.next),p(n,c,l===null?n.first:l.next),p(n,l,c),l=c;continue}for(f=[],d=[];o!==null&&o.k!==m;)(o.e.f&O)===0&&(u??=new Set).add(o),d.push(o),o=o.next;if(o===null)continue;c=o}f.push(c),l=c,o=c.next}let T=t.size>s;if(o!==null||u!==void 0){for(var A=u===void 0?[]:G(u);o!==null;)(o.e.f&O)===0&&A.push(o),o=o.next;var E=A.length;if(T=t.size-E>s,E>0){var P=null;Me(n,A,P)}}if(T)for(const w of t.values())w.o||(p(n,l,w),l=w);n.effect.last=l&&l.e}function xe(n,e,r,a,i,s,t,o){var u=(t&ve)!==0,l=(t&pe)===0,f=u?l?de(r,!1,!1):V(r):r,d=(t&ge)===0?i:V(i),h={i:d,v:f,k:a,a:null,e:null,o:!1,prev:e,next:null};try{if(n===null){var m=document.createDocumentFragment();m.append(n=z())}return h.e=x(()=>s(n,f,d,o)),e!==null&&(e.next=h),h}finally{}}function C(n,e,r){for(var a=n.next?n.next.e.nodes_start:r,i=e?e.e.nodes_start:r,s=n.e.nodes_start;s!==null&&s!==a;){var t=me(s);i.before(s),s=t}}function p(n,e,r){e===null?(n.first=r,n.effect.first=r&&r.e):(e.e.next&&(e.e.next.prev=null),e.next=r,e.e.next=r&&r.e),r!==null&&(r.e.prev&&(r.e.prev.next=null),r.prev=e,r.e.prev=e&&e.e)}const q=[...` 	
\r\fÂ \v\uFEFF`];function Fe(n,e,r){var a=n==null?"":""+n;if(r){for(var i in r)if(r[i])a=a?a+" "+i:i;else if(a.length)for(var s=i.length,t=0;(t=a.indexOf(i,t))>=0;){var o=t+s;(t===0||q.includes(a[t-1]))&&(o===a.length||q.includes(a[o]))?a=(t===0?"":a.substring(0,t))+a.substring(o+1):t=o}}return a===""?null:a}function Ze(n,e,r,a,i,s){var t=n.__className;if(b||t!==r||t===void 0){var o=Fe(r,a,s);(!b||o!==n.getAttribute("class"))&&(o==null?n.removeAttribute("class"):n.className=o),n.__className=r}else if(s&&i!==s)for(var u in s){var l=!!s[u];(i==null||l!==!!i[u])&&n.classList.toggle(u,l)}return s}const Re=Symbol("is custom element"),De=Symbol("is html");function en(n){if(b){var e=!1,r=()=>{if(!e){if(e=!0,n.hasAttribute("value")){var a=n.value;K(n,"value",null),n.value=a}if(n.hasAttribute("checked")){var i=n.checked;K(n,"checked",null),n.checked=i}}};n.__on_r=r,Se(r),Ie()}}function K(n,e,r,a){var i=He(n);b&&(i[e]=n.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&n.nodeName==="LINK")||i[e]!==(i[e]=r)&&(e==="loading"&&(n[we]=r),r==null?n.removeAttribute(e):typeof r!="string"&&Ye(n).includes(e)?n[e]=r:n.setAttribute(e,r))}function He(n){return n.__attributes??={[Re]:n.nodeName.includes("-"),[De]:n.namespaceURI===Te}}var J=new Map;function Ye(n){var e=n.getAttribute("is")||n.nodeName,r=J.get(e);if(r)return r;J.set(e,r=[]);for(var a,i=n,s=Element.prototype;s!==i;){a=Ne(i);for(var t in a)a[t].set&&r.push(t);i=Ae(i)}return r}function nn(n,e,r=e){var a=new WeakSet;Le(n,"input",async i=>{var s=i?n.defaultValue:n.value;if(s=M(n)?$(s):s,r(s),N!==null&&a.add(N),await Pe(),s!==(s=e())){var t=n.selectionStart,o=n.selectionEnd,u=n.value.length;if(n.value=s??"",o!==null){var l=n.value.length;t===o&&o===u&&l>u?(n.selectionStart=l,n.selectionEnd=l):(n.selectionStart=t,n.selectionEnd=Math.min(o,l))}}}),(b&&n.defaultValue!==n.value||Ue(e)==null&&n.value)&&(r(M(n)?$(n.value):n.value),N!==null&&a.add(N)),ke(()=>{var i=e();if(n===document.activeElement){var s=Oe??N;if(a.has(s))return}M(n)&&i===$(n.value)||n.type==="date"&&!i&&!n.value||i!==n.value&&(n.value=i??"")})}function M(n){var e=n.type;return e==="number"||e==="range"}function $(n){return n===""?null:+n}function rn(n){return function(...e){var r=e[0];return r.stopPropagation(),n?.apply(this,e)}}function tn(n,e){var r=n.$$events?.[e.type],a=j(r)?r.slice():r==null?[]:[r];for(var i of a)i.call(this,e)}const an=globalThis.__sveltekit_15k7e49.env;async function Ve(n){let e;try{const r=await fetch(n);if(!r.ok)throw new Error(`HTTP ${r.status}`);e=await r.text()}catch(r){throw new Error(`Failed to fetch plugin: ${r.message}`)}return new Promise((r,a)=>{const i=Math.random().toString(36).substring(7),s=document.createElement("iframe");s.style.display="none",s.setAttribute("sandbox","allow-scripts");let t;const o=()=>{t&&clearTimeout(t),window.removeEventListener("message",u),document.body.contains(s)&&document.body.removeChild(s)},u=m=>{const c=m.data;if(!c||c.type!=="furnarchy-plugin-register"||c.requestId!==i)return;const g=c.plugin;if(!g.id||!g.name||!g.version){o(),a(new Error("Plugin registered but missing id, name, or version"));return}r({id:g.id,name:g.name,description:g.description,version:g.version,author:g.author,sourceUrl:n,toggle:g.toggle}),o()};window.addEventListener("message",u);const l=`
            window.Furnarchy = {
                version: '0.0.0-sandbox',
                loadingPluginUrl: ${JSON.stringify(n)},
                register: function(meta, arg) {
                    if (typeof arg === 'function') {
                        // Send metadata immediately
                        window.parent.postMessage({
                            type: 'furnarchy-plugin-register',
                            requestId: '${i}',
                            plugin: meta
                        }, '*');

                        const api = {
                            send: function() {},
                            inject: function() {},
                            notify: function() {},
                            onIncoming: function() {},
                            onOutgoing: function() {},
                            onLoggedIn: function() {},
                            onPause: function() {},
                            onLoad: function() {}
                        };
                        try { arg(api); } catch(e) {}
                    }
                },
                onRegister: function() {},
                send: function() {}
            };
        `,d=`
            try {
                const content = decodeURIComponent(escape(atob('${btoa(unescape(encodeURIComponent(e)))}')));
                const script = document.createElement('script');
                script.textContent = content;
                document.body.appendChild(script);
            } catch(e) {
                console.error('Sandbox execution error:', e);
            }
        `,h=`
            <!DOCTYPE html>
            <html>
            <head>
                <script>${l}<\/script>
            </head>
            <body>
                <script>${d}<\/script>
            </body>
            </html>
        `;s.srcdoc=h,document.body.appendChild(s),t=setTimeout(()=>{o(),a(new Error("Plugin load timed out (5s) - did not call Furnarchy.register()?"))},5e3)})}const W="furnarchy_plugins",X="furnarchy_deleted_plugins",Q="furnarchy_auth_url",Z="furnarchy_version",qe=Ce([]);function ee(){if(typeof localStorage>"u")return[];const n=localStorage.getItem(X);if(!n)return[];try{return JSON.parse(n)}catch{return[]}}function on(n){if(typeof localStorage>"u")return;const e=ee();e.includes(n)||(e.push(n),localStorage.setItem(X,JSON.stringify(e)))}function Ke(){if(typeof localStorage>"u")return[];const n=localStorage.getItem(W);if(!n)return[];try{const e=JSON.parse(n);return Array.isArray(e)?e.map(r=>typeof r=="string"?{url:r}:r):[]}catch(e){return console.error("Failed to load plugins",e),[]}}function Je(n){typeof localStorage>"u"||(localStorage.setItem(W,JSON.stringify(n)),qe.set(n))}function sn(){return typeof localStorage>"u"?null:localStorage.getItem(Q)}function ln(n){typeof localStorage>"u"||localStorage.setItem(Q,n)}function ze(){return typeof localStorage>"u"?null:localStorage.getItem(Z)}function Ge(n){typeof localStorage>"u"||localStorage.setItem(Z,n)}async function cn(n){if(typeof localStorage>"u")return;const e=ze();let r=Ke();const a=["/plugins/auto-spinner.js","/plugins/wire-shrek.js"],i=ee();let s=!1;for(const t of a)if(!r.some(o=>o.url===t))try{const o=await Ve(t);if(i.includes(o.id)){console.log(`Skipping deleted default plugin: ${o.name} (${o.id})`);continue}r.push({id:o.id,url:t,name:o.name,description:o.description,version:o.version,author:o.author,enabled:typeof o.toggle=="boolean"?!o.toggle:!0}),s=!0}catch(o){console.error(`Failed to load default plugin ${t}:`,o)}s&&Je(r),e!==n&&Ge(n)}class je{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};enabled=!0;handlers={incoming:[],outgoing:[],loggedIn:[],pause:[],load:[]};send(e,r){this.enabled&&this.core.send(e,r,this.metadata.id)}inject(e,r){this.enabled&&this.core.inject(e,r,this.metadata.id)}notify(e,r){this.inject(`(${e}
`,r)}onIncoming(e){this.handlers.incoming.push(e)}onOutgoing(e){this.handlers.outgoing.push(e)}onLoggedIn(e){this.handlers.loggedIn.push(e)}onPause(e){this.handlers.pause.push(e)}onLoad(e){this.handlers.load.push(e)}_setEnabled(e){this.enabled!==e&&(this.enabled=e,this.handlers.pause.forEach(r=>{try{r(!e)}catch(a){console.error(a)}}))}async _processIncoming(e,r,a){if(!this.enabled)return e;let i=e;for(const s of this.handlers.incoming)try{const t=await s(i,a,r);if(t==null)return null;i=t}catch(t){console.error(`[${this.metadata.name}] Incoming Error:`,t)}return i}async _processOutgoing(e,r,a){if(!this.enabled)return e;let i=e;for(const s of this.handlers.outgoing)try{const t=await s(i,a,r);if(t==null)return null;i=t}catch(t){console.error(`[${this.metadata.name}] Outgoing Error:`,t)}return i}_notifyLoggedIn(){this.enabled&&this.handlers.loggedIn.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] LoggedIn Error:`,r)}})}_notifyLoad(){this.handlers.load.forEach(e=>{try{e(this.enabled)}catch(r){console.error(`[${this.metadata.name}] Load Error:`,r)}})}}class un{version="0.2.0";plugins=[];loadingPluginUrl=null;listeners=[];send(e,r,a){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,r,a){console.warn("[Furnarchy] inject() called before connection established",e)}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(r=>{try{r(e)}catch(a){console.error(a)}})}register(e,r){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(i=>i.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const a=new je(this);a.metadata={...a.metadata,...e},e.toggle&&(a.enabled=!1),this.plugins.push(a);try{r(a),console.log(`[Furnarchy] Registered plugin: ${a.metadata.name} (${a.metadata.id})`)}catch(i){console.error("[Furnarchy] Error initializing plugin:",i)}this.notifyUpdate(a),a._notifyLoad()}async processIncoming(e,r=null,a=null){let i=e;for(const s of this.plugins){const t=await s._processIncoming(i,r,a);if(t==null)return null;i=t}return i}async processOutgoing(e,r=null,a=null){let i=e;for(const s of this.plugins){const t=await s._processOutgoing(i,r,a);if(t==null)return null;i=t}return i}notifyLoggedIn(){console.log("[Furnarchy] User logged in, notifying plugins..."),this.plugins.forEach(e=>e._notifyLoggedIn())}}export{un as F,sn as a,nn as b,an as c,K as d,Qe as e,rn as f,Ke as g,Je as h,Xe as i,ln as j,tn as k,cn as l,on as m,qe as p,en as r,Ze as s,Ve as v};
