import{b as ee,h as E,f as re,B as H,aw as ne,r as ae,i as te,j as D,d as q,s as M,e as C,C as se,an as oe,a7 as ie,k as N,n as O,c as B,q as le,R as ce,Z as Y,al as z,aJ as G,aK as fe,l as W,p as ue,aL as de,aM as ve,aN as U,a as ge,aO as he,aP as me,ak as _e,m as pe,a0 as ye,aQ as Ee,aR as be,aS as Se,aT as we,aU as Ie,aV as Te,aH as Ae,x as Ne,_ as Le,aW as ke}from"./DvRTsLh6.js";function He(e,r){return r}function Ce(e,r,n){for(var t=[],s=r.length,a=0;a<s;a++)he(r[a].e,t,!0);me(t,()=>{var i=t.length===0&&n!==null;if(i){var o=n,f=o.parentNode;_e(f),f.append(o),e.items.clear(),m(e,r[0].prev,r[s-1].next)}for(var l=0;l<s;l++){var u=r[l];i||(e.items.delete(u.k),m(e,u.prev,u.next)),pe(u.e,!i)}e.first===r[0]&&(e.first=r[0].prev)})}function De(e,r,n,t,s,a=null){var i=e,o=new Map,f=null;E&&re();var l=null,u=ne(()=>{var h=n();return G(h)?h:h==null?[]:z(h)}),d,v=!0;function _(){Me(g,d,i,r,t),l!==null&&(d.length===0?(l.fragment?(i.before(l.fragment),l.fragment=null):W(l.effect),c.first=l.effect):ue(l.effect,()=>{l=null}))}var c=ee(()=>{d=H(u);var h=d.length;let S=!1;if(E){var p=ae(i)===te;p!==(h===0)&&(i=D(),q(i),M(!1),S=!0)}for(var L=new Set,w=N,T=null,A=le(),b=0;b<h;b+=1){E&&C.nodeType===se&&C.data===oe&&(i=C,S=!0,M(!1));var k=d[b],I=t(k,b),y=v?null:o.get(I);y?(ie(y.v,k),y.i=b,A&&w.skipped_effects.delete(y.e)):(y=Ue(v?i:null,T,k,I,b,s,r,n),v&&(y.o=!0,T===null?f=y:T.next=y,T=y),o.set(I,y)),L.add(I)}if(h===0&&a&&!l)if(v)l={fragment:null,effect:O(()=>a(i))};else{var R=document.createDocumentFragment(),$=B();R.append($),l={fragment:R,effect:O(()=>a($))}}if(E&&h>0&&q(D()),!v)if(A){for(const[Z,j]of o)L.has(Z)||w.skipped_effects.add(j.e);w.oncommit(_),w.ondiscard(()=>{})}else _();S&&M(!0),H(u)}),g={effect:c,items:o,first:f};v=!1,E&&(i=C)}function Me(e,r,n,t,s){var a=r.length,i=e.items,o=e.first,f,l=null,u=[],d=[],v,_,c,g;for(g=0;g<a;g+=1){if(v=r[g],_=s(v,g),c=i.get(_),e.first??=c,!c.o){c.o=!0;var h=l?l.next:o;m(e,l,c),m(e,c,h),P(c,h,n),l=c,u=[],d=[],o=l.next;continue}if((c.e.f&U)!==0&&W(c.e),c!==o){if(f!==void 0&&f.has(c)){if(u.length<d.length){var S=d[0],p;l=S.prev;var L=u[0],w=u[u.length-1];for(p=0;p<u.length;p+=1)P(u[p],S,n);for(p=0;p<d.length;p+=1)f.delete(d[p]);m(e,L.prev,w.next),m(e,l,L),m(e,w,S),o=S,l=w,g-=1,u=[],d=[]}else f.delete(c),P(c,o,n),m(e,c.prev,c.next),m(e,c,l===null?e.first:l.next),m(e,l,c),l=c;continue}for(u=[],d=[];o!==null&&o.k!==_;)(o.e.f&U)===0&&(f??=new Set).add(o),d.push(o),o=o.next;if(o===null)continue;c=o}u.push(c),l=c,o=c.next}let T=i.size>a;if(o!==null||f!==void 0){for(var A=f===void 0?[]:z(f);o!==null;)(o.e.f&U)===0&&A.push(o),o=o.next;var b=A.length;if(T=i.size-b>a,b>0){var k=null;Ce(e,A,k)}}if(T)for(const I of i.values())I.o||(m(e,l,I),l=I);e.effect.last=l&&l.e}function Ue(e,r,n,t,s,a,i,o){var f=(i&de)!==0,l=(i&ve)===0,u=f?l?ce(n,!1,!1):Y(n):n,d=(i&fe)===0?s:Y(s),v={i:d,v:u,k:t,a:null,e:null,o:!1,prev:r,next:null};try{if(e===null){var _=document.createDocumentFragment();_.append(e=B())}return v.e=O(()=>a(e,u,d,o)),r!==null&&(r.next=v),v}finally{}}function P(e,r,n){for(var t=e.next?e.next.e.nodes_start:n,s=r?r.e.nodes_start:n,a=e.e.nodes_start;a!==null&&a!==t;){var i=ge(a);s.before(a),a=i}}function m(e,r,n){r===null?(e.first=n,e.effect.first=n&&n.e):(r.e.next&&(r.e.next.prev=null),r.next=n,r.e.next=n&&n.e),n!==null&&(n.e.prev&&(n.e.prev.next=null),n.prev=r,n.e.prev=r&&r.e)}const V=[...` 	
\r\fÂ \v\uFEFF`];function Pe(e,r,n){var t=e==null?"":""+e;if(n){for(var s in n)if(n[s])t=t?t+" "+s:s;else if(t.length)for(var a=s.length,i=0;(i=t.indexOf(s,i))>=0;){var o=i+a;(i===0||V.includes(t[i-1]))&&(o===t.length||V.includes(t[o]))?t=(i===0?"":t.substring(0,i))+t.substring(o+1):i=o}}return t===""?null:t}function qe(e,r,n,t,s,a){var i=e.__className;if(E||i!==n||i===void 0){var o=Pe(n,t,a);(!E||o!==e.getAttribute("class"))&&(o==null?e.removeAttribute("class"):e.className=o),e.__className=n}else if(a&&s!==a)for(var f in a){var l=!!a[f];(s==null||l!==!!s[f])&&e.classList.toggle(f,l)}return a}const xe=Symbol("is custom element"),Fe=Symbol("is html");function Ye(e){if(E){var r=!1,n=()=>{if(!r){if(r=!0,e.hasAttribute("value")){var t=e.value;J(e,"value",null),e.value=t}if(e.hasAttribute("checked")){var s=e.checked;J(e,"checked",null),e.checked=s}}};e.__on_r=n,ye(n),Ee()}}function J(e,r,n,t){var s=Oe(e);E&&(s[r]=e.getAttribute(r),r==="src"||r==="srcset"||r==="href"&&e.nodeName==="LINK")||s[r]!==(s[r]=n)&&(r==="loading"&&(e[be]=n),n==null?e.removeAttribute(r):typeof n!="string"&&Re(e).includes(r)?e[r]=n:e.setAttribute(r,n))}function Oe(e){return e.__attributes??={[xe]:e.nodeName.includes("-"),[Fe]:e.namespaceURI===Se}}var K=new Map;function Re(e){var r=e.getAttribute("is")||e.nodeName,n=K.get(r);if(n)return n;K.set(r,n=[]);for(var t,s=e,a=Element.prototype;a!==s;){t=Ie(s);for(var i in t)t[i].set&&n.push(i);s=we(s)}return n}function Ve(e,r,n=r){var t=new WeakSet;Te(e,"input",async s=>{var a=s?e.defaultValue:e.value;if(a=x(e)?F(a):a,n(a),N!==null&&t.add(N),await Ae(),a!==(a=r())){var i=e.selectionStart,o=e.selectionEnd,f=e.value.length;if(e.value=a??"",o!==null){var l=e.value.length;i===o&&o===f&&l>f?(e.selectionStart=l,e.selectionEnd=l):(e.selectionStart=i,e.selectionEnd=Math.min(o,l))}}}),(E&&e.defaultValue!==e.value||Ne(r)==null&&e.value)&&(n(x(e)?F(e.value):e.value),N!==null&&t.add(N)),Le(()=>{var s=r();if(e===document.activeElement){var a=ke??N;if(t.has(a))return}x(e)&&s===F(e.value)||e.type==="date"&&!s&&!e.value||s!==e.value&&(e.value=s??"")})}function x(e){var r=e.type;return r==="number"||r==="range"}function F(e){return e===""?null:+e}function Je(e){return function(...r){var n=r[0];return n.stopPropagation(),e?.apply(this,r)}}function Ke(e,r){var n=e.$$events?.[r.type],t=G(n)?n.slice():n==null?[]:[n];for(var s of t)s.call(this,r)}const Be=globalThis.__sveltekit_1kp71e9.env,Q="furnarchy_plugins",X="furnarchy_auth_url";function ze(){if(typeof localStorage>"u")return[];const e=localStorage.getItem(Q);if(!e)return[];try{const r=JSON.parse(e);return Array.isArray(r)?r.map(n=>typeof n=="string"?{url:n}:n):[]}catch(r){return console.error("Failed to load plugins",r),[]}}function Ge(e){typeof localStorage>"u"||localStorage.setItem(Q,JSON.stringify(e))}function We(){return typeof localStorage>"u"?null:localStorage.getItem(X)}function Qe(e){typeof localStorage>"u"||localStorage.setItem(X,e)}async function Xe(e){let r;try{const n=await fetch(e);if(!n.ok)throw new Error(`HTTP ${n.status}`);r=await n.text()}catch(n){throw new Error(`Failed to fetch plugin: ${n.message}`)}return new Promise((n,t)=>{const s=Math.random().toString(36).substring(7),a=document.createElement("iframe");a.style.display="none",a.setAttribute("sandbox","allow-scripts");let i;const o=()=>{i&&clearTimeout(i),window.removeEventListener("message",f),document.body.contains(a)&&document.body.removeChild(a)},f=_=>{const c=_.data;if(!c||c.type!=="furnarchy-plugin-register"||c.requestId!==s)return;const g=c.plugin;if(!g.name){o(),t(new Error("Plugin registered but missing name"));return}n({name:g.name,version:g.version,author:g.author,sourceUrl:e}),o()};window.addEventListener("message",f);const l=`
            window.Furnarchy = {
                version: '0.0.0-sandbox',
                loadingPluginUrl: ${JSON.stringify(e)},
                register: function(plugin) {
                    // Send result back to parent
                    window.parent.postMessage({
                        type: 'furnarchy-plugin-register',
                        requestId: '${s}',
                        plugin: {
                            name: plugin.name,
                            version: plugin.version,
                            author: plugin.author
                        }
                    }, '*');
                },
                onRegister: function() {},
                send: function() {}
            };
        `,d=`
            try {
                const content = decodeURIComponent(escape(atob('${btoa(unescape(encodeURIComponent(r)))}')));
                const script = document.createElement('script');
                script.textContent = content;
                document.body.appendChild(script);
            } catch(e) {
                console.error('Sandbox execution error:', e);
            }
        `,v=`
            <!DOCTYPE html>
            <html>
            <head>
                <script>${l}<\/script>
            </head>
            <body>
                <script>${d}<\/script>
            </body>
            </html>
        `;a.srcdoc=v,document.body.appendChild(a),i=setTimeout(()=>{o(),t(new Error("Plugin load timed out (5s) - did not call Furnarchy.register()?"))},5e3)})}class Ze{version="0.0.1";plugins=[];loadingPluginUrl=null;listeners=[];send(r,n){console.warn("[Furnarchy] send() called before connection established",r)}inject(r,n){console.warn("[Furnarchy] inject() called before connection established",r)}onRegister(r){this.listeners.push(r)}register(r){if(console.log(`[Furnarchy] Registering plugin: ${r.name}`),this.loadingPluginUrl&&(r.sourceUrl=this.loadingPluginUrl),this.plugins.push(r),this.listeners.forEach(n=>{try{n(r)}catch(t){console.error(t)}}),r.onLoad)try{r.onLoad()}catch(n){console.error(`[Furnarchy] Error loading plugin ${r.name}:`,n)}}async processIncoming(r,n=null){let t=r;for(const s of this.plugins)if(s.onIncoming)try{const a=await s.onIncoming(t,n);if(a==null)return null;t=a}catch(a){console.error(`[Furnarchy] Error in plugin ${s.name} (incoming):`,a)}return t}async processOutgoing(r,n=null){let t=r;for(const s of this.plugins)if(s.onOutgoing)try{const a=await s.onOutgoing(t,n);if(a==null)return null;t=a}catch(a){console.error(`[Furnarchy] Error in plugin ${s.name} (outgoing):`,a)}return t}notifyLoggedIn(){console.log("[Furnarchy] User logged in, notifying plugins..."),this.plugins.forEach(r=>{if(r.onLoggedIn)try{r.onLoggedIn()}catch(n){console.error(`[Furnarchy] Error in plugin ${r.name} (onLoggedIn):`,n)}})}}export{Ze as F,We as a,Ve as b,Be as c,J as d,De as e,Je as f,ze as g,Ge as h,He as i,Qe as j,Ke as k,Ye as r,qe as s,Xe as v};
