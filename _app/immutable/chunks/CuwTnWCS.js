import{x as ae,y as S,O as oe,h as H,a6 as ie,Q as se,R as le,T as J,D as Y,B as T,E as P,C as ce,aP as ue,ax as de,G as $,L as U,w as G,N as fe,W as ge,ap as K,aN as z,aQ as B,aR as he,I as W,K as ve,aS as pe,aT as me,aU as M,A as _e,aV as ye,aW as Se,aM as Ie,J as be,q as Ee,aX as we,aY as Le,aZ as Ne,a_ as $e,a$ as Ae,b0 as Oe,ai as Pe,u as Te,r as Me,b1 as ke,F as Ce,Y as Fe}from"./DLIAHk6_.js";import{a as Ue,c as xe,o as Re,m as De}from"./67UxSOWT.js";function nn(n,e){return e}function He(n,e,t){for(var r=[],i=e.length,o=0;o<i;o++)ye(e[o].e,r,!0);Se(r,()=>{var l=r.length===0&&t!==null;if(l){var a=t,u=a.parentNode;Ie(u),u.append(a),n.items.clear(),p(n,e[0].prev,e[i-1].next)}for(var s=0;s<i;s++){var d=e[s];l||(n.items.delete(d.k),p(n,d.prev,d.next)),be(d.e,!l)}n.first===e[0]&&(n.first=e[0].prev)})}function tn(n,e,t,r,i,o=null){var l=n,a=new Map,u=null;S&&oe();var s=null,d=ie(()=>{var v=t();return B(v)?v:v==null?[]:z(v)}),f,h=!0;function m(){Je(g,f,l,e,r),s!==null&&(f.length===0?(s.fragment?(l.before(s.fragment),s.fragment=null):W(s.effect),c.first=s.effect):ve(s.effect,()=>{s=null}))}var c=ae(()=>{f=H(d);var v=f.length;let b=!1;if(S){var _=se(l)===le;_!==(v===0)&&(l=J(),Y(l),T(!1),b=!0)}for(var A=new Set,E=$,L=null,N=fe(),I=0;I<v;I+=1){S&&P.nodeType===ce&&P.data===ue&&(l=P,b=!0,T(!1));var O=f[I],w=r(O,I),y=h?null:a.get(w);y?(de(y.v,O),y.i=I,N&&E.skipped_effects.delete(y.e)):(y=Ye(h?l:null,L,O,w,I,i,e,t),h&&(y.o=!0,L===null?u=y:L.next=y,L=y),a.set(w,y)),A.add(w)}if(v===0&&o&&!s)if(h)s={fragment:null,effect:U(()=>o(l))};else{var R=document.createDocumentFragment(),D=G();R.append(D),s={fragment:R,effect:U(()=>o(D))}}if(S&&v>0&&Y(J()),!h)if(N){for(const[te,re]of a)A.has(te)||E.skipped_effects.add(re.e);E.oncommit(m),E.ondiscard(()=>{})}else m();b&&T(!0),H(d)}),g={effect:c,items:a,first:u};h=!1,S&&(l=P)}function Je(n,e,t,r,i){var o=e.length,l=n.items,a=n.first,u,s=null,d=[],f=[],h,m,c,g;for(g=0;g<o;g+=1){if(h=e[g],m=i(h,g),c=l.get(m),n.first??=c,!c.o){c.o=!0;var v=s?s.next:a;p(n,s,c),p(n,c,v),k(c,v,t),s=c,d=[],f=[],a=s.next;continue}if((c.e.f&M)!==0&&W(c.e),c!==a){if(u!==void 0&&u.has(c)){if(d.length<f.length){var b=f[0],_;s=b.prev;var A=d[0],E=d[d.length-1];for(_=0;_<d.length;_+=1)k(d[_],b,t);for(_=0;_<f.length;_+=1)u.delete(f[_]);p(n,A.prev,E.next),p(n,s,A),p(n,E,b),a=b,s=E,g-=1,d=[],f=[]}else u.delete(c),k(c,a,t),p(n,c.prev,c.next),p(n,c,s===null?n.first:s.next),p(n,s,c),s=c;continue}for(d=[],f=[];a!==null&&a.k!==m;)(a.e.f&M)===0&&(u??=new Set).add(a),f.push(a),a=a.next;if(a===null)continue;c=a}d.push(c),s=c,a=c.next}let L=l.size>o;if(a!==null||u!==void 0){for(var N=u===void 0?[]:z(u);a!==null;)(a.e.f&M)===0&&N.push(a),a=a.next;var I=N.length;if(L=l.size-I>o,I>0){var O=null;He(n,N,O)}}if(L)for(const w of l.values())w.o||(p(n,s,w),s=w);n.effect.last=s&&s.e}function Ye(n,e,t,r,i,o,l,a){var u=(l&pe)!==0,s=(l&me)===0,d=u?s?ge(t,!1,!1):K(t):t,f=(l&he)===0?i:K(i),h={i:f,v:d,k:r,a:null,e:null,o:!1,prev:e,next:null};try{if(n===null){var m=document.createDocumentFragment();m.append(n=G())}return h.e=U(()=>o(n,d,f,a)),e!==null&&(e.next=h),h}finally{}}function k(n,e,t){for(var r=n.next?n.next.e.nodes_start:t,i=e?e.e.nodes_start:t,o=n.e.nodes_start;o!==null&&o!==r;){var l=_e(o);i.before(o),o=l}}function p(n,e,t){e===null?(n.first=t,n.effect.first=t&&t.e):(e.e.next&&(e.e.next.prev=null),e.next=t,e.e.next=t&&t.e),t!==null&&(t.e.prev&&(t.e.prev.next=null),t.prev=e,t.e.prev=e&&e.e)}function rn(n,e,t,r,i,o){var l=n.__className;if(S||l!==t||l===void 0){var a=Ue(t,r,o);(!S||a!==n.getAttribute("class"))&&(a==null?n.removeAttribute("class"):n.className=a),n.__className=t}else if(o&&i!==o)for(var u in o){var s=!!o[u];(i==null||s!==!!i[u])&&n.classList.toggle(u,s)}return o}const Ke=Symbol("is custom element"),Ve=Symbol("is html");function an(n){if(S){var e=!1,t=()=>{if(!e){if(e=!0,n.hasAttribute("value")){var r=n.value;V(n,"value",null),n.value=r}if(n.hasAttribute("checked")){var i=n.checked;V(n,"checked",null),n.checked=i}}};n.__on_r=t,Ee(t),we()}}function V(n,e,t,r){var i=qe(n);S&&(i[e]=n.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&n.nodeName==="LINK")||i[e]!==(i[e]=t)&&(e==="loading"&&(n[Le]=t),t==null?n.removeAttribute(e):typeof t!="string"&&Ge(n).includes(e)?n[e]=t:n.setAttribute(e,t))}function qe(n){return n.__attributes??={[Ke]:n.nodeName.includes("-"),[Ve]:n.namespaceURI===Ne}}var q=new Map;function Ge(n){var e=n.getAttribute("is")||n.nodeName,t=q.get(e);if(t)return t;q.set(e,t=[]);for(var r,i=n,o=Element.prototype;o!==i;){r=Ae(i);for(var l in r)r[l].set&&t.push(l);i=$e(i)}return t}function on(n,e,t=e){var r=new WeakSet;Oe(n,"input",async i=>{var o=i?n.defaultValue:n.value;if(o=C(n)?F(o):o,t(o),$!==null&&r.add($),await Pe(),o!==(o=e())){var l=n.selectionStart,a=n.selectionEnd,u=n.value.length;if(n.value=o??"",a!==null){var s=n.value.length;l===a&&a===u&&s>u?(n.selectionStart=s,n.selectionEnd=s):(n.selectionStart=l,n.selectionEnd=Math.min(a,s))}}}),(S&&n.defaultValue!==n.value||Te(e)==null&&n.value)&&(t(C(n)?F(n.value):n.value),$!==null&&r.add($)),Me(()=>{var i=e();if(n===document.activeElement){var o=ke??$;if(r.has(o))return}C(n)&&i===F(n.value)||n.type==="date"&&!i&&!n.value||i!==n.value&&(n.value=i??"")})}function C(n){var e=n.type;return e==="number"||e==="range"}function F(n){return n===""?null:+n}function sn(n){return function(...e){var t=e[0];return t.stopPropagation(),n?.apply(this,e)}}function ln(n,e){var t=n.$$events?.[e.type],r=B(t)?t.slice():t==null?[]:[t];for(var i of r)i.call(this,e)}const cn=globalThis.__sveltekit_cy795j.env;async function ze(n){let e;try{const t=await fetch(n);if(!t.ok)throw new Error(`HTTP ${t.status}`);e=await t.text()}catch(t){throw new Error(`Failed to fetch plugin: ${t.message}`)}return new Promise((t,r)=>{const i=Math.random().toString(36).substring(7),o=document.createElement("iframe");o.style.display="none",o.setAttribute("sandbox","allow-scripts");let l;const a=()=>{l&&clearTimeout(l),window.removeEventListener("message",u),document.body.contains(o)&&document.body.removeChild(o)},u=m=>{const c=m.data;if(!c||c.type!=="furnarchy-plugin-register"||c.requestId!==i)return;const g=c.plugin;if(!g.id||!g.name||!g.version){a(),r(new Error("Plugin registered but missing id, name, or version"));return}t({id:g.id,name:g.name,description:g.description,version:g.version,author:g.author,sourceUrl:n,toggle:g.toggle}),a()};window.addEventListener("message",u);const s=`
            window.Furnarchy = {
                version: '0.0.0-sandbox',
                loadingPluginUrl: ${JSON.stringify(n)},
                register: function(meta, arg) {
                    if (typeof arg === 'function') {
                        // Send metadata immediately
                        window.parent.postMessage({
                            type: 'furnarchy-plugin-register',
                            requestId: '${i}',
                            plugin: meta
                        }, '*');

                        const api = {
                            send: function() {},
                            inject: function() {},
                            notify: function() {},
                            disable: function() {},
                            onIncoming: function() {},
                            onOutgoing: function() {},
                            onLoggedIn: function() {},
                            onPause: function() {},
                            onLoad: function() {}
                        };
                        try { arg(api); } catch(e) {}
                    }
                },
                onRegister: function() {},
                send: function() {}
            };
        `,f=`
            try {
                const content = decodeURIComponent(escape(atob('${btoa(unescape(encodeURIComponent(e)))}')));
                const script = document.createElement('script');
                script.textContent = content;
                document.body.appendChild(script);
            } catch(e) {
                console.error('Sandbox execution error:', e);
            }
        `,h=`
            <!DOCTYPE html>
            <html>
            <head>
                <script>${s}<\/script>
            </head>
            <body>
                <script>${f}<\/script>
            </body>
            </html>
        `;o.srcdoc=h,document.body.appendChild(o),l=setTimeout(()=>{a(),r(new Error("Plugin load timed out (5s) - did not call Furnarchy.register()?"))},5e3)})}const x="furnarchy_plugins",j="furnarchy_deleted_plugins",Q="furnarchy_auth_url",X="furnarchy_version",Z=Ce([]);function ee(){if(typeof localStorage>"u")return[];const n=localStorage.getItem(j);if(!n)return[];try{return JSON.parse(n)}catch{return[]}}function un(n){if(typeof localStorage>"u")return;const e=ee();e.includes(n)||(e.push(n),localStorage.setItem(j,JSON.stringify(e)))}function Be(){if(typeof localStorage>"u")return[];const n=localStorage.getItem(x);if(!n)return[];try{const e=JSON.parse(n);return Array.isArray(e)?e.map(t=>typeof t=="string"?{url:t}:t):[]}catch(e){return console.error("Failed to load plugins",e),[]}}function We(n){typeof localStorage>"u"||(localStorage.setItem(x,JSON.stringify(n)),Z.set(n))}function dn(n,e){Z.update(t=>{const r=t.findIndex(a=>a.url===n);if(r===-1)return t;const i=t[r],o={...i,...e};if(JSON.stringify(i)===JSON.stringify(o))return t;const l=[...t];return l[r]=o,typeof localStorage<"u"&&localStorage.setItem(x,JSON.stringify(l)),l})}function fn(){return typeof localStorage>"u"?null:localStorage.getItem(Q)}function gn(n){typeof localStorage>"u"||localStorage.setItem(Q,n)}function je(){return typeof localStorage>"u"?null:localStorage.getItem(X)}function Qe(n){typeof localStorage>"u"||localStorage.setItem(X,n)}async function hn(n){if(typeof localStorage>"u")return;const e=je();let t=Be();const r=["/plugins/auto-spinner.js","/plugins/wire-shrek.js"],i=ee();let o=!1;for(const l of r)if(!t.some(a=>a.url===l))try{const a=await ze(l);if(i.includes(a.id)){console.log(`Skipping deleted default plugin: ${a.name} (${a.id})`);continue}t.push({id:a.id,url:l,name:a.name,description:a.description,version:a.version,author:a.author,enabled:typeof a.toggle=="boolean"?!a.toggle:!0}),o=!0}catch(a){console.error(`Failed to load default plugin ${l}:`,a)}o&&We(t),e!==n&&Qe(n)}const ne={openModal:n=>Re(n),closeModal:()=>xe(),isModalOpen:()=>Fe(De).isOpen,setGameInput:n=>{const e=window.Furnarchy;e&&e.setGameInput(n)},saveData:(n,e,t)=>{if(typeof localStorage>"u")return;const r=`furnarchy_plugin_${n}_${e}`;try{localStorage.setItem(r,JSON.stringify(t))}catch(i){console.error(`[Furnarchy] Failed to save data for ${n}:`,i)}},loadData:(n,e)=>{if(typeof localStorage>"u")return null;const t=`furnarchy_plugin_${n}_${e}`;try{const r=localStorage.getItem(t);return r?JSON.parse(r):null}catch(r){return console.error(`[Furnarchy] Failed to load data for ${n}:`,r),null}},escape:n=>n.replace(/[&<>"']|[\u0080-\uFFFF]/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return"&#"+e.charCodeAt(0)+";"}})};class Xe{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};_enabledState=!0;get enabled(){return this._enabledState}_handlers={incoming:[],outgoing:[],loggedIn:[],pause:[],load:[],configure:[]};send(e,t){this.enabled&&this.core.send(e,t,this.metadata.id)}inject(e,t){this.enabled&&this.core.inject(e,t,this.metadata.id)}disable(){this.enabled&&(this._setEnabled(!1),this.core.notifyUpdate(this))}notify(e,t){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}this.inject(`(${ne.escape("[ðŸŸ¢]")} ${e}
`,t)}onIncoming(e,t=0){this._handlers.incoming.push({cb:e,priority:t}),this.core.invalidateHandlers()}onOutgoing(e,t=0){this._handlers.outgoing.push({cb:e,priority:t}),this.core.invalidateHandlers()}onLoggedIn(e){this._handlers.loggedIn.push(e)}onPause(e){this._handlers.pause.push(e)}onLoad(e){this._handlers.load.push(e)}onConfigure(e){this._handlers.configure.push(e)}_setEnabled(e){this._enabledState!==e&&(this._enabledState=e,this.core.invalidateHandlers(),this._handlers.pause.forEach(t=>{try{t(!e)}catch(r){console.error(r)}}))}_notifyLoggedIn(){this.enabled&&this._handlers.loggedIn.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] LoggedIn Error:`,t)}})}_notifyLoad(){this._handlers.load.forEach(e=>{try{e(this.enabled)}catch(t){console.error(`[${this.metadata.name}] Load Error:`,t)}})}_notifyConfigure(){this._handlers.configure.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] Configure Error:`,t)}})}}class vn{version="0.5.0";plugins=[];utils=ne;loadingPluginUrl=null;isLoggedIn=!1;listeners=[];gameInputEnabled=!0;_cachedIncoming=null;_cachedOutgoing=null;constructor(){this.setupInputInterception()}setupInputInterception(){if(typeof document>"u")return;const e=t=>{this.gameInputEnabled||t.stopImmediatePropagation()};document.addEventListener("keydown",e),document.addEventListener("keyup",e),document.addEventListener("keypress",e)}setGameInput(e){this.gameInputEnabled=e}invalidateHandlers(){this._cachedIncoming=null,this._cachedOutgoing=null}send(e,t,r){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,t,r){console.warn("[Furnarchy] inject() called before connection established",e)}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(t=>{try{t(e)}catch(r){console.error(r)}})}register(e,t){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(i=>i.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const r=new Xe(this);r.metadata={...r.metadata,...e},e.toggle&&r._setEnabled(!1),this.plugins.push(r);try{t(r),console.log(`[Furnarchy] Registered plugin: ${r.metadata.name} (${r.metadata.id})`)}catch(i){console.error("[Furnarchy] Error initializing plugin:",i)}this.notifyUpdate(r),r._notifyLoad()}_getSortedHandlers(e){if(e==="incoming"&&this._cachedIncoming)return this._cachedIncoming;if(e==="outgoing"&&this._cachedOutgoing)return this._cachedOutgoing;const t=[];for(const r of this.plugins){if(!r.enabled)continue;const i=e==="incoming"?r._handlers.incoming:r._handlers.outgoing;for(const o of i)t.push({...o,plugin:r})}return t.sort((r,i)=>i.priority-r.priority),e==="incoming"?this._cachedIncoming=t:this._cachedOutgoing=t,t}async _processMessage(e,t,r,i){let o=t;const l=this._getSortedHandlers(e);for(const{cb:a,plugin:u}of l)try{const s=await a(o,i,r);if(s==null)return null;o=s}catch(s){const d=e.charAt(0).toUpperCase()+e.slice(1);console.error(`[${u.metadata.name}] ${d} Error:`,s)}return o}async processIncoming(e,t=null,r=null){return this._processMessage("incoming",e,t,r)}async processOutgoing(e,t=null,r=null){return this._processMessage("outgoing",e,t,r)}notifyLoggedIn(){this.isLoggedIn=!0,console.log("[Furnarchy] User logged in, notifying plugins..."),this.plugins.forEach(e=>e._notifyLoggedIn())}}export{vn as F,fn as a,on as b,cn as c,V as d,tn as e,sn as f,Be as g,We as h,nn as i,gn as j,ln as k,hn as l,un as m,Z as p,an as r,rn as s,dn as u,ze as v};
