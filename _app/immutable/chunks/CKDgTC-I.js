import{A as C,G as b,Z as v,C as d,_ as S,a0 as $,a1 as g,N as f,M as p,D as F,a2 as w,U as O}from"./B2BHS6mp.js";function N(r,e){let t=null,n=d;var i;if(d){t=F;for(var s=S(document.head);s!==null&&(s.nodeType!==$||s.data!==r);)s=g(s);if(s===null)f(!1);else{var a=g(s);s.remove(),p(a)}}d||(i=document.head.appendChild(C()));try{b(()=>e(i),v)}finally{n&&(f(!0),p(t))}}const m=[...` 	
\r\fÂ \v\uFEFF`];function P(r,e,t){var n=r==null?"":""+r;if(t){for(var i in t)if(t[i])n=n?n+" "+i:i;else if(n.length)for(var s=i.length,a=0;(a=n.indexOf(i,a))>=0;){var o=a+s;(a===0||m.includes(n[a-1]))&&(o===n.length||m.includes(n[o]))?n=(a===0?"":n.substring(0,a))+n.substring(o+1):a=o}}return n===""?null:n}function y(r,e=!1){var t=e?" !important;":";",n="";for(var i in r){var s=r[i];s!=null&&s!==""&&(n+=" "+i+": "+s+t)}return n}function A(r,e){if(e){var t="",n,i;return Array.isArray(e)?(n=e[0],i=e[1]):n=e,n&&(t+=y(n)),i&&(t+=y(i,!0)),t=t.trim(),t===""?null:t}return String(r)}const h={isOpen:!1,title:"",body:"",onClose:void 0},u=w(h);function L(r){u.update(e=>({...h,...r,isOpen:!0}))}function M(){u.update(r=>{if(r.isOpen&&r.onClose)try{r.onClose()}catch(e){console.error("Error in modal onClose handler:",e)}return{...h}})}const D=/^(?:<img [^>]+>)?<font color='whisper'>\[ <name shortname='([^']+)' src='whisper-from'>([^<]+)<\/name> whispers, "(.*)" to you\. \]<\/font>$/;function _(r){if(r.startsWith("]B")){const e=r.substring(2).split(" ");if(e.length>=2){const t=parseInt(e[0],10),n=e[1];return{type:"set-user-info",uid:t,name:n}}}else if(r.startsWith("(")){const e=r.substring(1),t=e.match(D);return t?{type:"whisper",fromShort:t[1],from:t[2],message:t[3]}:{type:"chat",text:e}}else if(r.startsWith("]f")){const e=r.substring(2,18);return{type:"set-avatar-info",name:r.substring(18).replace(/\|/g," "),visualCode:e}}else if(r.startsWith("]&"))return{type:"load-portrait",uid:parseInt(r.substring(2),10)};return{type:"unknown",raw:r}}const l={parseServerCommand:_,escape:r=>r.replace(/[&<>"']|[\u0080-\uFFFF]/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return"&#"+e.charCodeAt(0)+";"}}),base95Encode:(r,e=0)=>{let t="";do{const n=r%95;r=Math.floor(r/95),t=String.fromCharCode(n+32)+t}while(r>0||t.length<e);return t},base95Decode:r=>{let e=0;for(let t=0;t<r.length;t++)e=e*95+(r.charCodeAt(t)-32);return e},base220Encode:(r,e=0)=>{let t="";do{const n=r%220;r=Math.floor(r/220);const i=n+35;t=t+String.fromCharCode(i)}while(r>0||t.length<e);return t},base220Decode:r=>{let e=0,t=1;for(let n=0;n<r.length;n++){const i=r.charCodeAt(n);e+=(i-35)*t,t*=220}return e}};class R{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};_enabledState=!0;get enabled(){return this._enabledState}_handlers={incoming:[],outgoing:[],loggedIn:[],connected:[],disconnected:[],ready:[],pause:[],load:[],configure:[]};_readyFired=!1;send(e,t){this.enabled&&this.core.send(e,this.metadata.id,t)}inject(e,t){this.enabled&&this.core.inject(e,this.metadata.id,t)}disable(){this.enabled&&(this._setEnabled(!1),this.core.notifyUpdate(this))}notify(e,t){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}window.__CLIENT_HOOKS?.appendChat?window.__CLIENT_HOOKS.appendChat(`${l.escape("[ðŸŸ¢]")} ${e}`):this.inject(`(${l.escape("[ðŸŸ¢]")} ${e}
`,t)}onIncoming(e,t=0){this._handlers.incoming.push({cb:e,priority:t}),this.core.invalidateHandlers()}onOutgoing(e,t=0){this._handlers.outgoing.push({cb:e,priority:t}),this.core.invalidateHandlers()}onLoggedIn(e){this._handlers.loggedIn.push(e)}onConnected(e){this._handlers.connected.push(e)}onDisconnected(e){this._handlers.disconnected.push(e)}onReady(e){if(this._handlers.ready.push(e),this._readyFired)try{e()}catch(t){console.error(`[${this.metadata.name}] Ready Error (Late):`,t)}}onPause(e){this._handlers.pause.push(e)}onLoad(e){this._handlers.load.push(e)}onConfigure(e){this._handlers.configure.push(e)}openModal(e){L(e)}closeModal(){M()}isModalOpen(){return O(u).isOpen}setGameInput(e){this.core.setGameInput(e)}saveData(e,t){if(typeof localStorage>"u")return;const n=`furnarchy_plugin_${this.metadata.id}_${e}`;try{localStorage.setItem(n,JSON.stringify(t))}catch(i){console.error(`[${this.metadata.name}] Failed to save data:`,i)}}loadData(e){if(typeof localStorage>"u")return null;const t=`furnarchy_plugin_${this.metadata.id}_${e}`;try{const n=localStorage.getItem(t);return n?JSON.parse(n):null}catch(n){return console.error(`[${this.metadata.name}] Failed to load data:`,n),null}}expose(e){this.core.registerService(e,this.metadata.id)}use(e){return this.core.getService(e)}_setEnabled(e){this._enabledState!==e&&(this._enabledState=e,this.core.invalidateHandlers(),this._handlers.pause.forEach(t=>{try{t(!e)}catch(n){console.error(n)}}))}_notifyLoggedIn(e,t){this.enabled&&this._handlers.loggedIn.forEach(n=>{try{n(e,t)}catch(i){console.error(`[${this.metadata.name}] LoggedIn Error:`,i)}})}_notifyConnected(){this.enabled&&this._handlers.connected.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] Connected Error:`,t)}})}_notifyDisconnected(){this.enabled&&this._handlers.disconnected.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] Disconnected Error:`,t)}})}_notifyReady(){this._readyFired||(this._readyFired=!0,this._handlers.ready.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] Ready Error:`,t)}}))}_notifyLoad(){this._handlers.load.forEach(e=>{try{e(this.enabled)}catch(t){console.error(`[${this.metadata.name}] Load Error:`,t)}})}_notifyConfigure(){this._handlers.configure.forEach(e=>{try{e()}catch(t){console.error(`[${this.metadata.name}] Configure Error:`,t)}})}}class U{version="0.9.2";plugins=[];services=new Map;utils=l;loadingPluginUrl=null;isLoggedIn=!1;characterName=null;characterUid=null;isReady=!1;_motdComplete=!1;listeners=[];gameInputEnabled=!0;_cachedIncoming=null;_cachedOutgoing=null;constructor(){this.setupInputInterception()}setupInputInterception(){if(typeof document>"u")return;const e=t=>{this.gameInputEnabled||t.stopImmediatePropagation()};document.addEventListener("keydown",e),document.addEventListener("keyup",e),document.addEventListener("keypress",e)}setGameInput(e){this.gameInputEnabled=e}invalidateHandlers(){this._cachedIncoming=null,this._cachedOutgoing=null}start(){this.isReady||(this.isReady=!0,console.log("[Furnarchy] Starting plugins..."),this.plugins.forEach(e=>e._notifyReady()))}send(e,t,n){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,t,n){console.warn("[Furnarchy] inject() called before connection established",e)}registerService(e,t){if(!e.name||!e.version){console.error("[Furnarchy] Service registration failed: Missing 'name' or 'version'",e);return}this.services.has(e.name)&&console.warn(`[Furnarchy] Service '${e.name}' is already registered. Overwriting.`),this.services.set(e.name,{service:e,providerId:t}),console.log(`[Furnarchy] Service registered: ${e.name} v${e.version} by ${t}`)}getService(e){const t=this.services.get(e);return t?t.service:null}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(t=>{try{t(e)}catch(n){console.error(n)}})}register(e,t){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(i=>i.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const n=new R(this);n.metadata={...n.metadata,...e},e.toggle&&n._setEnabled(!1),this.plugins.push(n);try{t(n),console.log(`[Furnarchy] Registered plugin: ${n.metadata.name} (${n.metadata.id})`)}catch(i){console.error("[Furnarchy] Error initializing plugin:",i)}this.notifyUpdate(n),n._notifyLoad(),this.isReady&&n._notifyReady()}_getSortedHandlers(e){if(e==="incoming"&&this._cachedIncoming)return this._cachedIncoming;if(e==="outgoing"&&this._cachedOutgoing)return this._cachedOutgoing;const t=[];for(const n of this.plugins){if(!n.enabled)continue;const i=e==="incoming"?n._handlers.incoming:n._handlers.outgoing;for(const s of i)t.push({...s,plugin:n})}return t.sort((n,i)=>i.priority-n.priority),e==="incoming"?this._cachedIncoming=t:this._cachedOutgoing=t,t}async _processMessage(e,t,n,i){let s=t;const a=this._getSortedHandlers(e);for(const{cb:o,plugin:E}of a)try{const c=await o(s,n,i);if(c==null)return null;s=c}catch(c){const I=e.charAt(0).toUpperCase()+e.slice(1);console.error(`[${E.metadata.name}] ${I} Error:`,c)}return s}async processIncoming(e,t=null,n=null){if(!this._motdComplete)return e.includes("Dragonroar")&&(this._motdComplete=!0),e;const i=_(e);return i.type==="set-user-info"&&this.notifyLoggedIn(i.name,i.uid.toString()),this._processMessage("incoming",e,t,n)}async processOutgoing(e,t=null,n=null){return this._processMessage("outgoing",e,t,n)}notifyLoggedIn(e,t){this.isLoggedIn=!0,this.characterName=e,this.characterUid=t,console.log(`[Furnarchy] User logged in as ${e} (${t}), notifying plugins...`),this.plugins.forEach(n=>n._notifyLoggedIn(e,t))}notifyConnected(){console.log("[Furnarchy] Connected to server, notifying plugins..."),this._motdComplete=!1,this.plugins.forEach(e=>e._notifyConnected())}notifyDisconnected(){this.isLoggedIn=!1,console.log("[Furnarchy] Disconnected from server, notifying plugins..."),this.plugins.forEach(e=>e._notifyDisconnected())}getExposedAPI(){return{register:this.register.bind(this),version:this.version,utils:this.utils}}}const G=new U;export{U as F,P as a,M as c,G as f,N as h,u as m,A as t};
