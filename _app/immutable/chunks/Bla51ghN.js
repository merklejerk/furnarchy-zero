import{G as ne,C as S,H as ae,h as J,a6 as oe,J as ie,K as se,L as Y,M as F,N as C,D as P,a0 as le,aP as fe,ax as ue,w as T,B as D,A as G,F as ce,Q as de,ap as V,aN as z,aQ as B,aR as ve,x as Q,z as ge,aS as he,aT as me,aU as L,a1 as pe,aV as _e,aW as ye,aM as Se,y as Ee,q as be,aX as Ie,aY as we,aZ as Ne,a_ as Ae,a$ as Te,b0 as ke,ai as Me,u as Pe,r as Ce,b1 as Le,a2 as Oe}from"./B2BHS6mp.js";import{a as xe}from"./C5Ogm6AN.js";function Qe(e,r){return r}function Ue(e,r,t){for(var l=[],s=r.length,a=0;a<s;a++)_e(r[a].e,l,!0);ye(l,()=>{var o=l.length===0&&t!==null;if(o){var n=t,u=n.parentNode;Se(u),u.append(n),e.items.clear(),m(e,r[0].prev,r[s-1].next)}for(var i=0;i<s;i++){var c=r[i];o||(e.items.delete(c.k),m(e,c.prev,c.next)),Ee(c.e,!o)}e.first===r[0]&&(e.first=r[0].prev)})}function We(e,r,t,l,s,a=null){var o=e,n=new Map,u=null;S&&ae();var i=null,c=oe(()=>{var h=t();return B(h)?h:h==null?[]:z(h)}),d,g=!0;function p(){De(v,d,o,r,l),i!==null&&(d.length===0?(i.fragment?(o.before(i.fragment),i.fragment=null):Q(i.effect),f.first=i.effect):ge(i.effect,()=>{i=null}))}var f=ne(()=>{d=J(c);var h=d.length;let b=!1;if(S){var _=ie(o)===se;_!==(h===0)&&(o=Y(),F(o),C(!1),b=!0)}for(var k=new Set,I=T,N=null,A=ce(),E=0;E<h;E+=1){S&&P.nodeType===le&&P.data===fe&&(o=P,b=!0,C(!1));var M=d[E],w=l(M,E),y=g?null:n.get(w);y?(ue(y.v,M),y.i=E,A&&I.skipped_effects.delete(y.e)):(y=Re(g?o:null,N,M,w,E,s,r,t),g&&(y.o=!0,N===null?u=y:N.next=y,N=y),n.set(w,y)),k.add(w)}if(h===0&&a&&!i)if(g)i={fragment:null,effect:D(()=>a(o))};else{var $=document.createDocumentFragment(),H=G();$.append(H),i={fragment:$,effect:D(()=>a(H))}}if(S&&h>0&&F(Y()),!g)if(A){for(const[re,te]of n)k.has(re)||I.skipped_effects.add(te.e);I.oncommit(p),I.ondiscard(()=>{})}else p();b&&C(!0),J(c)}),v={effect:f,items:n,first:u};g=!1,S&&(o=P)}function De(e,r,t,l,s){var a=r.length,o=e.items,n=e.first,u,i=null,c=[],d=[],g,p,f,v;for(v=0;v<a;v+=1){if(g=r[v],p=s(g,v),f=o.get(p),e.first??=f,!f.o){f.o=!0;var h=i?i.next:n;m(e,i,f),m(e,f,h),O(f,h,t),i=f,c=[],d=[],n=i.next;continue}if((f.e.f&L)!==0&&Q(f.e),f!==n){if(u!==void 0&&u.has(f)){if(c.length<d.length){var b=d[0],_;i=b.prev;var k=c[0],I=c[c.length-1];for(_=0;_<c.length;_+=1)O(c[_],b,t);for(_=0;_<d.length;_+=1)u.delete(d[_]);m(e,k.prev,I.next),m(e,i,k),m(e,I,b),n=b,i=I,v-=1,c=[],d=[]}else u.delete(f),O(f,n,t),m(e,f.prev,f.next),m(e,f,i===null?e.first:i.next),m(e,i,f),i=f;continue}for(c=[],d=[];n!==null&&n.k!==p;)(n.e.f&L)===0&&(u??=new Set).add(n),d.push(n),n=n.next;if(n===null)continue;f=n}c.push(f),i=f,n=f.next}let N=o.size>a;if(n!==null||u!==void 0){for(var A=u===void 0?[]:z(u);n!==null;)(n.e.f&L)===0&&A.push(n),n=n.next;var E=A.length;if(N=o.size-E>a,E>0){var M=null;Ue(e,A,M)}}if(N)for(const w of o.values())w.o||(m(e,i,w),i=w);e.effect.last=i&&i.e}function Re(e,r,t,l,s,a,o,n){var u=(o&he)!==0,i=(o&me)===0,c=u?i?de(t,!1,!1):V(t):t,d=(o&ve)===0?s:V(s),g={i:d,v:c,k:l,a:null,e:null,o:!1,prev:r,next:null};try{if(e===null){var p=document.createDocumentFragment();p.append(e=G())}return g.e=D(()=>a(e,c,d,n)),r!==null&&(r.next=g),g}finally{}}function O(e,r,t){for(var l=e.next?e.next.e.nodes_start:t,s=r?r.e.nodes_start:t,a=e.e.nodes_start;a!==null&&a!==l;){var o=pe(a);s.before(a),a=o}}function m(e,r,t){r===null?(e.first=t,e.effect.first=t&&t.e):(r.e.next&&(r.e.next.prev=null),r.next=t,r.e.next=t&&t.e),t!==null&&(t.e.prev&&(t.e.prev.next=null),t.prev=r,t.e.prev=r&&r.e)}function Xe(e,r,t,l,s,a){var o=e.__className;if(S||o!==t||o===void 0){var n=xe(t,l,a);(!S||n!==e.getAttribute("class"))&&(n==null?e.removeAttribute("class"):e.className=n),e.__className=t}else if(a&&s!==a)for(var u in a){var i=!!a[u];(s==null||i!==!!s[u])&&e.classList.toggle(u,i)}return a}const $e=Symbol("is custom element"),He=Symbol("is html");function Ze(e){if(S){var r=!1,t=()=>{if(!r){if(r=!0,e.hasAttribute("value")){var l=e.value;q(e,"value",null),e.value=l}if(e.hasAttribute("checked")){var s=e.checked;q(e,"checked",null),e.checked=s}}};e.__on_r=t,be(t),Ie()}}function q(e,r,t,l){var s=Je(e);S&&(s[r]=e.getAttribute(r),r==="src"||r==="srcset"||r==="href"&&e.nodeName==="LINK")||s[r]!==(s[r]=t)&&(r==="loading"&&(e[we]=t),t==null?e.removeAttribute(r):typeof t!="string"&&Ye(e).includes(r)?e[r]=t:e.setAttribute(r,t))}function Je(e){return e.__attributes??={[$e]:e.nodeName.includes("-"),[He]:e.namespaceURI===Ne}}var K=new Map;function Ye(e){var r=e.getAttribute("is")||e.nodeName,t=K.get(r);if(t)return t;K.set(r,t=[]);for(var l,s=e,a=Element.prototype;a!==s;){l=Te(s);for(var o in l)l[o].set&&t.push(o);s=Ae(s)}return t}function je(e,r,t=r){var l=new WeakSet;ke(e,"input",async s=>{var a=s?e.defaultValue:e.value;if(a=x(e)?U(a):a,t(a),T!==null&&l.add(T),await Me(),a!==(a=r())){var o=e.selectionStart,n=e.selectionEnd,u=e.value.length;if(e.value=a??"",n!==null){var i=e.value.length;o===n&&n===u&&i>u?(e.selectionStart=i,e.selectionEnd=i):(e.selectionStart=o,e.selectionEnd=Math.min(n,i))}}}),(S&&e.defaultValue!==e.value||Pe(r)==null&&e.value)&&(t(x(e)?U(e.value):e.value),T!==null&&l.add(T)),Ce(()=>{var s=r();if(e===document.activeElement){var a=Le??T;if(l.has(a))return}x(e)&&s===U(e.value)||e.type==="date"&&!s&&!e.value||s!==e.value&&(e.value=s??"")})}function x(e){var r=e.type;return r==="number"||r==="range"}function U(e){return e===""?null:+e}function er(e){return function(...r){var t=r[0];return t.stopPropagation(),e?.apply(this,r)}}function rr(e,r){var t=e.$$events?.[r.type],l=B(t)?t.slice():t==null?[]:[t];for(var s of l)s.call(this,r)}const tr=globalThis.__sveltekit_1apjots.env;async function Fe(e){let r;try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}`);r=await t.text()}catch(t){throw new Error(`Failed to fetch plugin: ${t.message}`)}return new Promise((t,l)=>{const s=Math.random().toString(36).substring(7),a=document.createElement("iframe");a.style.display="none",a.setAttribute("sandbox","allow-scripts");let o;const n=()=>{o&&clearTimeout(o),window.removeEventListener("message",u),document.body.contains(a)&&document.body.removeChild(a)},u=p=>{const f=p.data;if(!f||f.type!=="furnarchy-plugin-register"||f.requestId!==s)return;const v=f.plugin;if(!v.id||!v.name||!v.version){n(),l(new Error("Plugin registered but missing id, name, or version"));return}t({id:v.id,name:v.name,description:v.description,version:v.version,author:v.author,sourceUrl:e,toggle:v.toggle}),n()};window.addEventListener("message",u);const i=`
            window.Furnarchy = {
                version: '0.0.0-sandbox',
                loadingPluginUrl: ${JSON.stringify(e)},
                register: function(meta, arg) {
                    if (typeof arg === 'function') {
                        // Send metadata immediately
                        window.parent.postMessage({
                            type: 'furnarchy-plugin-register',
                            requestId: '${s}',
                            plugin: meta
                        }, '*');

                        const api = {
                            send: function() {},
                            inject: function() {},
                            notify: function() {},
                            disable: function() {},
                            onIncoming: function() {},
                            onOutgoing: function() {},
                            onLoggedIn: function() {},
                            onPause: function() {},
                            onLoad: function() {}
                        };
                        try { arg(api); } catch(e) {}
                    }
                },
                onRegister: function() {},
                send: function() {}
            };
        `,d=`
            try {
                const content = decodeURIComponent(escape(atob('${btoa(unescape(encodeURIComponent(r)))}')));
                const script = document.createElement('script');
                script.textContent = content;
                document.body.appendChild(script);
            } catch(e) {
                console.error('Sandbox execution error:', e);
            }
        `,g=`
            <!DOCTYPE html>
            <html>
            <head>
                <script>${i}<\/script>
            </head>
            <body>
                <script>${d}<\/script>
            </body>
            </html>
        `;a.srcdoc=g,document.body.appendChild(a),o=setTimeout(()=>{n(),l(new Error("Plugin load timed out (5s) - did not call Furnarchy.register()?"))},5e3)})}const R="furnarchy_plugins",W="furnarchy_deleted_plugins",X="furnarchy_auth_url",Z="furnarchy_version",j=Oe([]);function ee(){if(typeof localStorage>"u")return[];const e=localStorage.getItem(W);if(!e)return[];try{return JSON.parse(e)}catch{return[]}}function nr(e){if(typeof localStorage>"u")return;const r=ee();r.includes(e)||(r.push(e),localStorage.setItem(W,JSON.stringify(r)))}function Ve(){if(typeof localStorage>"u")return[];const e=localStorage.getItem(R);if(!e)return[];try{const r=JSON.parse(e);return Array.isArray(r)?r.map(t=>typeof t=="string"?{url:t}:t):[]}catch(r){return console.error("Failed to load plugins",r),[]}}function qe(e){typeof localStorage>"u"||(localStorage.setItem(R,JSON.stringify(e)),j.set(e))}function ar(e,r){j.update(t=>{const l=t.findIndex(n=>n.url===e);if(l===-1)return t;const s=t[l],a={...s,...r};if(JSON.stringify(s)===JSON.stringify(a))return t;const o=[...t];return o[l]=a,typeof localStorage<"u"&&localStorage.setItem(R,JSON.stringify(o)),o})}function or(){return typeof localStorage>"u"?null:localStorage.getItem(X)}function ir(e){typeof localStorage>"u"||localStorage.setItem(X,e)}function Ke(){return typeof localStorage>"u"?null:localStorage.getItem(Z)}function Ge(e){typeof localStorage>"u"||localStorage.setItem(Z,e)}async function sr(e){if(typeof localStorage>"u")return;const r=Ke();let t=Ve();const l=["/plugins/auto-spinner.js","/plugins/wire-shrek.js"],s=ee();let a=!1;for(const o of l)if(!t.some(n=>n.url===o))try{const n=await Fe(o);if(s.includes(n.id)){console.log(`Skipping deleted default plugin: ${n.name} (${n.id})`);continue}t.push({id:n.id,url:o,name:n.name,description:n.description,version:n.version,author:n.author,enabled:typeof n.toggle=="boolean"?!n.toggle:!0}),a=!0}catch(n){console.error(`Failed to load default plugin ${o}:`,n)}a&&qe(t),r!==e&&Ge(e)}export{or as a,je as b,tr as c,q as d,We as e,er as f,Ve as g,qe as h,Qe as i,ir as j,rr as k,sr as l,nr as m,j as p,Ze as r,Xe as s,ar as u,Fe as v};
