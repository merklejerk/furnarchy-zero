import{A as S,G as F,Z as k,C as p,_ as M,a0 as O,a1 as $,N as _,M as v,D as L,a2 as H,U as x}from"./B2BHS6mp.js";function X(t,e){let r=null,s=p;var a;if(p){r=L;for(var i=M(document.head);i!==null&&(i.nodeType!==O||i.data!==t);)i=$(i);if(i===null)_(!1);else{var u=$(i);i.remove(),v(u)}}p||(a=document.head.appendChild(S()));try{F(()=>e(a),k)}finally{s&&(_(!0),v(r))}}const C=[...` 	
\r\fÂ \v\uFEFF`];function Y(t,e,r){var s=t==null?"":""+t;if(r){for(var a in r)if(r[a])s=s?s+" "+a:a;else if(s.length)for(var i=a.length,u=0;(u=s.indexOf(a,u))>=0;){var g=u+i;(u===0||C.includes(s[u-1]))&&(g===s.length||C.includes(s[g]))?s=(u===0?"":s.substring(0,u))+s.substring(g+1):u=g}}return s===""?null:s}function E(t,e=!1){var r=e?" !important;":";",s="";for(var a in t){var i=t[a];i!=null&&i!==""&&(s+=" "+a+": "+i+r)}return s}function z(t,e){if(e){var r="",s,a;return Array.isArray(e)?(s=e[0],a=e[1]):s=e,s&&(r+=E(s)),a&&(r+=E(a,!0)),r=r.trim(),r===""?null:r}return String(t)}const m={isOpen:!1,title:"",body:"",onClose:void 0},b=H(m);function R(t){b.update(e=>({...m,...t,isOpen:!0}))}function T(){b.update(t=>{if(t.isOpen&&t.onClose)try{t.onClose()}catch(e){console.error("Error in modal onClose handler:",e)}return{...m}})}function d(t,e=0){let r="";do{const s=t%95;t=Math.floor(t/95),r=String.fromCharCode(s+32)+r}while(t>0||r.length<e);return r}function l(t){let e=0;for(let r=0;r<t.length;r++)e=e*95+(t.charCodeAt(r)-32);return e}function n(t,e=0){let r="";do{const s=t%220;t=Math.floor(t/220);const a=s+35;r=r+String.fromCharCode(a)}while(t>0||r.length<e);return r}function o(t){let e=0,r=1;for(let s=0;s<t.length;s++){const a=t.charCodeAt(s);e+=(a-35)*r,r*=220}return e}const D=/^(?:<img [^>]+>)?<font color='whisper'>\[ <name shortname='([^']+)' src='whisper-from'>([^<]+)<\/name> whispers, "(.*)" to you\. \]<\/font>$/,N=/^<font color='myspeech'>You say, "(.*)"<\/font>$/,A=/^<name shortname='([^']+)'>([^<]+)<\/name>: (.*)$/,P=/^<font color='emote'><name shortname='([^']+)'>([^<]+)<\/name> (.*)<\/font>$/;function w(t){if(t.startsWith("]B")){const e=t.substring(2).split(" ");if(e.length>=2){const r=parseInt(e[0],10),s=e[1];return{type:"set-user-info",uid:r,name:s}}}else if(t.startsWith("(")){const e=t.substring(1),r=e.match(D);if(r)return{type:"whisper",fromShort:r[1],from:r[2],message:r[3]};const s=e.match(N);if(s)return{type:"speech",message:s[1],isSelf:!0};const a=e.match(A);if(a)return{type:"speech",fromShort:a[1],from:a[2],message:a[3],isSelf:!1};const i=e.match(P);return i?{type:"emote",fromShort:i[1],from:i[2],message:i[3]}:{type:"chat",text:e}}else if(t.startsWith("]f")){const e=t.substring(2,18);return{type:"set-avatar-info",name:t.substring(18).replace(/\|/g," "),visualCode:e}}else{if(t.startsWith("]&"))return{type:"load-portrait",uid:parseInt(t.substring(2),10)};if(t.startsWith("]W")){const e=o(t.substring(2,4)),r=o(t.substring(4,6)),s=o(t.substring(6,8)),a=o(t.substring(8,12));return{type:"map-metadata",width:e,height:r,version:s,flags:a}}else{if(t.startsWith("]q"))return{type:"load-dream",patch:t.substring(2)};if(t.startsWith("]M%")){let e=4;const r=[];for(;e+8<=t.length;){const s=o(t.substring(e,e+1)),a=o(t.substring(e+2,e+3)),i=o(t.substring(e+3,e+4)),u=o(t.substring(e+4,e+8)),g=a+220*(i>>1);r.push({version:s,id:g,checksum:u}),e+=8}return{type:"avatar-manifest",records:r}}else if(t.startsWith("]-")||t.startsWith("]P")){const e=t.substring(2,4),r=t.substring(4);return{type:"chat-buffer",subType:e,content:r}}else{if(t.startsWith("]G"))return{type:"name-visibility",visible:t[2]==="0"};if(t.startsWith("]j"))return{type:"play-music",trackId:o(t.substring(2,4))};if(t.startsWith("]s")){const e=o(t.substring(2,4)),r=o(t.substring(4,6)),s=t.substring(6,6+r);return{type:"set-tag",tagType:e,tag:s}}else{if(t.startsWith("]#"))return{type:"dialog-box",content:t.substring(2)};if(t.startsWith("]?"))return{type:"pounce-update",data:t.substring(2)};if(t.startsWith("]H")){const e=o(t.substring(2,6)),r=o(t.substring(6,8)),s=o(t.substring(8,10));return{type:"set-offsets",uid:e,yl:r,al:s}}else if(t.startsWith("]_")){const e=o(t.substring(2,6)),r=o(t.substring(6,7));return{type:"set-scale",uid:e,scale:r}}else if(t.startsWith("]O")){const e=o(t.substring(2,6)),r=o(t.substring(6,8));return{type:"set-gloam",uid:e,gloam:r}}else{if(t.startsWith("]I"))return{type:"batch-particle",data:t.substring(2)};if(t.startsWith("]v")){const e=l(t.substring(2,4)),r=l(t.substring(4,6)),s=t.charCodeAt(6);return{type:"legacy-visual-effect",x:e,y:r,effectId:s}}else if(t.startsWith("@")){const e=l(t.substring(1,3)),r=l(t.substring(3,5));return{type:"camera-sync",x:e,y:r}}else if(t.startsWith("<")){const e=o(t.substring(1,5)),r=o(t.substring(5,7)),s=o(t.substring(7,9)),a=o(t.substring(9,10)),i=o(t.substring(10,11)),u=o(t.substring(11,12)),g=t.substring(12,12+u),h=12+u,c=t[h]==="w"?16:14,f=t.substring(h,h+c),I=o(t.substring(h+c+1,h+c+5)),W=o(t.substring(h+c+5,h+c+6));return{type:"add-avatar",uid:e,x:r,y:s,direction:a,pose:i,name:g,colorCode:f,afkTime:I,scale:W}}else if(t.startsWith("/")||t.startsWith("A")){const e=t.startsWith("/")?"walk":"teleport",r=o(t.substring(1,5)),s=o(t.substring(5,7)),a=o(t.substring(7,9)),i=o(t.substring(9,10)),u=o(t.substring(10,11));return{type:"move-avatar",uid:r,x:s,y:a,direction:i,pose:u,moveType:e}}else if(t.startsWith("B")){const e=o(t.substring(1,5)),r=o(t.substring(5,6)),s=o(t.substring(6,7)),a=t.substring(7);return{type:"update-avatar-appearance",uid:e,direction:r,pose:s,colorCode:a}}else{if(t.startsWith("C"))return{type:"remove-object",uid:o(t.substring(1,5))};if(t.startsWith(")"))return{type:"delete-object",uid:o(t.substring(1,5))};if(t.startsWith("D"))return{type:"dragonroar",message:t.substring(1)};if(t.startsWith("!"))return{type:"play-sound",soundId:o(t.substring(1,2))};if(["1","2",">","4","5","E","F"].includes(t[0]))return{type:"update-map",layer:{1:"floor",2:"wall",">":"item",4:"region",5:"effect",E:"lighting",F:"ambience"}[t[0]],data:t.substring(1)};if(t.startsWith("&"))return{type:"login-ready"};if(t.startsWith(";"))return{type:"load-map-legacy",mapName:t.substring(1)};if(t.startsWith("0"))return{type:"ds-variable",data:t.substring(1)};if(t.startsWith("3"))return{type:"ds-string",data:t.substring(1)};if(t.startsWith("6"))return{type:"ds-trigger-server",data:t.substring(1)};if(t.startsWith("7"))return{type:"ds-trigger-client",data:t.substring(1)};if(t.startsWith("8"))return{type:"ds-init",data:t.substring(1)}}}}}}}return{type:"unknown",raw:t}}function U(t){if(t.startsWith('"'))return{type:"speech",message:t.substring(1)};if(t.startsWith(":"))return{type:"emote",message:t.substring(1)};if(t.startsWith("wh ")){const e=t.substring(3).split(" "),r=e[0],s=e.slice(1).join(" ");return{type:"whisper",target:r,message:s}}else{if(t.startsWith("m "))return{type:"move",direction:parseInt(t.substring(2),10)};if(t==="<")return{type:"rotate",direction:"left"};if(t===">")return{type:"rotate",direction:"right"};if(t==="get")return{type:"get"};if(t==="use")return{type:"use"};if(t==="sit")return{type:"sit"};if(t==="stand")return{type:"stand"};if(t==="liedown")return{type:"liedown"};if(t.startsWith("loginNG "))return{type:"login",auth:t.substring(8)};if(t.startsWith("l")){if(t.length>=5){const e=o(t.substring(1,3)),r=o(t.substring(3,5));return{type:"look",x:e,y:r}}}else{if(t==="vascodagama")return{type:"ready"};if(t==="quit")return{type:"quit"};if(t==="iamhere")return{type:"keep-alive"};if(t.startsWith("desc "))return{type:"set-desc",description:t.substring(5)};if(t.startsWith("color "))return{type:"set-color",data:t.substring(6)};if(t.startsWith("costume "))return{type:"costume",args:t.substring(8)};if(t.startsWith("afk")){if(t==="afk")return{type:"afk"};if(t.startsWith("afk "))return{type:"afk",message:t.substring(4)}}else{if(t==="unafk")return{type:"unafk"};if(t.startsWith("dsbtn "))return{type:"ds-btn",id:parseInt(t.substring(6),10)};if(t==="portrchng")return{type:"portrait-change"}}}}return{type:"unknown",raw:t}}function G(t){switch(t.type){case"set-user-info":return`]B${t.uid} ${t.name}`;case"chat":return`(${t.text}`;case"whisper":return`(<font color='whisper'>[ <name shortname='${t.fromShort}' src='whisper-from'>${t.from}</name> whispers, "${t.message}" to you. ]</font>`;case"speech":return t.isSelf?`(<font color='myspeech'>You say, "${t.message}"</font>`:`(<name shortname='${t.fromShort}'>${t.from}</name>: ${t.message}`;case"emote":return`(<font color='emote'><name shortname='${t.fromShort}'>${t.from}</name> ${t.message}</font>`;case"set-avatar-info":return`]f${t.visualCode}${t.name.replace(/ /g,"|")}`;case"load-portrait":return`]&${t.uid}`;case"camera-sync":return`@${d(t.x,2)}${d(t.y,2)}`;case"add-avatar":return`<${n(t.uid,4)}${n(t.x,2)}${n(t.y,2)}${n(t.direction,1)}${n(t.pose,1)}${n(t.name.length,1)}${t.name}${t.colorCode}${n(0,1)}${n(t.afkTime,4)}${n(t.scale,1)}`;case"move-avatar":return`${t.moveType==="walk"?"/":"A"}${n(t.uid,4)}${n(t.x,2)}${n(t.y,2)}${n(t.direction,1)}${n(t.pose,1)}`;case"update-avatar-appearance":return`B${n(t.uid,4)}${n(t.direction,1)}${n(t.pose,1)}${t.colorCode}`;case"remove-object":return`C${n(t.uid,4)}`;case"delete-object":return`)${n(t.uid,4)}`;case"dragonroar":return`D${t.message}`;case"play-sound":return`!${n(t.soundId,1)}`;case"map-metadata":return`]W${n(t.width,2)}${n(t.height,2)}${n(t.version,2)}${n(t.flags,4)}`;case"load-dream":return`]q${t.patch}`;case"avatar-manifest":{let e="]M% ";for(const r of t.records){const s=Math.floor(r.id/220)<<1|0,a=r.id%220;e+=n(r.version,1),e+=n(0,1),e+=n(a,1),e+=n(s,1),e+=n(r.checksum,4)}return e}case"chat-buffer":return`]-${t.subType}${t.content}`;case"name-visibility":return`]G${t.visible?"0":"1"}`;case"play-music":return`]j${n(t.trackId,2)}`;case"set-tag":return`]s${n(t.tagType,2)}${n(t.tag.length,2)}${t.tag}`;case"dialog-box":return`]#${t.content}`;case"pounce-update":return`]?${t.data}`;case"set-offsets":return`]H${n(t.uid,4)}${n(t.yl,2)}${n(t.al,2)}`;case"set-scale":return`]_${n(t.uid,4)}${n(t.scale,1)}`;case"set-gloam":return`]O${n(t.uid,4)}${n(t.gloam,2)}`;case"batch-particle":return`]I${t.data}`;case"legacy-visual-effect":return`]v${d(t.x,2)}${d(t.y,2)}${String.fromCharCode(t.effectId)}`;case"update-map":return`${{floor:"1",wall:"2",item:">",region:"4",effect:"5",lighting:"E",ambience:"F"}[t.layer]}${t.data}`;case"login-ready":return"&";case"load-map-legacy":return`;${t.mapName}`;case"ds-variable":return`0${t.data}`;case"ds-string":return`3${t.data}`;case"ds-trigger-server":return`6${t.data}`;case"ds-trigger-client":return`7${t.data}`;case"ds-init":return`8${t.data}`;case"unknown":return t.raw}}function j(t){switch(t.type){case"move":return`m ${t.direction}`;case"rotate":return t.direction==="left"?"<":">";case"look":return`l${n(t.x,2)}${n(t.y,2)}`;case"speech":return`"${t.message}`;case"emote":return`:${t.message}`;case"whisper":return`wh ${t.target} ${t.message}`;case"get":return"get";case"use":return"use";case"sit":return"sit";case"stand":return"stand";case"liedown":return"liedown";case"login":return`loginNG ${t.auth}`;case"ready":return"vascodagama";case"quit":return"quit";case"keep-alive":return"iamhere";case"set-desc":return`desc ${t.description}`;case"set-color":return`color ${t.data}`;case"costume":return`costume ${t.args}`;case"afk":return t.message?`afk ${t.message}`:"afk";case"unafk":return"unafk";case"ds-btn":return`dsbtn ${t.id}`;case"portrait-change":return"portrchng";case"unknown":return t.raw}}const y={parseServerCommand:w,parseClientCommand:U,createServerCommand:G,createClientCommand:j,escape:t=>t.replace(/[&<>"']|[\u0080-\uFFFF]/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return"&#"+e.charCodeAt(0)+";"}}),base95Encode:d,base95Decode:l,base220Encode:n,base220Decode:o,getShortname:t=>{let e=t;return e=e.replace(/&(?:[Aa]grave|acute|circ|tilde|uml|ring)|AElig|aelig;/g,"a"),e=e.replace(/&[Cc]edil;/g,"c"),e=e.replace(/&[Ee]grave|acute|circ|uml;/g,"e"),e=e.replace(/&[Ii]grave|acute|circ|uml;/g,"i"),e=e.replace(/&ETH;/g,"d"),e=e.replace(/&[Nn]tilde;/g,"n"),e=e.replace(/&(?:[Oo]grave|acute|tilde|uml)|oslash|Ocirc|oric;/g,"o"),e=e.replace(/&[Uu]grave|acute|circ|uml;/g,"u"),e=e.replace(/&(?:[Yy]acute)|yuml;/g,"y"),e=e.replace(/&euro;/g,"e"),e=e.replace(/[^A-Za-z0-9]/g,""),e.toLowerCase()}};class q{constructor(e){this.core=e,e.loadingPluginUrl&&(this.metadata.sourceUrl=e.loadingPluginUrl)}metadata={id:"",name:"Unknown Plugin",version:"0.0.0"};_enabledState=!0;get enabled(){return this._enabledState}_handlers={incoming:[],outgoing:[],loggedIn:[],connected:[],disconnected:[],ready:[],pause:[],load:[],configure:[]};_readyFired=!1;send(e,r){this.enabled&&this.core.send(e,this.metadata.id,r)}inject(e,r){this.enabled&&this.core.inject(e,this.metadata.id,r)}disable(){this.enabled&&(this._setEnabled(!1),this.core.notifyUpdate(this))}notify(e,r){if(!this.core.isLoggedIn){console.log(`[${this.metadata.name}] ${e}`);return}window.__CLIENT_HOOKS?.appendChat?window.__CLIENT_HOOKS.appendChat(`${y.escape("[ðŸŸ¢]")} ${e}`):this.inject(`(${y.escape("[ðŸŸ¢]")} ${e}
`,r)}onIncoming(e,r=0){this._handlers.incoming.push({cb:e,priority:r}),this.core.invalidateHandlers()}onOutgoing(e,r=0){this._handlers.outgoing.push({cb:e,priority:r}),this.core.invalidateHandlers()}onLoggedIn(e){this._handlers.loggedIn.push(e)}onConnected(e){this._handlers.connected.push(e)}onDisconnected(e){this._handlers.disconnected.push(e)}onReady(e){if(this._handlers.ready.push(e),this._readyFired)try{e()}catch(r){console.error(`[${this.metadata.name}] Ready Error (Late):`,r)}}onPause(e){this._handlers.pause.push(e)}onLoad(e){this._handlers.load.push(e)}onConfigure(e){this._handlers.configure.push(e)}openModal(e){R(e)}closeModal(){T()}isModalOpen(){return x(b).isOpen}setGameInput(e){this.core.setGameInput(e)}saveData(e,r){if(typeof localStorage>"u")return;const s=`furnarchy_plugin_${this.metadata.id}_${e}`;try{localStorage.setItem(s,JSON.stringify(r))}catch(a){console.error(`[${this.metadata.name}] Failed to save data:`,a)}}loadData(e){if(typeof localStorage>"u")return null;const r=`furnarchy_plugin_${this.metadata.id}_${e}`;try{const s=localStorage.getItem(r);return s?JSON.parse(s):null}catch(s){return console.error(`[${this.metadata.name}] Failed to load data:`,s),null}}expose(e){this.core.registerService(e,this.metadata.id)}use(e){return this.core.getService(e)}_setEnabled(e){this._enabledState!==e&&(this._enabledState=e,this.core.invalidateHandlers(),this._handlers.pause.forEach(r=>{try{r(!e)}catch(s){console.error(s)}}))}_notifyLoggedIn(e,r){this.enabled&&this._handlers.loggedIn.forEach(s=>{try{s(e,r)}catch(a){console.error(`[${this.metadata.name}] LoggedIn Error:`,a)}})}_notifyConnected(){this.enabled&&this._handlers.connected.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] Connected Error:`,r)}})}_notifyDisconnected(){this.enabled&&this._handlers.disconnected.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] Disconnected Error:`,r)}})}_notifyReady(){this._readyFired||(this._readyFired=!0,this._handlers.ready.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] Ready Error:`,r)}}))}_notifyLoad(){this._handlers.load.forEach(e=>{try{e(this.enabled)}catch(r){console.error(`[${this.metadata.name}] Load Error:`,r)}})}_notifyConfigure(){this._handlers.configure.forEach(e=>{try{e()}catch(r){console.error(`[${this.metadata.name}] Configure Error:`,r)}})}}class B{version="0.10.0";plugins=[];services=new Map;utils=y;loadingPluginUrl=null;isLoggedIn=!1;characterName=null;characterUid=null;isReady=!1;_motdComplete=!1;listeners=[];gameInputEnabled=!0;_cachedIncoming=null;_cachedOutgoing=null;constructor(){this.setupInputInterception()}setupInputInterception(){if(typeof document>"u")return;const e=r=>{this.gameInputEnabled||r.stopImmediatePropagation()};document.addEventListener("keydown",e),document.addEventListener("keyup",e),document.addEventListener("keypress",e)}setGameInput(e){this.gameInputEnabled=e}invalidateHandlers(){this._cachedIncoming=null,this._cachedOutgoing=null}start(){this.isReady||(this.isReady=!0,console.log("[Furnarchy] Starting plugins..."),this.plugins.forEach(e=>e._notifyReady()))}send(e,r,s){console.warn("[Furnarchy] send() called before connection established",e)}inject(e,r,s){console.warn("[Furnarchy] inject() called before connection established",e)}registerService(e,r){if(!e.name||!e.version){console.error("[Furnarchy] Service registration failed: Missing 'name' or 'version'",e);return}this.services.has(e.name)&&console.warn(`[Furnarchy] Service '${e.name}' is already registered. Overwriting.`),this.services.set(e.name,{service:e,providerId:r}),console.log(`[Furnarchy] Service registered: ${e.name} v${e.version} by ${r}`)}getService(e){const r=this.services.get(e);return r?r.service:null}onRegister(e){this.listeners.push(e)}notifyUpdate(e){this.listeners.forEach(r=>{try{r(e)}catch(s){console.error(s)}})}register(e,r){if(!e.id||!e.version){console.error("[Furnarchy] Plugin registration failed: Missing 'id' or 'version' in metadata",e);return}if(this.plugins.some(a=>a.metadata.id===e.id)){console.warn(`[Furnarchy] Plugin with id '${e.id}' already registered. Skipping.`);return}const s=new q(this);s.metadata={...s.metadata,...e},e.toggle&&s._setEnabled(!1),this.plugins.push(s);try{r(s),console.log(`[Furnarchy] Registered plugin: ${s.metadata.name} (${s.metadata.id})`)}catch(a){console.error("[Furnarchy] Error initializing plugin:",a)}this.notifyUpdate(s),s._notifyLoad(),this.isReady&&s._notifyReady()}_getSortedHandlers(e){if(e==="incoming"&&this._cachedIncoming)return this._cachedIncoming;if(e==="outgoing"&&this._cachedOutgoing)return this._cachedOutgoing;const r=[];for(const s of this.plugins){if(!s.enabled)continue;const a=e==="incoming"?s._handlers.incoming:s._handlers.outgoing;for(const i of a)r.push({...i,plugin:s})}return r.sort((s,a)=>a.priority-s.priority),e==="incoming"?this._cachedIncoming=r:this._cachedOutgoing=r,r}async _processMessage(e,r,s,a){let i=r;const u=this._getSortedHandlers(e);for(const{cb:g,plugin:h}of u)try{const c=await g(i,s,a);if(c==null)return null;i=c}catch(c){const f=e.charAt(0).toUpperCase()+e.slice(1);console.error(`[${h.metadata.name}] ${f} Error:`,c)}return i}async processIncoming(e,r=null,s=null){if(!this._motdComplete)return e.includes("Dragonroar")&&(this._motdComplete=!0),e;const a=w(e);return a.type==="set-user-info"&&this.notifyLoggedIn(a.name,a.uid.toString()),this._processMessage("incoming",e,r,s)}async processOutgoing(e,r=null,s=null){return this._processMessage("outgoing",e,r,s)}notifyLoggedIn(e,r){this.isLoggedIn=!0,this.characterName=e,this.characterUid=r,console.log(`[Furnarchy] User logged in as ${e} (${r}), notifying plugins...`),this.plugins.forEach(s=>s._notifyLoggedIn(e,r))}notifyConnected(){console.log("[Furnarchy] Connected to server, notifying plugins..."),this._motdComplete=!1,this.plugins.forEach(e=>e._notifyConnected())}notifyDisconnected(){this.isLoggedIn=!1,console.log("[Furnarchy] Disconnected from server, notifying plugins..."),this.plugins.forEach(e=>e._notifyDisconnected())}getExposedAPI(){return{register:this.register.bind(this),version:this.version,utils:this.utils}}}const J=new B;export{B as F,Y as a,T as c,J as f,X as h,b as m,z as t};
