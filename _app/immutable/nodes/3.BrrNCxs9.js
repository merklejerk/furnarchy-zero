import{f as x,a as S}from"../chunks/BTCE0DZM.js";import{i as _e}from"../chunks/v9LOXSqa.js";import{o as ye}from"../chunks/Db6ANrXm.js";import{L as we,W as We,X as Te,O as Pe,P as p,y as W,w as N,R as f,x as e,Q as b,M as ke,D as P,N as H,Y as Be,V as Ie,$ as De}from"../chunks/Cg5NIOCX.js";import{e as T,s as O}from"../chunks/oVO9CO60.js";import{i as D,s as He,a as Oe}from"../chunks/BJP9K3nK.js";import{h as Xe}from"../chunks/B_JrXAzN.js";import{p as ge,F as je,g as Ne,h as Z,l as Qe,r as Ye,e as Ve,s as me,d as se,f as pe,k as Ge,i as Ze,b as Je,m as ze,v as Ke,c as oe,a as et}from"../chunks/B7V_Lk9l.js";function tt(c,_){let n=_;n.endsWith("/")||(n+="/");const u=c.startsWith("/")?c.substring(1):c;return new URL(u,n).toString()}function nt(c,_){const n=new URL(c),u=new URL(_),E=n.pathname.startsWith("/")?n.pathname.substring(1):n.pathname;let q=u.pathname;return q.endsWith("/")||(q+="/"),u.pathname=q+E,u.search=n.search,u.hash=n.hash,u.toString()}function at(c){return!c.match(/^https?:\/\//)&&!c.startsWith("data:")&&!c.startsWith("blob:")}function st(c){return c.startsWith("http://local-server.furcadia.com:8080/")||c.startsWith("https://terra.furcadia.com/")}function ot(c,_){window.FurcXMLHttpRequest=class extends XMLHttpRequest{open(u,E,...q){let a=E.toString();return at(a)?(a=tt(a,c),console.log(`[FurcXMLHttpRequest] Remapped relative URL to: ${a}`)):st(a)&&(a=nt(a,_),console.log(`[FurcXMLHttpRequest] Remapped backend URL to: ${a}`)),super.open(u,a,...q)}}}class be{buffer="";append(_){this.buffer+=_;const n=[];let u;for(;(u=this.buffer.indexOf(`
`))!==-1;){const E=this.buffer.substring(0,u);n.push(E),this.buffer=this.buffer.substring(u+1)}return n}get isEmpty(){return this.buffer.length===0}clear(){this.buffer=""}}function rt(){const c={encode:a=>{const t=a.length,l=new Uint8Array(t);for(let o=0;o<t;o++)l[o]=a.charCodeAt(o)&255;return l}},_={decode:a=>{if(typeof a=="string")return a;let t;a instanceof Uint8Array?t=a:a instanceof ArrayBuffer?t=new Uint8Array(a):t=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);let l="";const o=t.length,d=32768;for(let v=0;v<o;v+=d){const L=t.subarray(v,Math.min(v+d,o));l+=String.fromCharCode.apply(null,L)}return l}};let n=null,u;window.waitForFurc=new Promise(a=>{u=a});function E(a,t,l){if(!t.endsWith(`
`))throw new Error("Furnarchy.inject() requires a complete command (must end with \\n)");const o=c.encode(t),d=new MessageEvent("message",{data:o,origin:"wss://lightbringer.furcadia.com"});d.tag=l,a.dispatchEvent(d)}function q(a,t,l){if(a.readyState===WebSocket.OPEN){if(!t.endsWith(`
`))throw new Error("Furnarchy.send() requires a complete command (must end with \\n)");const o=c.encode(t);a.sendTagged?a.sendTagged(o,l):a.send(o)}}window.FurcWebSocket=class extends WebSocket{_outgoingQueue=Promise.resolve();_incomingQueue=Promise.resolve();_incomingBuffer=new be;_outgoingBuffer=new be;constructor(t,l){if(super(t,l),t.toString().includes("furcadia")||t.toString().includes("6502")){console.log("%cüòà Game Socket Captured","color: #ff00ff;"),n=this;const o=window.Furnarchy;o&&(o.send=(d,v)=>q(this,d,v),o.inject=(d,v)=>E(this,d,v),console.log("[Furnarchy] Connected to Game Socket")),this.addEventListener("open",()=>u(this))}}send(t){this.sendTagged(t,void 0)}sendTagged(t,l){if(n!==this){super.send(t);return}this._outgoingQueue=this._outgoingQueue.then(async()=>{let o=typeof t=="string"?t:_.decode(t);const d=this._outgoingBuffer.append(o);if(d.length===0)return;const v=[];for(let A of d){const m=window.Furnarchy;if(m){const h=await m.processOutgoing(A,l);if(h==null){console.log("%cüö´ Outgoing Dropped (Furnarchy)","color: gray; font-size: 9px");continue}A=h}v.push(A)}if(v.length===0)return;const L=v.join(`
`)+`
`,B=c.encode(L);super.send(B)}).catch(o=>{console.error("Error in outgoing message queue:",o)})}_hookMessageEvent(t,l){const o=t.tag;this._incomingQueue=this._incomingQueue.then(async()=>{let d=typeof t.data=="string"?t.data:_.decode(t.data);const v=this._incomingBuffer.append(d);if(v.length===0)return;const L=[];for(let h of v){const $=window.Furnarchy;if($&&h==="&&&&&&&&&&&&&"&&(console.log("%cüü¢ Login Detected - Notifying Plugins","color: green;"),$.notifyLoggedIn()),$){const X=await $.processIncoming(h,o);if(X==null)continue;h=X}L.push(h)}if(L.length===0)return;const B=L.join(`
`)+`
`;let A=B;this.binaryType==="arraybuffer"?A=c.encode(B).buffer:this.binaryType==="blob"&&(A=new Blob([c.encode(B)]));const m=new MessageEvent("message",{data:A,origin:t.origin,source:t.source});l(m)}).catch(d=>{console.error("Error in incoming message queue:",d)})}set onmessage(t){n===this&&t?super.onmessage=l=>{this._hookMessageEvent(l,o=>{t.call(this,o)})}:super.onmessage=t}get onmessage(){return super.onmessage}addEventListener(t,l,o){if(t==="message"&&n===this&&typeof l=="function"){const d=v=>{this._hookMessageEvent(v,L=>{l.call(this,L)})};super.addEventListener(t,d,o);return}super.addEventListener(t,l,o)}}}async function it(c){const _=await fetch(c);if(!_.ok)throw new Error(`Failed to fetch client script: ${_.statusText}`);let n=await _.text();n=n.replaceAll("XMLHttpRequest","FurcXMLHttpRequest"),n=n.replaceAll("WebSocket","FurcWebSocket");const u=document.createElement("script");u.textContent=n,u.async=!0,document.body.appendChild(u)}var lt=x('<div class="detail-row svelte-a1qo0m"><span class="label svelte-a1qo0m">ID:</span> </div>'),ct=x('<div class="detail-row svelte-a1qo0m"><span class="label svelte-a1qo0m">Version:</span> </div>'),dt=x('<div class="detail-row svelte-a1qo0m"><span class="label svelte-a1qo0m">Author:</span> </div>'),ut=x('<div class="detail-row svelte-a1qo0m"><span class="label svelte-a1qo0m">Description:</span> </div>'),ft=x('<div class="plugin-details svelte-a1qo0m"><!> <!> <!> <!> <div class="detail-row svelte-a1qo0m"><span class="label svelte-a1qo0m">URL:</span> <a target="_blank" rel="noopener noreferrer" class="url-link svelte-a1qo0m"> </a></div> <button class="remove-btn svelte-a1qo0m">Remove Plugin</button></div>'),vt=x('<li><div class="plugin-header svelte-a1qo0m"><div class="plugin-title-group svelte-a1qo0m"><div></div> <span class="plugin-name svelte-a1qo0m"> </span></div></div> <!></li>'),ht=x('<li class="empty svelte-a1qo0m">No plugins installed</li>'),gt=x('<div class="modal-backdrop svelte-a1qo0m"></div> <div class="modal retro-theme svelte-a1qo0m"><div class="header-row svelte-a1qo0m"><h2 class="svelte-a1qo0m">Plugin Manager</h2> <button class="close-btn svelte-a1qo0m" aria-label="Close">‚úï</button></div> <div class="add-plugin svelte-a1qo0m"><input type="text" placeholder="https://example.com/my-plugin.js" class="svelte-a1qo0m"/> <button class="svelte-a1qo0m"> </button></div> <ul class="plugin-list svelte-a1qo0m"><!> <!></ul> <div class="footer svelte-a1qo0m"><small>Plugins have full access to your game session.</small> <br/> <small></small></div></div>',1),mt=x('<div class="plugin-manager svelte-a1qo0m"><button class="fab svelte-a1qo0m" title="Plugin Manager">‚öôÔ∏è</button> <!></div>');function pt(c,_){we(_,!1);const n=()=>Oe(ge,"$pluginStore",u),[u,E]=He(),q=N();let a=N(!1),t=N(""),l=N(null),o=N(!1);ye(()=>{window.Furnarchy||(window.Furnarchy=new je),ge.set(Ne()),window.Furnarchy.onRegister(g=>{const i=g.metadata||g,y=i.sourceUrl||g.sourceUrl;if(y){const C=n().findIndex(M=>M.url===y);if(C!==-1){const M=i.toggle?!1:n()[C].enabled!==!1;typeof g._setEnabled=="function"?g._setEnabled(M):g.enabled=M;let U=!1;const F=n()[C],R={...F};if(i.toggle&&F.enabled!==!1&&(R.enabled=!1,U=!0),F.name!==i.name&&(R.name=i.name,U=!0),F.id!==i.id&&(R.id=i.id,U=!0),F.description!==i.description&&(R.description=i.description,U=!0),F.version!==i.version&&(R.version=i.version,U=!0),F.author!==i.author&&(R.author=i.author,U=!0),U){const Y=[...n()];Y[C]=R,Z(Y)}}}});const r=window.Furnarchy?.version||"0.0.0";Qe(r).then(()=>{A()})});function d(){W(a,!e(a))}async function v(){if(e(t)&&!n().some(r=>r.url===e(t))){W(o,!0);try{const r=await Ke(e(t)),g=[...n(),{id:r.id,url:e(t),name:r.name,description:r.description,version:r.version,author:r.author,enabled:r.toggle!==void 0?!r.toggle:!0}];Z(g),m(e(t)),W(t,"")}catch(r){alert(`Failed to verify plugin: ${r.message||r}`)}finally{W(o,!1)}}}function L(r){const g=n().find(y=>y.url===r);g&&g.id&&ze(g.id);const i=n().filter(y=>y.url!==r);Z(i),confirm("Plugin removed. Reload page to take effect?")&&window.location.reload()}function B(r){const g=n().map(i=>{if(i.url===r){const y=i.enabled===void 0?!1:!i.enabled,C=window.Furnarchy;if(C&&C.plugins){const M=C.plugins.find(U=>U.metadata.sourceUrl===r);M&&(typeof M._setEnabled=="function"?M._setEnabled(y):M.enabled=y)}return{...i,enabled:y}}return i});Z(g)}function A(){n().forEach(r=>m(r.url))}async function m(r){if(!document.querySelector(`script[data-plugin-url="${r}"]`))try{const g=await fetch(r);if(!g.ok)throw new Error(`HTTP ${g.status}`);const i=await g.text();window.Furnarchy.loadingPluginUrl=r;const y=document.createElement("script");y.textContent=i,y.dataset.pluginUrl=r,document.body.appendChild(y),console.log(`[PluginManager] Loaded via fetch: ${r}`)}catch(g){console.warn(`[PluginManager] Fetch failed for ${r}, falling back to script tag.`,g);const i=document.createElement("script");i.src=r,i.async=!0,i.dataset.pluginUrl=r,i.onload=()=>console.log(`[PluginManager] Loaded via tag: ${r}`),i.onerror=()=>console.error(`[PluginManager] Failed to load: ${r}`),document.body.appendChild(i)}finally{window.Furnarchy.loadingPluginUrl=null}}We(()=>n(),()=>{W(q,n())}),Te(),_e();var h=mt(),$=p(h),X=f($,2);{var J=r=>{var g=gt(),i=ke(g),y=f(i,2),C=p(y),M=f(p(C),2);b(C);var U=f(C,2),F=p(U);Ye(F);var R=f(F,2),Y=p(R,!0);b(R),b(U);var z=f(U,2),re=p(z);Ve(re,1,n,Ze,(I,s)=>{var Q=vt();let le;var K=p(Q),ce=p(K),V=p(ce);let de;var ee=f(V,2),Fe=p(ee,!0);b(ee),b(ce),b(K);var Se=f(K,2);{var xe=te=>{var G=ft(),ue=p(G);{var Ce=w=>{var k=lt(),j=f(p(k));b(k),H(()=>O(j,` ${e(s),P(()=>e(s).id)??""}`)),S(w,k)};D(ue,w=>{e(s),P(()=>e(s).id)&&w(Ce)})}var fe=f(ue,2);{var Re=w=>{var k=ct(),j=f(p(k));b(k),H(()=>O(j,` ${e(s),P(()=>e(s).version)??""}`)),S(w,k)};D(fe,w=>{e(s),P(()=>e(s).version)&&w(Re)})}var ve=f(fe,2);{var Ee=w=>{var k=dt(),j=f(p(k));b(k),H(()=>O(j,` ${e(s),P(()=>e(s).author)??""}`)),S(w,k)};D(ve,w=>{e(s),P(()=>e(s).author)&&w(Ee)})}var he=f(ve,2);{var Ae=w=>{var k=ut(),j=f(p(k));b(k),H(()=>O(j,` ${e(s),P(()=>e(s).description)??""}`)),S(w,k)};D(he,w=>{e(s),P(()=>e(s).description)&&w(Ae)})}var ne=f(he,2),ae=f(p(ne),2),$e=p(ae,!0);b(ae),b(ne);var Me=f(ne,2);b(G),H(()=>{se(ae,"href",(e(s),P(()=>e(s).url))),O($e,(e(s),P(()=>e(s).url)))}),T("click",Me,()=>L(e(s).url)),T("click",G,pe(function(w){Ge.call(this,_,w)})),S(te,G)};D(Se,te=>{e(l),e(s),P(()=>e(l)===e(s).url)&&te(xe)})}b(Q),H(()=>{le=me(Q,1,"plugin-item svelte-a1qo0m",null,le,{expanded:e(l)===e(s).url,disabled:e(s).enabled===!1}),de=me(V,1,"toggle-switch svelte-a1qo0m",null,de,{checked:e(s).enabled!==!1}),se(V,"title",(e(s),P(()=>e(s).enabled!==!1?"Disable Plugin":"Enable Plugin"))),se(ee,"title",(e(s),P(()=>e(s).url))),O(Fe,(e(s),P(()=>e(s).name||e(s).url)))}),T("click",V,pe(()=>B(e(s).url))),T("click",Q,()=>W(l,e(l)===e(s).url?null:e(s).url)),S(I,Q)});var qe=f(re,2);{var Le=I=>{var s=ht();S(I,s)};D(qe,I=>{n(),P(()=>n().length===0)&&I(Le)})}b(z);var ie=f(z,2),Ue=f(p(ie),4);Ue.textContent=`Furnarchy Zero v${P(()=>window.Furnarchy?.version||"...")??""}`,b(ie),b(y),H(()=>{F.disabled=e(o),R.disabled=e(o),O(Y,e(o)?"...":"Add")}),T("click",i,d),T("click",M,d),Je(F,()=>e(t),I=>W(t,I)),T("keydown",F,I=>I.key==="Enter"&&!e(o)&&v()),T("click",R,v),S(r,g)};D(X,r=>{e(a)&&r(J)})}b(h),T("click",$,d),S(c,h),Pe(),E()}var bt=x('<link rel="stylesheet" type="text/css" href="https://play.furcadia.com/web/furcadia.css?v=a1599e9c4ed5bc2f3aa66c66e96df767"/> <style id="variableCSS"></style> <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width" id="viewportTag"/> <meta name="theme-color" content="#392b67"/>',1),_t=x('<div class="loading svelte-hy9bcf"><p>Loading Furcadia Web Client...</p></div>'),yt=x('<div class="error svelte-hy9bcf"><p> </p> <button class="svelte-hy9bcf">Try Again</button></div>'),wt=x('<!> <!> <div id="furcContainer"></div> <div id="firstLoadScene"></div> <div id="modalOverlay"></div> <div id="dialogBox"><div id="dialogText">Would you like to transfer this Ferian Hotdoggen to Dr. Cat?</div> <div id="dialogControls"><button id="dialogButton1" class="svelte-hy9bcf">Yes</button> <button id="dialogButton2" class="svelte-hy9bcf">No</button> <button id="dialogButton3" class="svelte-hy9bcf">Cancel</button></div></div> <div id="pounce" style="display: none"></div> <!>',1);function Et(c,_){we(_,!1);const n=oe.PUBLIC_FURCADIA_CLIENT_JS_URL,u=oe.PUBLIC_AUTH_PROXY_URL,E=oe.PUBLIC_PLAY_FURCADIA_URL;let q=N(!1),a=N(""),t=!1;ye(()=>{const h=et()||u;console.log(`[Furnarchy] Using backend URL: ${h}`),ot(E,h),rt(),l()});async function l(){if(!t){W(q,!0),W(a,"");try{await it(n),t=!0}catch(m){console.error(m),W(a,m.message||"An unknown error occurred")}finally{W(q,!1)}}}_e();var o=wt();Xe("hy9bcf",m=>{var h=bt();Ie(6),Be(()=>{De.title="Furnarchy Zero"}),S(m,h)});var d=ke(o);pt(d,{});var v=f(d,2);{var L=m=>{var h=_t();S(m,h)};D(v,m=>{e(q)&&m(L)})}var B=f(v,12);{var A=m=>{var h=yt(),$=p(h),X=p($);b($);var J=f($,2);b(h),H(()=>O(X,`Error: ${e(a)??""}`)),T("click",J,()=>window.location.reload()),S(m,h)};D(B,m=>{e(a)&&m(A)})}S(c,o),Pe()}export{Et as component};
