import{f as F,e as A,a as x,s as H}from"../chunks/IX6aYug8.js";import{i as Se}from"../chunks/DeWH6QAX.js";import{o as xe}from"../chunks/Cvwj0Kbc.js";import{p as Fe,W as Ge,X as Ve,n as $e,o as y,an as Ze,h as e,Q as N,T as E,v as p,s as w,m as Re,u as L,t as X,e as Je,Y as Ke,$ as ze}from"../chunks/B2BHS6mp.js";import{i as O,s as et,a as tt}from"../chunks/CBIv6OHw.js";import{f as z,h as nt}from"../chunks/B4vQSIli.js";import{p as ke,g as ot,h as K,l as st,r as rt,e as at,s as Ce,d as ae,f as ie,k as it,i as lt,b as ct,m as dt,v as ut,c as le,a as ft}from"../chunks/oBoqBDxE.js";import"../chunks/8UtF8RsF.js";function vt(l,m){let n=m;n.endsWith("/")||(n+="/");const v=l.startsWith("/")?l.substring(1):l;return new URL(v,n).toString()}function gt(l,m){const n=new URL(l),v=new URL(m),_=n.pathname.startsWith("/")?n.pathname.substring(1):n.pathname;let P=v.pathname;return P.endsWith("/")||(P+="/"),v.pathname=P+_,v.search=n.search,v.hash=n.hash,v.toString()}function ht(l){return!l.match(/^https?:\/\//)&&!l.startsWith("data:")&&!l.startsWith("blob:")}function mt(l){return l.startsWith("http://local-server.furcadia.com:8080/")||l.startsWith("https://terra.furcadia.com/")}function pt(l,m){window.FurcXMLHttpRequest=class extends XMLHttpRequest{open(v,_,...P){let s=_.toString();return ht(s)?(s=vt(s,l),console.log(`[FurcXMLHttpRequest] Remapped relative URL to: ${s}`)):mt(s)&&(s=gt(s,m),console.log(`[FurcXMLHttpRequest] Remapped backend URL to: ${s}`)),super.open(v,s,...P)}}}class Le{buffer="";append(m){this.buffer+=m;const n=[];let v;for(;(v=this.buffer.indexOf(`
`))!==-1;){const _=this.buffer.substring(0,v);n.push(_),this.buffer=this.buffer.substring(v+1)}return n}get isEmpty(){return this.buffer.length===0}clear(){this.buffer=""}}function bt(){const l={encode:s=>{const t=s.length,u=new Uint8Array(t);for(let i=0;i<t;i++)u[i]=s.charCodeAt(i)&255;return u}},m={decode:s=>{if(typeof s=="string")return s;let t;s instanceof Uint8Array?t=s:s instanceof ArrayBuffer?t=new Uint8Array(s):t=new Uint8Array(s.buffer,s.byteOffset,s.byteLength);let u="";const i=t.length,c=32768;for(let o=0;o<i;o+=c){const g=t.subarray(o,Math.min(o+c,i));u+=String.fromCharCode.apply(null,g)}return u}};let n=null,v;window.waitForFurc=new Promise(s=>{v=s});function _(s,t,u,i){if(!t.endsWith(`
`))throw new Error("Furnarchy.inject() requires a complete command (must end with \\n)");const c=l.encode(t),o=new MessageEvent("message",{data:c,origin:"wss://lightbringer.furcadia.com"});o.tag=i,o.sourceId=u,s.dispatchEvent(o)}function P(s,t,u,i){if(s.readyState===WebSocket.OPEN){if(!t.endsWith(`
`))throw new Error("Furnarchy.send() requires a complete command (must end with \\n)");const c=l.encode(t);s.sendTagged?s.sendTagged(c,u,i):s.send(c)}}window.FurcWebSocket=class extends WebSocket{_outgoingQueue=Promise.resolve();_incomingQueue=Promise.resolve();_incomingBuffer=new Le;_outgoingBuffer=new Le;_motdComplete=!1;constructor(t,u){if(super(t,u),t.toString().includes("furcadia")||t.toString().includes("6502")){console.log("%cüòà Game Socket Captured","color: #ff00ff;"),n=this;const i=z;i&&(i.send=(c,o,g)=>P(this,c,o,g),i.inject=(c,o,g)=>_(this,c,o,g),console.log("[Furnarchy] Connected to Game Socket")),this.addEventListener("open",()=>v(this))}}send(t){this.sendTagged(t,void 0,void 0)}sendTagged(t,u,i){if(n!==this){super.send(t);return}this._outgoingQueue=this._outgoingQueue.then(async()=>{let c=typeof t=="string"?t:m.decode(t);const o=this._outgoingBuffer.append(c);if(o.length===0)return;const g=[];for(let b of o){const k=z;if(k){const q=await k.processOutgoing(b,u,i);if(q==null){console.log("%cüö´ Outgoing Dropped (Furnarchy)","color: gray; font-size: 9px");continue}b=q}g.push(b)}if(g.length===0)return;const M=g.join(`
`)+`
`,W=l.encode(M);super.send(W)}).catch(c=>{console.error("Error in outgoing message queue:",c)})}_hookMessageEvent(t,u){const i=t.tag,c=t.sourceId;this._incomingQueue=this._incomingQueue.then(async()=>{let o=typeof t.data=="string"?t.data:m.decode(t.data);const g=this._incomingBuffer.append(o);if(g.length===0)return;const M=[];for(let q of g){if(!this._motdComplete){q==="Dragonroar"&&(this._motdComplete=!0),M.push(q);continue}const D=z;if(D&&q==="&&&&&&&&&&&&&"&&(console.log("%cüü¢ Login Detected - Notifying Plugins","color: green;"),D.notifyLoggedIn()),D){const T=await D.processIncoming(q,c,i);if(T==null)continue;q=T}M.push(q)}if(M.length===0)return;const W=M.join(`
`)+`
`;let b=W;this.binaryType==="arraybuffer"?b=l.encode(W).buffer:this.binaryType==="blob"&&(b=new Blob([l.encode(W)]));const k=new MessageEvent("message",{data:b,origin:t.origin,source:t.source});u(k)}).catch(o=>{console.error("Error in incoming message queue:",o)})}set onmessage(t){n===this&&t?super.onmessage=u=>{this._hookMessageEvent(u,i=>{t.call(this,i)})}:super.onmessage=t}get onmessage(){return super.onmessage}addEventListener(t,u,i){if(t==="message"&&n===this&&typeof u=="function"){const c=o=>{this._hookMessageEvent(o,g=>{u.call(this,g)})};super.addEventListener(t,c,i);return}super.addEventListener(t,u,i)}}}async function _t(l){const m=await fetch(l);if(!m.ok)throw new Error(`Failed to fetch client script: ${m.statusText}`);let n=await m.text();n=n.replaceAll("XMLHttpRequest","FurcXMLHttpRequest"),n=n.replaceAll("WebSocket","FurcWebSocket");const v=n.length;n=(()=>{let P=n.indexOf("Missing login data");if(P===-1)return n;const s=n.substring(0,P),t="__instantiate",u=`
            let ${t} = (cls, ...args) => {
                // Instantate the class.
                const r = $2(cls, ...args);
                // Wait a tick then find the instance in the result object.
                setTimeout(() => {
                    for (const key in r) {
                        if (r[key] instanceof cls) {
                            console.log('[Furc Loader] Captured game instance.');
                            window.processGameClientInstance(r[key]);
                            return;
                        }
                    }
                    console.log('[Furc Loader] Warning: Could not find game instance in instantiated object.');
                }, 0);
                return r;
            }
        `,i=n.substring(P).replace(/;\s*(\w+)\s*=\s*(\w+)\s*\(\s*(\w+)\s*,/,`;${u}; $1 = ${t}($3,`);return s+i})(),v===n.length?console.warn("[Furc Loader] Warning: Could not find game instance assignment point to hook into."):window.processGameClientInstance=P=>{console.log("[Furc Loader] Processing game client instance...");const s=ce(P),t=(()=>{for(const[i,c]of s)if(Ue(c).search(/this(\.\w+){3}\("Reconnecting..."\)/)!==-1)return c.bind(P)})(),u=(()=>{const i=(()=>{for(const[o,g]of s)if(qe(g).includes('"Se√±or Furreton"'))return g})();if(!i)return;const c=(()=>{for(const[o,g]of ce(i))if(qe(g).includes('"chatBuffer"'))return g})();if(c){for(const[o,g]of ce(c))if(Ue(g).includes('"specitag"'))return g.bind(c)}})();t&&u&&(window.__CLIENT_HOOKS={reconnect:t,appendChat:u})};const _=document.createElement("script");_.textContent=n,_.async=!0,document.body.appendChild(_)}function ce(l){const m=new Set,n=v=>{!v||!(v instanceof Object)||(Object.getOwnPropertyNames(v).filter(_=>_!=="constructor"&&v[_]).forEach(_=>m.add([_,v[_]])),n(Object.getPrototypeOf(v)))};return n(l),[...m].sort()}function yt(l){return l&&l instanceof Object?Object.getPrototypeOf(l).constructor:null}function qe(l,m=""){const n=yt(l);return n?n.toString():m}function Ue(l,m=""){return typeof l=="function"?l.toString():m}var wt=F('<div class="config-btn svelte-a1qo0m" title="Configure Plugin">‚öôÔ∏è</div>'),Pt=F('<div class="detail-row svelte-a1qo0m"><span class="label svelte-a1qo0m">ID:</span> </div>'),kt=F('<div class="detail-row svelte-a1qo0m"><span class="label svelte-a1qo0m">Version:</span> </div>'),Ct=F('<div class="detail-row svelte-a1qo0m"><span class="label svelte-a1qo0m">Author:</span> </div>'),Lt=F('<div class="detail-row svelte-a1qo0m"><span class="label svelte-a1qo0m">Description:</span> </div>'),qt=F('<div class="plugin-details svelte-a1qo0m"><!> <!> <!> <!> <div class="detail-row svelte-a1qo0m"><span class="label svelte-a1qo0m">URL:</span> <a target="_blank" rel="noopener noreferrer" class="url-link svelte-a1qo0m"> </a></div> <div class="button-group svelte-a1qo0m"><button class="action-btn reload-btn svelte-a1qo0m">Reload Plugin</button> <button class="action-btn remove-btn svelte-a1qo0m">Remove Plugin</button></div></div>'),Ut=F('<li><div class="plugin-header svelte-a1qo0m"><div class="plugin-title-group svelte-a1qo0m"><div></div> <!> <span class="plugin-name svelte-a1qo0m"> </span></div></div> <!></li>'),St=F('<li class="empty svelte-a1qo0m">No plugins installed</li>'),xt=F('<div class="modal-backdrop svelte-a1qo0m"></div> <div class="modal retro-theme svelte-a1qo0m"><div class="header-row svelte-a1qo0m"><h2 class="svelte-a1qo0m">Plugin Manager</h2> <button class="close-btn svelte-a1qo0m" aria-label="Close">‚úï</button></div> <div class="add-plugin svelte-a1qo0m"><input type="text" placeholder="https://example.com/my-plugin.js" class="svelte-a1qo0m"/> <button class="svelte-a1qo0m"> </button></div> <ul class="plugin-list svelte-a1qo0m"><!> <!></ul> <div class="footer svelte-a1qo0m"><small>Plugins have full access to your game session.</small> <br/> <small></small></div></div>',1),Ft=F('<div class="plugin-manager svelte-a1qo0m"><button class="fab svelte-a1qo0m" title="Plugin Manager">‚öôÔ∏è</button> <!></div>');function $t(l,m){Fe(m,!1);const n=()=>tt(ke,"$pluginStore",v),[v,_]=et(),P=N();let s=N(!1),t=N(""),u=N(null),i=N(!1),c=N({}),o=z;xe(()=>{window.Furnarchy=o.getExposedAPI(),ke.set(ot()),o.plugins&&o.plugins.forEach(f=>{f.metadata.sourceUrl&&Ze(c,e(c)[f.metadata.sourceUrl]=f._handlers.configure.length>0)}),o.onRegister(f=>{const d=f.metadata||f,h=d.sourceUrl||f.sourceUrl;if(h){E(c,{...e(c),[h]:f._handlers.configure.length>0});const I=n().findIndex(j=>j.url===h);if(I!==-1){const j=o.loadingPluginUrl===h,$=n()[I];let S=!1;const R={...$};if(j){const V=d.toggle?!1:$.enabled!==!1;f._setEnabled(V),d.toggle&&$.enabled!==!1&&(R.enabled=!1,S=!0)}else f.enabled!==($.enabled!==!1)&&(R.enabled=f.enabled,S=!0);if($.name!==d.name&&(R.name=d.name,S=!0),$.id!==d.id&&(R.id=d.id,S=!0),$.description!==d.description&&(R.description=d.description,S=!0),$.version!==d.version&&(R.version=d.version,S=!0),$.author!==d.author&&(R.author=d.author,S=!0),S){const V=[...n()];V[I]=R,K(V)}}}});const r=o.version||"0.0.0";st(r).then(()=>{D()})});function g(){E(s,!e(s))}async function M(){if(e(t)&&!n().some(r=>r.url===e(t))){E(i,!0);try{const r=await ut(e(t)),f=[...n(),{id:r.id,url:e(t),name:r.name,description:r.description,version:r.version,author:r.author,enabled:r.toggle!==void 0?!r.toggle:!0}];K(f),T(e(t)),E(t,"")}catch(r){alert(`Failed to verify plugin: ${r.message||r}`)}finally{E(i,!1)}}}function W(r){const f=n().find(h=>h.url===r);f&&f.id&&dt(f.id);const d=n().filter(h=>h.url!==r);K(d),confirm("Plugin removed. Reload page to take effect?")&&window.location.reload()}function b(r){const f=n().map(d=>{if(d.url===r){const h=d.enabled===void 0?!1:!d.enabled;if(o&&o.plugins){const I=o.plugins.find(j=>j.metadata.sourceUrl===r);I&&I._setEnabled(h)}return{...d,enabled:h}}return d});K(f)}function k(r){if(E(s,!1),o&&o.plugins){const f=o.plugins.find(d=>d.metadata.sourceUrl===r);f&&f._notifyConfigure()}}async function q(r){const f=document.querySelector(`script[data-plugin-url="${r}"]`);if(f&&f.remove(),o&&o.plugins){const d=o.plugins.findIndex(h=>h.metadata.sourceUrl===r);d!==-1&&(o.plugins[d]._setEnabled(!1),o.plugins.splice(d,1))}await T(r)}async function D(){await Promise.all(n().map(r=>T(r.url))),o.start()}async function T(r){if(!document.querySelector(`script[data-plugin-url="${r}"]`))try{const f=await fetch(r);if(!f.ok)throw new Error(`HTTP ${f.status}`);const d=await f.text();o.loadingPluginUrl=r;const h=document.createElement("script");h.textContent=d,h.dataset.pluginUrl=r,document.body.appendChild(h),console.log(`[PluginManager] Loaded via fetch: ${r}`)}catch(f){return console.warn(`[PluginManager] Fetch failed for ${r}, falling back to script tag.`,f),new Promise(d=>{const h=document.createElement("script");h.src=r,h.async=!0,h.dataset.pluginUrl=r,h.onload=()=>{console.log(`[PluginManager] Loaded via tag: ${r}`),d()},h.onerror=()=>{console.error(`[PluginManager] Failed to load: ${r}`),d()},document.body.appendChild(h)})}finally{o.loadingPluginUrl=null}}Ge(()=>n(),()=>{E(P,n())}),Ve(),Se();var ee=Ft(),de=y(ee),Ee=p(de,2);{var Ae=r=>{var f=xt(),d=Re(f),h=p(d,2),I=y(h),j=p(y(I),2);w(I);var $=p(I,2),S=y($);rt(S);var R=p(S,2),V=y(R,!0);w(R),w($);var te=p($,2),ue=y(te);at(ue,1,n,lt,(B,a)=>{var Z=Ut();let ve;var ne=y(Z),ge=y(ne),J=y(ge);let he;var me=p(J,2);{var We=Q=>{var Y=wt();A("click",Y,ie(()=>k(e(a).url))),x(Q,Y)};O(me,Q=>{e(c),e(a),L(()=>e(c)[e(a).url])&&Q(We)})}var oe=p(me,2),Te=y(oe,!0);w(oe),w(ge),w(ne);var Be=p(ne,2);{var De=Q=>{var Y=qt(),pe=y(Y);{var He=C=>{var U=Pt(),G=p(y(U));w(U),X(()=>H(G,` ${e(a),L(()=>e(a).id)??""}`)),x(C,U)};O(pe,C=>{e(a),L(()=>e(a).id)&&C(He)})}var be=p(pe,2);{var Xe=C=>{var U=kt(),G=p(y(U));w(U),X(()=>H(G,` ${e(a),L(()=>e(a).version)??""}`)),x(C,U)};O(be,C=>{e(a),L(()=>e(a).version)&&C(Xe)})}var _e=p(be,2);{var Ne=C=>{var U=Ct(),G=p(y(U));w(U),X(()=>H(G,` ${e(a),L(()=>e(a).author)??""}`)),x(C,U)};O(_e,C=>{e(a),L(()=>e(a).author)&&C(Ne)})}var ye=p(_e,2);{var je=C=>{var U=Lt(),G=p(y(U));w(U),X(()=>H(G,` ${e(a),L(()=>e(a).description)??""}`)),x(C,U)};O(ye,C=>{e(a),L(()=>e(a).description)&&C(je)})}var se=p(ye,2),re=p(y(se),2),Qe=y(re,!0);w(re),w(se);var we=p(se,2),Pe=y(we),Ye=p(Pe,2);w(we),w(Y),X(()=>{ae(re,"href",(e(a),L(()=>e(a).url))),H(Qe,(e(a),L(()=>e(a).url)))}),A("click",Pe,()=>q(e(a).url)),A("click",Ye,()=>W(e(a).url)),A("click",Y,ie(function(C){it.call(this,m,C)})),x(Q,Y)};O(Be,Q=>{e(u),e(a),L(()=>e(u)===e(a).url)&&Q(De)})}w(Z),X(()=>{ve=Ce(Z,1,"plugin-item svelte-a1qo0m",null,ve,{expanded:e(u)===e(a).url,disabled:e(a).enabled===!1}),he=Ce(J,1,"toggle-switch svelte-a1qo0m",null,he,{checked:e(a).enabled!==!1}),ae(J,"title",(e(a),L(()=>e(a).enabled!==!1?"Disable Plugin":"Enable Plugin"))),ae(oe,"title",(e(a),L(()=>e(a).url))),H(Te,(e(a),L(()=>e(a).name||e(a).url)))}),A("click",J,ie(()=>b(e(a).url))),A("click",Z,()=>E(u,e(u)===e(a).url?null:e(a).url)),x(B,Z)});var Me=p(ue,2);{var Ie=B=>{var a=St();x(B,a)};O(Me,B=>{n(),L(()=>n().length===0)&&B(Ie)})}w(te);var fe=p(te,2),Oe=p(y(fe),4);Oe.textContent=`Furnarchy Zero v${L(()=>window.Furnarchy?.version||"...")??""}`,w(fe),w(h),X(()=>{S.disabled=e(i),R.disabled=e(i),H(V,e(i)?"...":"Add")}),A("click",d,g),A("click",j,g),ct(S,()=>e(t),B=>E(t,B)),A("keydown",S,B=>B.key==="Enter"&&!e(i)&&M()),A("click",R,M),x(r,f)};O(Ee,r=>{e(s)&&r(Ae)})}w(ee),A("click",de,g),x(l,ee),$e(),_()}var Rt=F('<link rel="stylesheet" type="text/css" href="https://play.furcadia.com/web/furcadia.css?v=a1599e9c4ed5bc2f3aa66c66e96df767"/> <style id="variableCSS"></style> <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width" id="viewportTag"/> <meta name="theme-color" content="#392b67"/>',1),Et=F('<div class="loading svelte-hy9bcf"><p>Loading Furcadia Web Client...</p></div>'),At=F('<div class="error svelte-hy9bcf"><p> </p> <button class="svelte-hy9bcf">Try Again</button></div>'),Mt=F('<!> <!> <div id="furcContainer"></div> <div id="firstLoadScene"></div> <div id="modalOverlay"></div> <div id="dialogBox"><div id="dialogText">Would you like to transfer this Ferian Hotdoggen to Dr. Cat?</div> <div id="dialogControls"><button id="dialogButton1" class="svelte-hy9bcf">Yes</button> <button id="dialogButton2" class="svelte-hy9bcf">No</button> <button id="dialogButton3" class="svelte-hy9bcf">Cancel</button></div></div> <div id="pounce" style="display: none"></div> <!>',1);function Qt(l,m){Fe(m,!1);const n=le.PUBLIC_FURCADIA_CLIENT_JS_URL,v=le.PUBLIC_AUTH_PROXY_URL,_=le.PUBLIC_PLAY_FURCADIA_URL;let P=N(!1),s=N(""),t=!1;xe(()=>{const k=ft()||v;console.log(`[Furnarchy] Using backend URL: ${k}`),pt(_,k),bt(),u()});async function u(){if(!t){E(P,!0),E(s,"");try{await _t(n),t=!0}catch(b){console.error(b),E(s,b.message||"An unknown error occurred")}finally{E(P,!1)}}}Se();var i=Mt();nt("hy9bcf",b=>{var k=Rt();Ke(6),Je(()=>{ze.title="Furnarchy Zero"}),x(b,k)});var c=Re(i);$t(c,{});var o=p(c,2);{var g=b=>{var k=Et();x(b,k)};O(o,b=>{e(P)&&b(g)})}var M=p(o,12);{var W=b=>{var k=At(),q=y(k),D=y(q);w(q);var T=p(q,2);w(k),X(()=>H(D,`Error: ${e(s)??""}`)),A("click",T,()=>window.location.reload()),x(b,k)};O(M,b=>{e(s)&&b(W)})}x(l,i),$e()}export{Qt as component};
